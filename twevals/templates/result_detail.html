<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ result.function }} - twevals</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace']
            }
          }
        }
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark-dimmed.min.css">
    <script>
      (function() {
        const saved = localStorage.getItem('twevals:theme');
        if (saved === 'light') document.documentElement.classList.remove('dark');
      })();
    </script>
    <style>
      .data-card { min-height: 120px; }
      .data-card pre { height: 100%; max-height: none; }
      .data-viewer { min-height: auto; }
      .data-surface {
        padding: 0;
        background: transparent;
        border: none;
        border-radius: 0;
      }
      .data-pre {
        background: transparent !important;
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 0.9rem;
        line-height: 1.4;
      }
      .markdown-body {
        color: inherit;
      }
      .markdown-body h1, .markdown-body h2, .markdown-body h3,
      .markdown-body h4, .markdown-body h5, .markdown-body h6 {
        font-weight: 600;
        margin: 0.5rem 0 0.35rem;
        line-height: 1.3;
      }
      .markdown-body p { margin: 0 0 0.5rem; }
      .markdown-body ul, .markdown-body ol {
        margin: 0 0 0.5rem 1.1rem;
        padding: 0;
      }
      .markdown-body ul { list-style: disc; }
      .markdown-body ol { list-style: decimal; }
      .markdown-body li { margin: 0.2rem 0; }
      .markdown-body strong { font-weight: 600; }
      .data-viewer code.hljs { background: transparent !important; }
      .data-viewer .hljs-attr { color: #60a5fa; }
      .data-viewer .hljs-string { color: #34d399; }
      .data-viewer .hljs-number,
      .data-viewer .hljs-literal { color: #f472b6; }
      .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
      .collapsible-content.open { max-height: 2000px; }
      .collapse-icon { transition: transform 0.2s ease; }
      .collapse-icon.open { transform: rotate(180deg); }
    </style>
  </head>
  <body class="min-h-screen bg-blue-50/40 font-sans text-zinc-800 dark:bg-neutral-950 dark:text-zinc-100">
    {% set status = result.result.status or 'completed' %}
    {% set pill_tones = {
      'pending': 'text-blue-600 bg-blue-500/10 border border-blue-500/30 dark:text-blue-400',
      'running': 'text-cyan-600 bg-cyan-500/10 border border-cyan-500/30 dark:text-cyan-400',
      'completed': 'text-emerald-600 bg-emerald-500/10 border border-emerald-500/30 dark:text-emerald-400',
      'error': 'text-rose-600 bg-rose-500/10 border border-rose-500/30 dark:text-rose-400',
      'cancelled': 'text-amber-600 bg-amber-500/10 border border-amber-500/30 dark:text-amber-400'
    } %}
    {% set has_reference = result.result.reference and result.result.reference != '—' %}
    {% set has_metadata = result.result.metadata and result.result.metadata != '—' %}
    {% set has_run_data = result.result.run_data is defined and result.result.run_data is not none %}

    <div class="mx-auto w-full max-w-7xl px-4 py-6 md:px-8">
      <!-- Header -->
      <header class="mb-8 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <a href="/" class="flex h-9 w-9 items-center justify-center rounded-lg border border-zinc-200 bg-white text-zinc-500 shadow-sm transition hover:border-blue-300 hover:text-blue-600 dark:border-zinc-800 dark:bg-zinc-900 dark:hover:border-blue-500 dark:hover:text-blue-400" title="Back to table (Esc)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          </a>
          <div class="flex items-center gap-2 text-sm text-zinc-500">
            <a href="/" class="hover:text-blue-600 dark:hover:text-blue-400">twevals</a>
            <span class="text-zinc-300 dark:text-zinc-700">›</span>
            {% if run_name %}<span class="text-zinc-600 dark:text-zinc-400">{{ run_name }}</span><span class="text-zinc-300 dark:text-zinc-700">›</span>{% endif %}
            <span class="font-medium text-zinc-700 dark:text-zinc-300">Result {{ index + 1 }} of {{ total }}</span>
          </div>
        </div>
        <div class="flex items-center gap-1">
          {% if has_run_data and result.result.run_data.trace_url %}
          <a href="{{ result.result.run_data.trace_url }}" target="_blank" rel="noopener noreferrer" class="flex h-9 w-9 items-center justify-center rounded-lg border border-zinc-200 bg-white text-zinc-500 shadow-sm transition hover:border-blue-300 hover:text-blue-600 dark:border-zinc-800 dark:bg-zinc-900 dark:hover:border-blue-500 dark:hover:text-blue-400" title="View trace">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          </a>
          {% endif %}
          <button id="prev-btn" class="flex h-9 w-9 items-center justify-center rounded-lg border border-zinc-200 bg-white text-zinc-500 shadow-sm transition hover:border-blue-300 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:border-zinc-200 disabled:hover:text-zinc-500 dark:border-zinc-800 dark:bg-zinc-900 dark:hover:border-blue-500 dark:hover:text-blue-400" title="Previous (↑)" {% if index <= 0 %}disabled{% endif %}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
          </button>
          <button id="next-btn" class="flex h-9 w-9 items-center justify-center rounded-lg border border-zinc-200 bg-white text-zinc-500 shadow-sm transition hover:border-blue-300 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:border-zinc-200 disabled:hover:text-zinc-500 dark:border-zinc-800 dark:bg-zinc-900 dark:hover:border-blue-500 dark:hover:text-blue-400" title="Next (↓)" {% if index >= total - 1 %}disabled{% endif %}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
        </div>
      </header>

      <!-- Title Card -->
      <div class="mb-6 rounded-xl border border-zinc-200 bg-white p-5 shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <div class="mb-2 flex items-center gap-2">
              <h1 class="font-mono text-lg font-semibold text-zinc-900 dark:text-zinc-100">{{ result.function }}</h1>
              <button id="copy-cmd-btn" class="copy-btn flex h-8 w-8 items-center justify-center rounded-md border border-transparent text-zinc-400 transition hover:border-blue-200 hover:text-blue-600 dark:text-zinc-500 dark:hover:border-blue-500/50" title="Copy run command" aria-label="Copy run command">
                <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              </button>
              <span class="rounded-full px-2.5 py-0.5 text-xs font-medium {{ pill_tones.get(status, pill_tones.get('completed')) }}">{{ status }}</span>
            </div>
            <div class="flex flex-wrap items-center gap-4 text-sm text-zinc-500">
              <span><span class="text-zinc-400">Dataset:</span> {{ result.dataset or '—' }}</span>
              {% if result.labels %}
              <span class="flex items-center gap-1.5">
                <span class="text-zinc-400">Labels:</span>
                {% for la in result.labels %}<span class="rounded bg-zinc-100 px-1.5 py-0.5 text-xs text-zinc-600 dark:bg-zinc-800 dark:text-zinc-400">{{ la }}</span>{% endfor %}
              </span>
              {% endif %}
            </div>
          </div>
          <div class="flex items-center gap-4">
            {% if result.result.latency is not none %}
            <div class="text-right">
              <div class="text-xs text-zinc-400 uppercase tracking-wide">Latency</div>
              <div class="font-mono text-lg font-medium {% if result.result.latency <= 1 %}text-emerald-600 dark:text-emerald-400{% elif result.result.latency <= 5 %}text-blue-600 dark:text-blue-400{% else %}text-amber-600 dark:text-amber-400{% endif %}">{{ result.result.latency | round(2) }}s</div>
            </div>
            {% endif %}
          </div>
        </div>
        {% if result.result.error %}
        <div class="group relative mt-4 rounded-lg bg-rose-50 border border-rose-200 px-4 py-3 text-sm text-rose-700 dark:bg-rose-500/10 dark:border-rose-500/30 dark:text-rose-400">
          <div class="flex items-start justify-between gap-2">
            <div><span class="font-medium">Error:</span> {{ result.result.error }}</div>
            <button class="copy-btn shrink-0 flex h-7 w-7 items-center justify-center rounded-md text-rose-400 opacity-0 transition group-hover:opacity-100 hover:bg-rose-100 hover:text-rose-600 dark:hover:bg-rose-500/20 dark:hover:text-rose-300" data-copy="data-error" title="Copy error">
              <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
          <pre id="data-error" class="hidden">{{ result.result.error }}</pre>
        </div>
        {% endif %}
      </div>

      <!-- Input / Reference Row -->
      <div class="mb-6 grid gap-4 {% if has_reference %}lg:grid-cols-2{% endif %}">
        <!-- Input -->
        <div class="data-card flex flex-col rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
          <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
            <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Input</span>
            <button class="copy-btn flex h-7 w-7 items-center justify-center rounded-md text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800 dark:hover:text-zinc-300" data-copy="data-input" title="Copy">
              <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
          <div class="flex-1 overflow-auto p-4">
            <div id="data-input" class="data-viewer">
              <div class="data-surface">
                <pre class="data-pre text-zinc-700 dark:text-zinc-300">{{ result.result.input }}</pre>
              </div>
            </div>
          </div>
        </div>

        {% if has_reference %}
        <!-- Reference -->
        <div class="data-card flex flex-col rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
          <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
            <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Reference</span>
            <button class="copy-btn flex h-7 w-7 items-center justify-center rounded-md text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800 dark:hover:text-zinc-300" data-copy="data-ref" title="Copy">
              <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
          <div class="flex-1 overflow-auto p-4">
            <div id="data-ref" class="data-viewer">
              <div class="data-surface">
                <pre class="data-pre text-zinc-700 dark:text-zinc-300">{{ result.result.reference }}</pre>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Output (full width) -->
      <div class="mb-6">
        <div class="data-card flex flex-col rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
          <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
            <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Output</span>
            <button class="copy-btn flex h-7 w-7 items-center justify-center rounded-md text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800 dark:hover:text-zinc-300" data-copy="data-output" title="Copy">
              <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
          <div class="flex-1 overflow-auto p-4">
            <div id="data-output" class="data-viewer">
              <div class="data-surface">
                <pre class="data-pre text-zinc-700 dark:text-zinc-300">{% if result.result.output %}{{ result.result.output }}{% else %}—{% endif %}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Metadata (only if content exists) -->
      {% if has_metadata %}
      <div class="mb-6">
        <div class="flex flex-col rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
          <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
            <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Metadata</span>
            <button class="copy-btn flex h-7 w-7 items-center justify-center rounded-md text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800 dark:hover:text-zinc-300" data-copy="data-meta" title="Copy">
              <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
          <div class="flex-1 overflow-auto p-4" style="max-height: 200px;">
            <div id="data-meta" class="data-viewer">
              <div class="data-surface">
                <pre class="data-pre text-zinc-700 dark:text-zinc-300">{% if result.result.metadata is mapping %}{{ result.result.metadata | tojson }}{% else %}{{ result.result.metadata }}{% endif %}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Scores -->
      {% if result.result.scores %}
      <div class="mb-6 rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
        <div class="border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
          <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Scores</span>
        </div>
        <div class="p-4">
          <div class="flex flex-col gap-3">
            {% for s in result.result.scores %}
            <div class="rounded-lg border border-zinc-200 bg-zinc-50 px-4 py-3 dark:border-zinc-700 dark:bg-zinc-800/50">
              <div class="flex items-center gap-3">
                <span class="font-mono text-sm font-medium text-zinc-700 dark:text-zinc-300">{{ s.key }}</span>
                {% if s.value is not none %}
                  <span class="font-mono text-sm text-zinc-500 dark:text-zinc-400">{{ s.value }}</span>
                {% endif %}
                {% if s.passed is not none %}
                  <span class="flex h-5 w-5 items-center justify-center rounded-full {% if s.passed %}bg-emerald-100 text-emerald-600 dark:bg-emerald-500/20 dark:text-emerald-400{% else %}bg-rose-100 text-rose-600 dark:bg-rose-500/20 dark:text-rose-400{% endif %}">
                    {% if s.passed %}<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>{% else %}<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>{% endif %}
                  </span>
                {% endif %}
              </div>
              {% if s.notes %}
              <div class="mt-2 text-sm text-zinc-500 dark:text-zinc-400 border-t border-zinc-200 dark:border-zinc-700 pt-2">{{ s.notes }}</div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Run Data (Collapsible) -->
      {% if has_run_data %}
      <div class="mb-6 rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
        <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
          <div role="button" tabindex="0" onclick="toggleCollapse('run-data')" onkeydown="if(event.key==='Enter')toggleCollapse('run-data')" class="flex flex-1 cursor-pointer items-center gap-2">
            <svg id="run-data-icon" class="collapse-icon h-4 w-4 text-zinc-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Run Data</span>
          </div>
          <button class="copy-btn flex h-7 w-7 items-center justify-center rounded-md text-zinc-400 transition hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800 dark:hover:text-zinc-300" data-copy="data-run" title="Copy">
            <svg class="copy-icon h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            <svg class="check-icon hidden h-4 w-4 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
          </button>
        </div>
        <div id="run-data-content" class="collapsible-content">
          <div class="p-4">
            <div id="data-run" class="data-viewer">
              <div class="data-surface max-h-96 overflow-auto">
                <pre class="data-pre text-zinc-700 dark:text-zinc-300">{{ result.result.run_data | tojson(indent=2) }}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Annotation -->
      <div class="mb-6 rounded-xl border border-zinc-200 bg-white shadow-sm dark:border-zinc-800 dark:bg-zinc-900">
        <div class="flex items-center justify-between border-b border-zinc-100 px-4 py-3 dark:border-zinc-800">
          <span class="text-xs font-semibold uppercase tracking-wider text-zinc-500">Annotation</span>
        </div>
        <div class="p-4">
          {% if result.result.annotation %}
          <div class="whitespace-pre-wrap text-sm text-zinc-700 dark:text-zinc-300">{{ result.result.annotation }}</div>
          {% else %}
          <div class="text-sm italic text-zinc-400 dark:text-zinc-500">No annotation</div>
          {% endif %}
        </div>
      </div>

      <!-- Keyboard shortcuts hint -->
      <div class="py-4 text-center text-xs text-zinc-400 dark:text-zinc-600">
        <kbd class="rounded border border-zinc-200 bg-zinc-100 px-1.5 py-0.5 font-mono text-zinc-500 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400">↑</kbd>
        <kbd class="rounded border border-zinc-200 bg-zinc-100 px-1.5 py-0.5 font-mono text-zinc-500 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400">↓</kbd>
        <span class="mx-1">navigate</span>
        <span class="mx-2 text-zinc-300 dark:text-zinc-700">·</span>
        <kbd class="rounded border border-zinc-200 bg-zinc-100 px-1.5 py-0.5 font-mono text-zinc-500 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-400">Esc</kbd>
        <span class="mx-1">back to table</span>
      </div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-blue-200/60 bg-blue-50/30 py-4 dark:border-zinc-800/60 dark:bg-transparent">
      <div class="mx-auto flex max-w-screen-2xl items-center justify-center gap-6 px-6 text-sm text-zinc-500 dark:text-zinc-400">
        <a href="https://github.com/camronh/Twevals" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 transition hover:text-blue-600 dark:hover:text-blue-400">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          <span>GitHub</span>
        </a>
        <a href="https://twevals.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 transition hover:text-blue-600 dark:hover:text-blue-400">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          <span>Docs</span>
        </a>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script>
      const dataPayloads = {
        input: {{ result.result.input | default(None) | tojson }},
        output: {% if result.result.output is not none %}{{ result.result.output | tojson }}{% else %}null{% endif %},
        reference: {% if has_reference %}{{ result.result.reference | tojson }}{% else %}null{% endif %},
        metadata: {% if has_metadata %}{{ result.result.metadata | tojson }}{% else %}null{% endif %},
        run: {% if has_run_data %}{{ result.result.run_data | tojson }}{% else %}null{% endif %}
      };
      const currentIndex = {{ index }};
      const total = {{ total }};
      const runId = {{ run_id | tojson }};
      const evalPath = {{ eval_path | default('') | tojson }};
      const functionName = {{ result.function | tojson }};
      const dataset = {{ (result.dataset or "") | tojson }};

      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function looksLikeMarkdown(text) {
        if (!text) return false;
        const patterns = [
          /^#{1,6}\s+\S/m,
          /^\s*[-*+]\s+\S/m,
          /^\s*\d+\.\s+\S/m,
          /^>+\s+\S/m,
          /`{3,}[\s\S]*?`{3,}/m,
          /\[.+?\]\(.+?\)/m,
          /^-{3,}$/m
        ];
        return patterns.some((re) => re.test(text));
      }

      function highlightWithin(container) {
        if (typeof hljs === 'undefined' || !container) return;
        container.querySelectorAll('pre code').forEach((code) => hljs.highlightElement(code));
      }

      function highlightJson(rawText) {
        if (typeof hljs !== 'undefined' && typeof hljs.highlight === 'function') {
          try {
            return hljs.highlight(rawText, { language: 'json' }).value;
          } catch (err) {
            console.warn('Highlight failed, falling back to plain text', err);
          }
        }
        return escapeHtml(rawText);
      }

      function renderDataViewer(targetId, content, options = {}) {
        const container = document.getElementById(targetId);
        if (!container) return;
        const placeholder = options.placeholder || '—';

        if (content === null || content === undefined || content === '') {
          container.innerHTML = `<div class="data-surface text-sm text-zinc-400 dark:text-zinc-500">${placeholder}</div>`;
          container.dataset.raw = '';
          return;
        }

        let rawText;
        let mode = 'text';

        if (typeof content === 'string') {
          rawText = content;
        } else if (typeof content === 'number' || typeof content === 'boolean') {
          rawText = String(content);
        } else {
          try {
            rawText = JSON.stringify(content, null, 2);
            mode = 'json';
          } catch (err) {
            rawText = String(content);
          }
        }

        const trimmed = rawText.trim();
        if (mode !== 'json' && trimmed) {
          try {
            const parsed = JSON.parse(rawText);
            rawText = JSON.stringify(parsed, null, 2);
            mode = 'json';
          } catch (err) {
            if (looksLikeMarkdown(trimmed)) {
              mode = 'markdown';
            }
          }
        }

        container.dataset.mode = mode;

        if (mode === 'json') {
          const highlighted = highlightJson(rawText);
          container.innerHTML = `<div class="data-surface"><pre class="data-pre"><code class="hljs language-json">${highlighted}</code></pre></div>`;
          container.dataset.raw = rawText;
          return;
        }

        if (mode === 'markdown') {
          if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
            const html = DOMPurify.sanitize(marked.parse(rawText));
            container.innerHTML = `<div class="data-surface markdown-body">${html}</div>`;
            container.dataset.raw = rawText;
            highlightWithin(container);
            return;
          }
          mode = 'text';
        }

        container.innerHTML = `<div class="data-surface"><pre class="data-pre">${escapeHtml(rawText)}</pre></div>`;
        container.dataset.raw = rawText;
      }

      function navigateTo(idx) {
        if (idx >= 0 && idx < total) {
          window.location.href = `/runs/${runId}/results/${idx}`;
        }
      }

      function toggleCollapse(id) {
        const content = document.getElementById(id + '-content');
        const icon = document.getElementById(id + '-icon');
        content.classList.toggle('open');
        icon.classList.toggle('open');
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (typeof marked !== 'undefined') {
          marked.setOptions({ breaks: true, gfm: true });
        }

        renderDataViewer('data-input', dataPayloads.input);
        renderDataViewer('data-output', dataPayloads.output, { placeholder: '—' });
        if (dataPayloads.reference !== null) renderDataViewer('data-ref', dataPayloads.reference);
        if (dataPayloads.metadata !== null) renderDataViewer('data-meta', dataPayloads.metadata);
        if (dataPayloads.run !== null) renderDataViewer('data-run', dataPayloads.run);

        document.getElementById('prev-btn')?.addEventListener('click', () => navigateTo(currentIndex - 1));
        document.getElementById('next-btn')?.addEventListener('click', () => navigateTo(currentIndex + 1));

        document.addEventListener('keydown', (e) => {
          if (e.target.matches('input, textarea, select')) return;
          if (e.key === 'ArrowUp') { e.preventDefault(); navigateTo(currentIndex - 1); }
          else if (e.key === 'ArrowDown') { e.preventDefault(); navigateTo(currentIndex + 1); }
          else if (e.key === 'Escape') { window.location.href = '/'; }
        });

        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const targetId = btn.dataset.copy;
            const el = document.getElementById(targetId);
            if (!el) return;
            const raw = el.dataset?.raw ?? el.textContent;
            try {
              await navigator.clipboard.writeText(raw);
              btn.querySelector('.copy-icon').classList.add('hidden');
              btn.querySelector('.check-icon').classList.remove('hidden');
              setTimeout(() => {
                btn.querySelector('.copy-icon').classList.remove('hidden');
                btn.querySelector('.check-icon').classList.add('hidden');
              }, 1500);
            } catch (err) {
              console.error('Copy failed:', err);
            }
          });
        });

        // Copy run command button
        const copyCmd = document.getElementById('copy-cmd-btn');
        copyCmd?.addEventListener('click', async () => {
          const basePath = (evalPath || '').toString().trim();
          const fnPart = functionName ? `::${functionName}` : '';
          const cmd = basePath ? `twevals run ${basePath}${fnPart}` : `twevals run ${functionName || ''}`.trim();
          try {
            await navigator.clipboard.writeText(cmd);
            const copyIcon = copyCmd.querySelector('.copy-icon');
            const checkIcon = copyCmd.querySelector('.check-icon');
            if (copyIcon && checkIcon) {
              copyIcon.classList.add('hidden');
              checkIcon.classList.remove('hidden');
              setTimeout(() => { copyIcon.classList.remove('hidden'); checkIcon.classList.add('hidden'); }, 1500);
            }
          } catch (err) {
            console.error('Copy failed:', err);
          }
        });
      });
    </script>
  </body>
</html>
