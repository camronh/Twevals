<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ result.function }} - twevals</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace']
            }
          }
        }
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark-dimmed.min.css">
    <script>
      (function() {
        const saved = localStorage.getItem('twevals:theme');
        if (saved === 'light') document.documentElement.classList.remove('dark');
      })();
    </script>
    <style>
      .data-viewer { min-height: auto; }
      .data-surface { padding: 0; background: transparent; border: none; border-radius: 0; }
      .data-pre {
        background: transparent !important;
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 0.8125rem;
        line-height: 1.5;
      }
      .markdown-body { color: inherit; }
      .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 { font-weight: 600; margin: 0.25rem 0; line-height: 1.3; }
      .markdown-body p { margin: 0 0 0.35rem; }
      .markdown-body ul, .markdown-body ol { margin: 0 0 0.35rem 1rem; padding: 0; }
      .markdown-body ul { list-style: disc; }
      .markdown-body ol { list-style: decimal; }
      .markdown-body li { margin: 0.15rem 0; }
      .data-viewer code.hljs { background: transparent !important; }
      .data-viewer .hljs-attr { color: #60a5fa; }
      .data-viewer .hljs-string { color: #34d399; }
      .data-viewer .hljs-number, .data-viewer .hljs-literal { color: #f472b6; }

      .collapsible-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.15s ease-out; }
      .collapsible-content.open { grid-template-rows: 1fr; }
      .collapsible-content > div { overflow: hidden; }
      .collapse-icon { transition: transform 0.15s ease; }
      .collapse-icon.open { transform: rotate(180deg); }

      .data-panel { display: flex; flex-direction: column; min-height: 0; }
      .data-panel-header { flex-shrink: 0; }
      .data-panel-body { flex: 1; overflow: auto; min-height: 0; }

      /* Resize handles */
      .resize-handle-v {
        width: 5px;
        cursor: col-resize;
        background: transparent;
        position: relative;
        flex-shrink: 0;
        z-index: 10;
      }
      .resize-handle-v::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 2px;
        width: 1px;
        background: rgb(59 130 246 / 0.2);
        transition: background 0.15s, width 0.15s, left 0.15s;
      }
      .dark .resize-handle-v::after { background: rgb(63 63 70 / 0.8); }
      .resize-handle-v:hover::after, .resize-handle-v.dragging::after {
        background: rgb(59 130 246 / 0.6);
        width: 3px;
        left: 1px;
      }
      .dark .resize-handle-v:hover::after, .dark .resize-handle-v.dragging::after { background: rgb(59 130 246 / 0.5); }

      .resize-handle-h {
        height: 5px;
        cursor: row-resize;
        background: transparent;
        position: relative;
        flex-shrink: 0;
        z-index: 10;
      }
      .resize-handle-h::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 2px;
        height: 1px;
        background: rgb(59 130 246 / 0.2);
        transition: background 0.15s, height 0.15s, top 0.15s;
      }
      .dark .resize-handle-h::after { background: rgb(63 63 70 / 0.8); }
      .resize-handle-h:hover::after, .resize-handle-h.dragging::after {
        background: rgb(59 130 246 / 0.6);
        height: 3px;
        top: 1px;
      }
      .dark .resize-handle-h:hover::after, .dark .resize-handle-h.dragging::after { background: rgb(59 130 246 / 0.5); }

      body.resizing { cursor: col-resize; user-select: none; }
      body.resizing-v { cursor: row-resize; }
      body.resizing * { cursor: inherit !important; user-select: none !important; }

      /* Message boxes - compact stacked style */
      .msg-box {
        border-radius: 0.25rem;
        font-size: 0.75rem;
        line-height: 1.35;
        overflow: hidden;
      }
      .msg-box-header {
        padding: 0.125rem 0.375rem;
        font-size: 0.5625rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .msg-box-content {
        padding: 0.25rem 0.375rem;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: 'JetBrains Mono', ui-monospace, monospace;
        font-size: 0.6875rem;
        max-height: 300px;
        overflow-y: auto;
      }
      .msg-user .msg-box-header { background: rgb(59 130 246 / 0.2); color: rgb(37 99 235); }
      .msg-user .msg-box-content { background: rgb(59 130 246 / 0.05); }
      .msg-assistant .msg-box-header { background: rgb(34 197 94 / 0.2); color: rgb(22 163 74); }
      .msg-assistant .msg-box-content { background: rgb(34 197 94 / 0.05); }
      .msg-system .msg-box-header { background: rgb(250 204 21 / 0.2); color: rgb(202 138 4); }
      .msg-system .msg-box-content { background: rgb(250 204 21 / 0.05); }
      .msg-tool .msg-box-header, .msg-tool_calls .msg-box-header { background: rgb(168 85 247 / 0.2); color: rgb(147 51 234); }
      .msg-tool .msg-box-content, .msg-tool_calls .msg-box-content { background: rgb(168 85 247 / 0.05); }
      .msg-tool_result .msg-box-header { background: rgb(236 72 153 / 0.2); color: rgb(219 39 119); }
      .msg-tool_result .msg-box-content { background: rgb(236 72 153 / 0.05); }
      .dark .msg-user .msg-box-header { background: rgb(59 130 246 / 0.25); color: rgb(147 197 253); }
      .dark .msg-user .msg-box-content { background: rgb(59 130 246 / 0.08); }
      .dark .msg-assistant .msg-box-header { background: rgb(34 197 94 / 0.25); color: rgb(134 239 172); }
      .dark .msg-assistant .msg-box-content { background: rgb(34 197 94 / 0.08); }
      .dark .msg-system .msg-box-header { background: rgb(250 204 21 / 0.2); color: rgb(253 224 71); }
      .dark .msg-system .msg-box-content { background: rgb(250 204 21 / 0.05); }
      .dark .msg-tool .msg-box-header, .dark .msg-tool_calls .msg-box-header { background: rgb(168 85 247 / 0.25); color: rgb(216 180 254); }
      .dark .msg-tool .msg-box-content, .dark .msg-tool_calls .msg-box-content { background: rgb(168 85 247 / 0.08); }
      .dark .msg-tool_result .msg-box-header { background: rgb(236 72 153 / 0.25); color: rgb(249 168 212); }
      .dark .msg-tool_result .msg-box-content { background: rgb(236 72 153 / 0.08); }
    </style>
  </head>
  <body class="min-h-screen bg-blue-50/40 font-sans text-zinc-800 dark:bg-neutral-950 dark:text-zinc-100">
    {% set status = result.result.status or 'completed' %}
    {% set pill_tones = {
      'pending': 'text-blue-600 bg-blue-500/10 border border-blue-500/30 dark:text-blue-400',
      'running': 'text-cyan-600 bg-cyan-500/10 border border-cyan-500/30 dark:text-cyan-400',
      'completed': 'text-emerald-600 bg-emerald-500/10 border border-emerald-500/30 dark:text-emerald-400',
      'error': 'text-rose-600 bg-rose-500/10 border border-rose-500/30 dark:text-rose-400',
      'cancelled': 'text-amber-600 bg-amber-500/10 border border-amber-500/30 dark:text-amber-400'
    } %}
    {% set has_reference = result.result.reference and result.result.reference != '—' %}
    {% set has_metadata = result.result.metadata and result.result.metadata != '—' %}
    {% set has_trace_data = result.result.trace_data is defined and result.result.trace_data is not none %}
    {% set has_messages = has_trace_data and result.result.trace_data.messages is defined and result.result.trace_data.messages and result.result.trace_data.messages | length > 0 %}
    {% set has_scores = result.result.scores and result.result.scores | length > 0 %}

    {% set ns = namespace(all_passed=true, any_failed=false, total_scores=0) %}
    {% if has_scores %}
      {% for s in result.result.scores %}
        {% set ns.total_scores = ns.total_scores + 1 %}
        {% if s.passed is false %}{% set ns.all_passed = false %}{% set ns.any_failed = true %}
        {% elif s.passed is not true %}{% set ns.all_passed = false %}{% endif %}
      {% endfor %}
    {% endif %}

    <div class="flex flex-col h-screen">
      <!-- Compact Header Bar -->
      <header class="flex-shrink-0 flex items-center justify-between gap-4 border-b border-blue-200/60 bg-white px-4 py-2 dark:border-zinc-800 dark:bg-zinc-900">
        <div class="flex items-center gap-3 min-w-0">
          <a href="/" class="flex h-7 w-7 items-center justify-center rounded border border-zinc-200 text-zinc-500 hover:border-blue-300 hover:text-blue-600 dark:border-zinc-700 dark:hover:border-blue-500 dark:hover:text-blue-400" title="Back (Esc)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          </a>
          <div class="flex items-center gap-2 text-sm min-w-0">
            <span class="font-mono font-semibold text-zinc-900 dark:text-zinc-100 truncate">{{ result.function }}</span>
            <button id="copy-cmd-btn" class="copy-btn flex h-6 w-6 items-center justify-center rounded text-zinc-400 hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800" title="Copy run command">
              <svg class="copy-icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
              <svg class="check-icon hidden h-3.5 w-3.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            </button>
          </div>
        </div>
        <div class="flex items-center gap-1">
          <span class="text-xs text-zinc-500 mr-2">{{ index + 1 }}/{{ total }}</span>
          <button id="prev-btn" class="flex h-7 w-7 items-center justify-center rounded border border-zinc-200 text-zinc-500 hover:border-blue-300 hover:text-blue-600 disabled:opacity-40 dark:border-zinc-700 dark:hover:border-blue-500" title="↑" {% if index <= 0 %}disabled{% endif %}>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
          </button>
          <button id="next-btn" class="flex h-7 w-7 items-center justify-center rounded border border-zinc-200 text-zinc-500 hover:border-blue-300 hover:text-blue-600 disabled:opacity-40 dark:border-zinc-700 dark:hover:border-blue-500" title="↓" {% if index >= total - 1 %}disabled{% endif %}>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
        </div>
      </header>

      {% if result.result.error %}
      <div class="flex-shrink-0 bg-rose-50 border-b border-rose-200 px-4 py-2 dark:bg-rose-500/10 dark:border-rose-500/30">
        <div class="flex items-start gap-2 text-sm">
          <svg class="mt-0.5 shrink-0 text-rose-500" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <pre id="data-error" class="flex-1 text-rose-600 dark:text-rose-300 whitespace-pre-wrap font-mono text-xs">{{ result.result.error }}</pre>
          <button class="copy-btn shrink-0 text-rose-400 hover:text-rose-600" data-copy="data-error" title="Copy">
            <svg class="copy-icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            <svg class="check-icon hidden h-3.5 w-3.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Main Content Area -->
      <div class="flex-1 flex min-h-0 overflow-hidden">
        <!-- Left: Data Panels -->
        <div id="main-panel" class="flex flex-col min-w-0" style="width: calc(100% - 320px);">
          <!-- Input/Output Row -->
          <div id="io-row" class="flex min-h-0" style="flex: 1 1 auto;">
            <!-- Input Panel -->
            <div id="input-panel" class="flex flex-col min-w-0" style="width: 50%;">
              <div class="data-panel-header flex items-center justify-between border-b border-blue-100 bg-blue-50/50 px-3 py-1.5 dark:border-zinc-800/60 dark:bg-zinc-900/50">
                <span class="text-[10px] font-semibold uppercase tracking-wider text-blue-600 dark:text-blue-400">Input</span>
                <button class="copy-btn text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300" data-copy="data-input" title="Copy">
                  <svg class="copy-icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                  <svg class="check-icon hidden h-3.5 w-3.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                </button>
              </div>
              <div class="data-panel-body p-3 bg-white dark:bg-zinc-900/30">
                <div id="data-input" class="data-viewer">
                  <div class="data-surface"><pre class="data-pre text-zinc-700 dark:text-zinc-300">{{ result.result.input }}</pre></div>
                </div>
              </div>
            </div>

            <!-- Resize handle between Input/Output -->
            <div class="resize-handle-v" data-resize="input-output"></div>

            <!-- Output Panel -->
            <div id="output-panel" class="flex flex-col min-w-0" style="flex: 1;">
              <div class="data-panel-header flex items-center justify-between border-b border-blue-100 bg-emerald-50/50 px-3 py-1.5 dark:border-zinc-800/60 dark:bg-zinc-900/50">
                <span class="text-[10px] font-semibold uppercase tracking-wider text-emerald-600 dark:text-emerald-400">Output</span>
                <button class="copy-btn text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300" data-copy="data-output" title="Copy">
                  <svg class="copy-icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                  <svg class="check-icon hidden h-3.5 w-3.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
                </button>
              </div>
              <div class="data-panel-body p-3 bg-white dark:bg-zinc-900/30">
                <div id="data-output" class="data-viewer">
                  <div class="data-surface"><pre class="data-pre text-zinc-700 dark:text-zinc-300">{% if result.result.output %}{{ result.result.output }}{% else %}—{% endif %}</pre></div>
                </div>
              </div>
            </div>
          </div>

          {% if has_reference %}
          <!-- Resize handle between I/O and Reference -->
          <div class="resize-handle-h" data-resize="io-ref"></div>

          <!-- Reference Row -->
          <div id="ref-panel" class="flex flex-col flex-shrink-0" style="height: 150px; min-height: 60px;">
            <div class="data-panel-header flex items-center justify-between border-b border-amber-200/40 bg-amber-50/50 px-3 py-1.5 dark:border-amber-500/10 dark:bg-amber-500/5">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-amber-600 dark:text-amber-400">Reference</span>
              <button class="copy-btn text-amber-500 hover:text-amber-700 dark:hover:text-amber-300" data-copy="data-ref" title="Copy">
                <svg class="copy-icon h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                <svg class="check-icon hidden h-3.5 w-3.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
              </button>
            </div>
            <div class="data-panel-body p-3 overflow-auto bg-amber-50/30 dark:bg-amber-500/5">
              <div id="data-ref" class="data-viewer">
                <div class="data-surface"><pre class="data-pre text-amber-900 dark:text-amber-200">{{ result.result.reference }}</pre></div>
              </div>
            </div>
          </div>
          {% endif %}

        </div>

        <!-- Resize handle between Main and Sidebar -->
        <div class="resize-handle-v" data-resize="main-sidebar"></div>

        <!-- Right Sidebar -->
        <div id="sidebar-panel" class="flex flex-col min-h-0 overflow-auto bg-zinc-50 dark:bg-zinc-900/50" style="width: 320px; min-width: 200px;">
          <!-- Eval Info -->
          <div class="border-b border-blue-200/60 dark:border-zinc-800 p-3 space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-400">Status</span>
              <span class="rounded px-1.5 py-0.5 text-[10px] font-medium {{ pill_tones.get(status, pill_tones.get('completed')) }}">{{ status }}</span>
            </div>
            {% if result.result.latency is not none %}
            <div class="flex items-center justify-between">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-400">Latency</span>
              <span class="font-mono text-xs {% if result.result.latency <= 1 %}text-emerald-600 dark:text-emerald-400{% elif result.result.latency <= 5 %}text-blue-600 dark:text-blue-400{% else %}text-amber-600 dark:text-amber-400{% endif %}">{{ result.result.latency | round(2) }}s</span>
            </div>
            {% endif %}
            {% if result.dataset %}
            <div class="flex items-center justify-between">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-400">Dataset</span>
              <span class="text-xs text-zinc-600 dark:text-zinc-300">{{ result.dataset }}</span>
            </div>
            {% endif %}
            {% if result.labels %}
            <div class="flex items-center justify-between">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-400">Labels</span>
              <div class="flex gap-1">{% for la in result.labels %}<span class="rounded bg-zinc-200 px-1.5 py-0.5 text-[10px] text-zinc-600 dark:bg-zinc-700 dark:text-zinc-300">{{ la }}</span>{% endfor %}</div>
            </div>
            {% endif %}
            {% if has_trace_data and result.result.trace_data.trace_url %}
            <div class="flex items-center justify-between">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-400">Trace</span>
              <a href="{{ result.result.trace_data.trace_url }}" target="_blank" class="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                Open
              </a>
            </div>
            {% endif %}
          </div>

          {% if has_messages %}
          <!-- Messages Toggle -->
          <div class="border-b border-blue-200/60 dark:border-zinc-800">
            <button onclick="toggleMessagesPane()" class="w-full flex items-center justify-between px-3 py-2 bg-zinc-100/50 hover:bg-zinc-100 dark:bg-zinc-800/30 dark:hover:bg-zinc-800/50 text-left">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Messages</span>
              <span class="flex items-center gap-1.5">
                <span class="rounded-full bg-zinc-200 px-1.5 py-0.5 text-[10px] font-medium text-zinc-600 dark:bg-zinc-600 dark:text-zinc-200">{{ result.result.trace_data.messages | length }}</span>
                <svg class="h-3.5 w-3.5 text-zinc-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
              </span>
            </button>
          </div>
          {% endif %}

          {% if has_scores %}
          <div class="border-b border-blue-200/60 dark:border-zinc-800">
            <div class="px-3 py-2 text-[10px] font-semibold uppercase tracking-wider text-zinc-500 bg-zinc-100/50 dark:bg-zinc-800/30">Scores</div>
            <div class="p-2 space-y-1.5">
              {% for s in result.result.scores %}
              <div class="rounded border px-2.5 py-1.5 {% if s.passed is true %}border-emerald-200 bg-emerald-50 dark:border-emerald-500/30 dark:bg-emerald-500/10{% elif s.passed is false %}border-rose-200 bg-rose-50 dark:border-rose-500/30 dark:bg-rose-500/10{% else %}border-zinc-200 bg-white dark:border-zinc-700 dark:bg-zinc-800/50{% endif %}">
                <div class="flex items-center justify-between gap-2">
                  <span class="font-mono text-xs font-medium {% if s.passed is true %}text-emerald-700 dark:text-emerald-300{% elif s.passed is false %}text-rose-700 dark:text-rose-300{% else %}text-zinc-700 dark:text-zinc-300{% endif %}">{{ s.key }}</span>
                  <div class="flex items-center gap-1.5">
                    {% if s.value is not none %}<span class="font-mono text-xs {% if s.passed is true %}text-emerald-600 dark:text-emerald-400{% elif s.passed is false %}text-rose-600 dark:text-rose-400{% else %}text-zinc-500{% endif %}">{{ s.value }}</span>{% endif %}
                    {% if s.passed is not none %}
                    <span class="flex h-4 w-4 items-center justify-center rounded-full {% if s.passed %}bg-emerald-500 text-white{% else %}bg-rose-500 text-white{% endif %}">
                      {% if s.passed %}<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>{% else %}<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>{% endif %}
                    </span>
                    {% endif %}
                  </div>
                </div>
                {% if s.notes %}<div class="mt-1 text-[11px] {% if s.passed is true %}text-emerald-600 dark:text-emerald-400{% elif s.passed is false %}text-rose-600 dark:text-rose-400{% else %}text-zinc-500{% endif %}">{{ s.notes }}</div>{% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if has_metadata %}
          <div class="border-b border-blue-200/60 dark:border-zinc-800">
            <div role="button" tabindex="0" onclick="toggleCollapse('metadata')" onkeydown="if(event.key==='Enter')toggleCollapse('metadata')" class="flex cursor-pointer items-center justify-between px-3 py-2 bg-zinc-100/50 hover:bg-zinc-100 dark:bg-zinc-800/30 dark:hover:bg-zinc-800/50">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Metadata</span>
              <svg id="metadata-icon" class="collapse-icon open h-3.5 w-3.5 text-zinc-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div id="metadata-content" class="collapsible-content open">
              <div>
                <div class="p-2 max-h-40 overflow-auto">
                  <div id="data-meta" class="data-viewer">
                    <div class="data-surface"><pre class="data-pre text-zinc-600 dark:text-zinc-400 text-xs">{% if result.result.metadata is mapping %}{{ result.result.metadata | tojson(indent=2) }}{% else %}{{ result.result.metadata }}{% endif %}</pre></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if has_trace_data %}
          {% set filtered_trace = {} %}
          {% for k, v in result.result.trace_data.items() if k not in ['messages', 'trace_url'] %}
            {% set _ = filtered_trace.update({k: v}) %}
          {% endfor %}
          {% if filtered_trace %}
          <div class="border-b border-blue-200/60 dark:border-zinc-800">
            <div role="button" tabindex="0" onclick="toggleCollapse('trace-data')" onkeydown="if(event.key==='Enter')toggleCollapse('trace-data')" class="flex cursor-pointer items-center justify-between px-3 py-2 bg-zinc-100/50 hover:bg-zinc-100 dark:bg-zinc-800/30 dark:hover:bg-zinc-800/50">
              <span class="text-[10px] font-semibold uppercase tracking-wider text-zinc-500">Trace Data</span>
              <svg id="trace-data-icon" class="collapse-icon open h-3.5 w-3.5 text-zinc-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div id="trace-data-content" class="collapsible-content open">
              <div>
                <div class="p-2 max-h-48 overflow-auto">
                  <div id="data-trace" class="data-viewer">
                    <div class="data-surface"><pre class="data-pre text-zinc-600 dark:text-zinc-400 text-xs">{{ filtered_trace | tojson(indent=2) }}</pre></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% endif %}

          <div class="flex-1">
            <div class="px-3 py-2 text-[10px] font-semibold uppercase tracking-wider text-zinc-500 bg-zinc-100/50 dark:bg-zinc-800/30">Annotation</div>
            <div class="p-3">
              {% if result.result.annotation %}
              <div class="whitespace-pre-wrap text-xs text-zinc-700 dark:text-zinc-300">{{ result.result.annotation }}</div>
              {% else %}
              <div class="text-xs italic text-zinc-400 dark:text-zinc-500">No annotation</div>
              {% endif %}
            </div>
          </div>

          <div class="flex-shrink-0 px-3 py-2 border-t border-blue-200/60 bg-zinc-100/30 dark:border-zinc-800 dark:bg-zinc-800/20">
            <div class="flex items-center gap-4 text-[10px] text-zinc-400">
              <span><kbd class="rounded border border-zinc-300 bg-white px-1 font-mono dark:border-zinc-600 dark:bg-zinc-800">↑↓</kbd> nav</span>
              <span><kbd class="rounded border border-zinc-300 bg-white px-1 font-mono dark:border-zinc-600 dark:bg-zinc-800">Esc</kbd> back</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if has_messages %}
    <!-- Messages Sliding Pane -->
    <div id="messages-pane" class="fixed top-0 right-0 bottom-0 z-50 translate-x-full border-l border-zinc-200 bg-white shadow-xl transition-transform duration-200 dark:border-zinc-700 dark:bg-zinc-900" style="width: 700px;">
      <!-- Resize Handle -->
      <div id="messages-resize-handle" class="absolute left-0 top-0 bottom-0 w-1 cursor-ew-resize hover:bg-blue-500/50 active:bg-blue-500/70"></div>
      <!-- Header -->
      <div class="flex items-center justify-between border-b border-zinc-200 px-3 py-2 dark:border-zinc-700">
        <span class="text-sm font-medium text-zinc-700 dark:text-zinc-200">Messages <span class="text-zinc-400">({{ result.result.trace_data.messages | length }})</span></span>
        <button onclick="toggleMessagesPane()" class="rounded p-1 text-zinc-400 hover:bg-zinc-100 hover:text-zinc-600 dark:hover:bg-zinc-800">
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
      <!-- Messages Content -->
      <div class="h-[calc(100%-41px)] overflow-auto">
        <div id="data-messages" class="space-y-1 p-2"></div>
      </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script>
      const dataPayloads = {
        input: {{ result.result.input | default(None) | tojson }},
        output: {% if result.result.output is not none %}{{ result.result.output | tojson }}{% else %}null{% endif %},
        reference: {% if has_reference %}{{ result.result.reference | tojson }}{% else %}null{% endif %},
        metadata: {% if has_metadata %}{{ result.result.metadata | tojson }}{% else %}null{% endif %},
        trace: {% if has_trace_data %}{{ result.result.trace_data | tojson }}{% else %}null{% endif %},
        messages: {% if has_messages %}{{ result.result.trace_data.messages | tojson }}{% else %}null{% endif %}
      };
      const currentIndex = {{ index }};
      const total = {{ total }};
      const runId = {{ run_id | tojson }};
      const evalPath = {{ eval_path | default('') | tojson }};
      const functionName = {{ result.function | tojson }};

      function escapeHtml(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
      function looksLikeMarkdown(text) {
        if (!text) return false;
        return [/^#{1,6}\s+\S/m, /^\s*[-*+]\s+\S/m, /^\s*\d+\.\s+\S/m, /^>+\s+\S/m, /`{3,}[\s\S]*?`{3,}/m, /\[.+?\]\(.+?\)/m].some(re => re.test(text));
      }
      function highlightWithin(container) {
        if (typeof hljs === 'undefined' || !container) return;
        container.querySelectorAll('pre code').forEach(code => hljs.highlightElement(code));
      }
      function highlightJson(rawText) {
        if (typeof hljs !== 'undefined') { try { return hljs.highlight(rawText, { language: 'json' }).value; } catch {} }
        return escapeHtml(rawText);
      }
      function renderDataViewer(targetId, content, options = {}) {
        const container = document.getElementById(targetId);
        if (!container) return;
        if (content === null || content === undefined || content === '') {
          container.innerHTML = `<div class="data-surface text-xs text-zinc-400">${options.placeholder || '—'}</div>`;
          container.dataset.raw = '';
          return;
        }
        let rawText, mode = 'text';
        if (typeof content === 'string') rawText = content;
        else if (typeof content === 'number' || typeof content === 'boolean') rawText = String(content);
        else { try { rawText = JSON.stringify(content, null, 2); mode = 'json'; } catch { rawText = String(content); } }
        const trimmed = rawText.trim();
        if (mode !== 'json' && trimmed) {
          try { JSON.parse(rawText); rawText = JSON.stringify(JSON.parse(rawText), null, 2); mode = 'json'; }
          catch { if (looksLikeMarkdown(trimmed)) mode = 'markdown'; }
        }
        container.dataset.mode = mode;
        if (mode === 'json') {
          container.innerHTML = `<div class="data-surface"><pre class="data-pre"><code class="hljs language-json">${highlightJson(rawText)}</code></pre></div>`;
          container.dataset.raw = rawText;
          return;
        }
        if (mode === 'markdown' && typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
          container.innerHTML = `<div class="data-surface markdown-body text-sm">${DOMPurify.sanitize(marked.parse(rawText))}</div>`;
          container.dataset.raw = rawText;
          highlightWithin(container);
          return;
        }
        container.innerHTML = `<div class="data-surface"><pre class="data-pre">${escapeHtml(rawText)}</pre></div>`;
        container.dataset.raw = rawText;
      }
      function navigateTo(idx) { if (idx >= 0 && idx < total) window.location.href = `/runs/${runId}/results/${idx}`; }
      function toggleCollapse(id) {
        document.getElementById(id + '-content')?.classList.toggle('open');
        document.getElementById(id + '-icon')?.classList.toggle('open');
      }

      function toggleMessagesPane() {
        const pane = document.getElementById('messages-pane');
        if (pane) pane.classList.toggle('translate-x-full');
      }
      function closeMessagesPane() {
        document.getElementById('messages-pane')?.classList.add('translate-x-full');
      }

      function initMessagesPaneResize() {
        const handle = document.getElementById('messages-resize-handle');
        const pane = document.getElementById('messages-pane');
        if (!handle || !pane) return;

        let startX, startWidth;
        handle.addEventListener('mousedown', e => {
          e.preventDefault();
          startX = e.clientX;
          startWidth = pane.offsetWidth;
          document.body.style.cursor = 'ew-resize';
          document.body.style.userSelect = 'none';

          const onMouseMove = ev => {
            const delta = startX - ev.clientX;
            const newWidth = Math.max(300, Math.min(window.innerWidth - 100, startWidth + delta));
            pane.style.width = newWidth + 'px';
          };

          const onMouseUp = () => {
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            localStorage.setItem('twevals:messagesPaneWidth', pane.style.width);
          };

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });

        // Restore saved width
        const savedWidth = localStorage.getItem('twevals:messagesPaneWidth');
        if (savedWidth) pane.style.width = savedWidth;
      }

      function renderMessages(messages) {
        const container = document.getElementById('data-messages');
        if (!container || !messages || !Array.isArray(messages)) return;

        container.dataset.raw = JSON.stringify(messages, null, 2);

        // Check if messages match a known schema (have role/type and content/text/message)
        const isKnownSchema = messages.length > 0 && messages.every(msg =>
          (msg.role || msg.type) && (msg.content !== undefined || msg.text !== undefined || msg.message !== undefined || msg.tool_calls)
        );

        // If unknown schema, show raw JSON
        if (!isKnownSchema) {
          container.innerHTML = `<pre class="data-pre text-zinc-300 text-xs p-2">${escapeHtml(JSON.stringify(messages, null, 2))}</pre>`;
          return;
        }

        const html = messages.map(msg => {
          const role = (msg.role || msg.type || 'unknown').toLowerCase();
          let content = msg.content || msg.text || msg.message || '';

          // Handle tool_calls in assistant messages (OpenAI format)
          if (msg.tool_calls && Array.isArray(msg.tool_calls)) {
            const toolCallsContent = msg.tool_calls.map(tc => {
              const fn = tc.function || tc;
              return `${fn.name || tc.name || 'tool'}(${fn.arguments || JSON.stringify(tc.input || {})})`;
            }).join('\n');
            return `<div class="msg-box msg-tool_calls">
              <div class="msg-box-header">Tool Calls</div>
              <div class="msg-box-content">${escapeHtml(toolCallsContent)}</div>
            </div>`;
          }

          // Handle tool result messages
          if (role === 'tool' || role === 'tool_result' || role === 'function') {
            const toolName = msg.name || msg.tool_call_id || 'tool';
            if (typeof content === 'object') content = JSON.stringify(content, null, 2);
            return `<div class="msg-box msg-tool_result">
              <div class="msg-box-header">${escapeHtml(toolName)} Result</div>
              <div class="msg-box-content">${escapeHtml(String(content))}</div>
            </div>`;
          }

          // Handle array content (OpenAI vision/multimodal)
          if (Array.isArray(content)) {
            content = content.map(c => typeof c === 'string' ? c : (c.text || c.content || JSON.stringify(c))).join('\n');
          }
          if (typeof content === 'object' && content !== null) {
            content = JSON.stringify(content, null, 2);
          }

          // Normalize role names
          const normalizedRole = role === 'human' ? 'user' : role === 'ai' ? 'assistant' : role;
          const displayRole = normalizedRole.charAt(0).toUpperCase() + normalizedRole.slice(1);

          return `<div class="msg-box msg-${normalizedRole}">
            <div class="msg-box-header">${escapeHtml(displayRole)}</div>
            <div class="msg-box-content">${escapeHtml(String(content))}</div>
          </div>`;
        }).join('');

        container.innerHTML = html;
      }

      // Resizable panels
      function initResizable() {
        const handles = document.querySelectorAll('.resize-handle-v, .resize-handle-h');
        handles.forEach(handle => {
          let startX, startY, startWidth, startHeight, target1, target2, isVertical;

          handle.addEventListener('mousedown', e => {
            e.preventDefault();
            isVertical = handle.classList.contains('resize-handle-h');
            handle.classList.add('dragging');
            document.body.classList.add('resizing');
            if (isVertical) document.body.classList.add('resizing-v');

            const resizeType = handle.dataset.resize;
            if (resizeType === 'input-output') {
              target1 = document.getElementById('input-panel');
              target2 = document.getElementById('output-panel');
              startX = e.clientX;
              startWidth = target1.offsetWidth;
            } else if (resizeType === 'main-sidebar') {
              target1 = document.getElementById('main-panel');
              target2 = document.getElementById('sidebar-panel');
              startX = e.clientX;
              startWidth = target2.offsetWidth;
            } else if (resizeType === 'io-ref') {
              target1 = document.getElementById('io-row');
              target2 = document.getElementById('ref-panel');
              startY = e.clientY;
              startHeight = target2.offsetHeight;
            }

            const onMouseMove = ev => {
              if (resizeType === 'input-output') {
                const delta = ev.clientX - startX;
                const parentWidth = target1.parentElement.offsetWidth - 5;
                const newWidth = Math.max(100, Math.min(parentWidth - 100, startWidth + delta));
                target1.style.width = newWidth + 'px';
              } else if (resizeType === 'main-sidebar') {
                const delta = startX - ev.clientX;
                const containerWidth = target1.parentElement.offsetWidth - 5;
                const newSidebarWidth = Math.max(200, Math.min(containerWidth - 300, startWidth + delta));
                target2.style.width = newSidebarWidth + 'px';
                target1.style.width = `calc(100% - ${newSidebarWidth}px)`;
              } else if (resizeType === 'io-ref') {
                const delta = startY - ev.clientY;
                const containerHeight = target1.parentElement.offsetHeight - 5;
                const newHeight = Math.max(60, Math.min(containerHeight - 100, startHeight + delta));
                target2.style.height = newHeight + 'px';
              }
            };

            const onMouseUp = () => {
              handle.classList.remove('dragging');
              document.body.classList.remove('resizing', 'resizing-v');
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
              saveResizeSizes();
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });
        });
      }

      function saveResizeSizes() {
        const sizes = {};
        const inputPanel = document.getElementById('input-panel');
        const sidebarPanel = document.getElementById('sidebar-panel');
        const refPanel = document.getElementById('ref-panel');
        if (inputPanel) sizes.inputWidth = inputPanel.style.width;
        if (sidebarPanel) sizes.sidebarWidth = sidebarPanel.style.width;
        if (refPanel) sizes.refHeight = refPanel.style.height;
        localStorage.setItem('twevals:detailSizes', JSON.stringify(sizes));
      }

      function restoreResizeSizes() {
        try {
          const sizes = JSON.parse(localStorage.getItem('twevals:detailSizes') || '{}');
          const inputPanel = document.getElementById('input-panel');
          const mainPanel = document.getElementById('main-panel');
          const sidebarPanel = document.getElementById('sidebar-panel');
          const refPanel = document.getElementById('ref-panel');
          if (sizes.inputWidth && inputPanel) inputPanel.style.width = sizes.inputWidth;
          if (sizes.sidebarWidth && sidebarPanel && mainPanel) {
            sidebarPanel.style.width = sizes.sidebarWidth;
            mainPanel.style.width = `calc(100% - ${sizes.sidebarWidth})`;
          }
          if (sizes.refHeight && refPanel) refPanel.style.height = sizes.refHeight;
        } catch {}
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (typeof marked !== 'undefined') marked.setOptions({ breaks: true, gfm: true });
        renderDataViewer('data-input', dataPayloads.input);
        renderDataViewer('data-output', dataPayloads.output, { placeholder: '—' });
        if (dataPayloads.reference !== null) renderDataViewer('data-ref', dataPayloads.reference);
        if (dataPayloads.metadata !== null) renderDataViewer('data-meta', dataPayloads.metadata);
        // Filter out messages and trace_url from trace data display
        if (dataPayloads.trace !== null) {
          const filteredTrace = Object.fromEntries(
            Object.entries(dataPayloads.trace).filter(([k]) => k !== 'messages' && k !== 'trace_url')
          );
          if (Object.keys(filteredTrace).length > 0) {
            renderDataViewer('data-trace', filteredTrace);
          }
        }
        if (dataPayloads.messages !== null) renderMessages(dataPayloads.messages);

        initResizable();
        restoreResizeSizes();
        initMessagesPaneResize();

        document.getElementById('prev-btn')?.addEventListener('click', () => navigateTo(currentIndex - 1));
        document.getElementById('next-btn')?.addEventListener('click', () => navigateTo(currentIndex + 1));

        document.addEventListener('keydown', e => {
          if (e.target.matches('input, textarea, select')) return;
          if (e.key === 'ArrowUp') { e.preventDefault(); navigateTo(currentIndex - 1); }
          else if (e.key === 'ArrowDown') { e.preventDefault(); navigateTo(currentIndex + 1); }
          else if (e.key === 'Escape') {
            const pane = document.getElementById('messages-pane');
            if (pane && !pane.classList.contains('translate-x-full')) { closeMessagesPane(); }
            else { window.location.href = '/'; }
          }
        });

        document.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            e.stopPropagation();
            const el = document.getElementById(btn.dataset.copy);
            if (!el) return;
            try {
              await navigator.clipboard.writeText(el.dataset?.raw ?? el.textContent);
              btn.querySelector('.copy-icon').classList.add('hidden');
              btn.querySelector('.check-icon').classList.remove('hidden');
              setTimeout(() => { btn.querySelector('.copy-icon').classList.remove('hidden'); btn.querySelector('.check-icon').classList.add('hidden'); }, 1500);
            } catch {}
          });
        });

        document.getElementById('copy-cmd-btn')?.addEventListener('click', async () => {
          const cmd = evalPath ? `twevals run ${evalPath}::${functionName}` : `twevals run ${functionName || ''}`.trim();
          try {
            await navigator.clipboard.writeText(cmd);
            const btn = document.getElementById('copy-cmd-btn');
            btn.querySelector('.copy-icon').classList.add('hidden');
            btn.querySelector('.check-icon').classList.remove('hidden');
            setTimeout(() => { btn.querySelector('.copy-icon').classList.remove('hidden'); btn.querySelector('.check-icon').classList.add('hidden'); }, 1500);
          } catch {}
        });
      });
    </script>
  </body>
</html>
