<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>twevals</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-primary: #09090b;
        --bg-secondary: #0f0f12;
        --bg-tertiary: #18181b;
        --bg-elevated: #1f1f23;
        --bg-hover: #27272a;
        --border-subtle: #27272a;
        --border-default: #3f3f46;
        --text-primary: #fafafa;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --accent-amber: #f59e0b;
        --accent-amber-dim: #b45309;
        --accent-amber-glow: rgba(245, 158, 11, 0.15);
        --success: #10b981;
        --success-dim: #065f46;
        --error: #f43f5e;
        --error-dim: #881337;
        --warning: #eab308;
        --info: #06b6d4;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      html {
        overflow-y: scroll;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.5;
      }

      .app-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 0 24px;
        overflow-x: hidden;
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 0;
        border-bottom: 1px solid var(--border-subtle);
        margin-bottom: 24px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-mark {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, var(--accent-amber) 0%, var(--accent-amber-dim) 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        font-size: 18px;
        color: var(--bg-primary);
        box-shadow: 0 0 20px var(--accent-amber-glow);
      }

      .logo-text {
        font-family: 'JetBrains Mono', monospace;
        font-size: 22px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: var(--text-primary);
      }

      .logo-text span {
        color: var(--accent-amber);
      }

      .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }

      /* Search */
      .search-wrapper {
        position: relative;
      }

      .search-input {
        width: 280px;
        padding: 10px 14px 10px 40px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .search-input:focus {
        outline: none;
        border-color: var(--accent-amber);
        box-shadow: 0 0 0 3px var(--accent-amber-glow);
      }

      .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
      }

      .btn-primary {
        background: var(--accent-amber);
        color: var(--bg-primary);
      }

      .btn-primary:hover {
        background: #fbbf24;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--accent-amber-glow);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
      }

      .btn-secondary:hover {
        background: var(--bg-hover);
        border-color: var(--border-default);
      }

      .btn-ghost {
        background: transparent;
        color: var(--text-secondary);
        padding: 8px 12px;
      }

      .btn-ghost:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      /* Dropdown menus */
      .dropdown {
        position: relative;
      }

      .dropdown-menu {
        position: absolute;
        top: calc(100% + 6px);
        right: 0;
        min-width: 200px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 10px;
        padding: 6px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }

      .dropdown-menu.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        color: var(--text-secondary);
        background: none;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        transition: all 0.15s ease;
      }

      .dropdown-item:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      .dropdown-divider {
        height: 1px;
        background: var(--border-subtle);
        margin: 6px 0;
      }

      /* Filters panel */
      .filters-panel {
        position: absolute;
        top: calc(100% + 6px);
        right: 0;
        width: 420px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 16px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }

      .filters-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .filters-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }

      .filters-title {
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-section {
        margin-bottom: 16px;
      }

      .filter-label {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .filter-row {
        display: flex;
        gap: 8px;
      }

      .filter-select, .filter-input {
        flex: 1;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 13px;
        font-family: inherit;
      }

      .filter-select:focus, .filter-input:focus {
        outline: none;
        border-color: var(--accent-amber);
      }

      .filter-btn {
        padding: 8px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .filter-btn:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      .active-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 28px;
      }

      .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--accent-amber-glow);
        border: 1px solid var(--accent-amber-dim);
        border-radius: 20px;
        font-size: 12px;
        color: var(--accent-amber);
      }

      .filter-chip button {
        background: none;
        border: none;
        color: var(--accent-amber);
        cursor: pointer;
        padding: 0;
        line-height: 1;
        opacity: 0.7;
      }

      .filter-chip button:hover {
        opacity: 1;
      }

      /* Columns panel */
      .columns-panel {
        position: absolute;
        top: calc(100% + 6px);
        right: 0;
        width: 260px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 16px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      }

      .columns-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .column-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        cursor: pointer;
        color: var(--text-secondary);
        transition: color 0.15s ease;
      }

      .column-toggle:hover {
        color: var(--text-primary);
      }

      .column-toggle input {
        width: 16px;
        height: 16px;
        accent-color: var(--accent-amber);
      }

      .column-toggle span {
        font-size: 14px;
      }

      .panel-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
      }

      .panel-actions button {
        flex: 1;
        padding: 8px;
        font-size: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .panel-actions button:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
      }

      /* Badge for filter count */
      .filter-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        background: var(--accent-amber);
        color: var(--bg-primary);
        font-size: 11px;
        font-weight: 600;
        border-radius: 10px;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .filter-badge.active {
        display: flex;
      }

      /* Loading indicator */
      .loading-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        color: var(--text-muted);
        font-size: 13px;
      }

      .loading-indicator.active {
        display: flex;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-subtle);
        border-top-color: var(--accent-amber);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Results container */
      #results {
        animation: fadeIn 0.3s ease;
        width: 100%;
        min-width: 0;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Sort indicators */
      #results-table thead th[aria-sort="ascending"]::after {
        content: " ↑";
        color: var(--accent-amber);
      }

      #results-table thead th[aria-sort="descending"]::after {
        content: " ↓";
        color: var(--accent-amber);
      }

      /* Column resizer */
      .col-resizer {
        position: absolute;
        right: 0;
        top: 0;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
      }

      .col-resizer:hover {
        background: linear-gradient(to right, transparent, var(--accent-amber-glow));
      }

      body.twevals-col-resize {
        cursor: col-resize !important;
      }

    </style>
  </head>
  <body>
    <div class="app-container">
      <header class="header">
        <div class="logo">
          <div class="logo-mark">tw</div>
          <div class="logo-text">twevals</div>
        </div>

        <div class="header-controls">
          <div id="loading-indicator" class="loading-indicator">
            <div class="spinner"></div>
            <span>Loading...</span>
          </div>

          <div class="search-wrapper">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <input id="search-input" type="search" class="search-input" placeholder="Search results..." />
          </div>

          <div class="dropdown">
            <button id="actions-toggle" class="btn btn-primary">
              <span>Actions</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div id="actions-menu" class="dropdown-menu">
              <button class="dropdown-item" data-action="refresh">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
              <button class="dropdown-item" data-action="rerun">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Rerun Evals
              </button>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" data-action="export-json">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export JSON
              </button>
              <button class="dropdown-item" data-action="export-csv">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
              </button>
            </div>
          </div>

          <div class="dropdown" style="position: relative;">
            <button id="filters-toggle" class="btn btn-ghost" style="position: relative;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              <span id="filters-count-badge" class="filter-badge"></span>
            </button>
            <div id="filters-menu" class="filters-panel">
              <div class="filters-header">
                <span class="filters-title">Filters</span>
                <button id="clear-filters" class="filter-btn">Clear All</button>
              </div>

              <div class="filter-section">
                <div class="filter-label">Score Key</div>
                <select id="key-select" class="filter-select"></select>
              </div>

              <div class="filter-section" id="value-section">
                <div class="filter-label">Value Condition</div>
                <div class="filter-row">
                  <select id="fv-op" class="filter-select" style="flex: 0 0 70px;">
                    <option value=">">&gt;</option>
                    <option value=">=">&gt;=</option>
                    <option value="<">&lt;</option>
                    <option value="<=">&lt;=</option>
                    <option value="==">=</option>
                    <option value="!=">!=</option>
                  </select>
                  <input id="fv-val" type="number" step="any" placeholder="value" class="filter-input" />
                  <button id="add-fv" class="filter-btn">Add</button>
                </div>
              </div>

              <div class="filter-section" id="passed-section">
                <div class="filter-label">Pass/Fail</div>
                <div class="filter-row">
                  <select id="fp-val" class="filter-select">
                    <option value="true">Passed</option>
                    <option value="false">Failed</option>
                  </select>
                  <button id="add-fp" class="filter-btn">Add</button>
                </div>
              </div>

              <div class="filter-section">
                <div class="filter-label">Has Annotation</div>
                <select id="fa-val" class="filter-select">
                  <option value="any">Any</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="filter-section">
                <div class="filter-label">Active Filters</div>
                <div id="active-filters" class="active-filters"></div>
              </div>
            </div>
          </div>

          <div class="dropdown">
            <button id="columns-toggle" class="btn btn-ghost">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </button>
            <div id="columns-menu" class="columns-panel">
              <div class="filters-title" style="margin-bottom: 12px;">Toggle Columns</div>
              <label class="column-toggle"><input type="checkbox" data-col="function" checked /><span>Function</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="dataset" checked /><span>Dataset</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="labels" checked /><span>Labels</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="input" checked /><span>Input</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="reference" checked /><span>Reference</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="output" checked /><span>Output</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="error" /><span>Error</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="scores" checked /><span>Scores</span></label>
              <label class="column-toggle"><input type="checkbox" data-col="latency" checked /><span>Latency</span></label>
              <div class="panel-actions">
                <button id="reset-columns">Reset Cols</button>
                <button id="reset-sorting">Reset Sort</button>
                <button id="reset-widths">Reset Width</button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div id="results" hx-get="/results" hx-trigger="load" hx-swap="innerHTML"></div>
    </div>

    <script>
      // Storage keys
      const STORAGE_KEY = "twevals:hidden_columns";
      const SORT_STORAGE_KEY = "twevals:sort_state";
      const WIDTHS_STORAGE_KEY = "twevals:col_widths";
      const EXPANDED_ROW_KEY = "twevals:expanded_row";
      const FILTERS_STORAGE_KEY = "twevals:filters";

      // Helpers
      const DEFAULT_HIDDEN_COLS = ["error"];
      function getHiddenCols() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored === null) return DEFAULT_HIDDEN_COLS;
        try { return JSON.parse(stored); } catch { return DEFAULT_HIDDEN_COLS; }
      }
      function setHiddenCols(cols) { localStorage.setItem(STORAGE_KEY, JSON.stringify(cols)); }
      function getSortState() {
        try { return JSON.parse(localStorage.getItem(SORT_STORAGE_KEY) || "[]"); } catch { return []; }
      }
      function setSortState(state) { localStorage.setItem(SORT_STORAGE_KEY, JSON.stringify(state)); }
      function getColWidths() {
        try { return JSON.parse(localStorage.getItem(WIDTHS_STORAGE_KEY) || "{}"); } catch { return {}; }
      }
      function setColWidths(map) { localStorage.setItem(WIDTHS_STORAGE_KEY, JSON.stringify(map)); }
      function defaultFilters() { return { valueRules: [], passedRules: [], annotation: 'any' }; }
      function getFilters() {
        try { return JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || 'null') || defaultFilters(); } catch { return defaultFilters(); }
      }
      function setFilters(f) {
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(f));
        renderActiveFilters();
        applyAllFilters();
      }

      // Dropdown toggles
      function setupDropdown(toggleId, menuId, panelClass = 'dropdown-menu') {
        const toggle = document.getElementById(toggleId);
        const menu = document.getElementById(menuId);
        if (!toggle || !menu) return;

        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const isActive = menu.classList.contains('active');
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
          if (!isActive) menu.classList.add('active');
        });
      }

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
        }
      });

      setupDropdown('actions-toggle', 'actions-menu');
      setupDropdown('filters-toggle', 'filters-menu');
      setupDropdown('columns-toggle', 'columns-menu');

      // Render active filters
      function renderActiveFilters() {
        const f = getFilters();
        const ct = document.getElementById('active-filters');
        const badge = document.getElementById('filters-count-badge');
        if (!ct) return;
        ct.innerHTML = '';
        let count = 0;

        f.valueRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'filter-chip';
          el.innerHTML = `${r.key} ${r.op} ${r.value}<button onclick="removeValueRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        f.passedRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'filter-chip';
          el.innerHTML = `${r.key} = ${r.value ? 'pass' : 'fail'}<button onclick="removePassedRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        if (f.annotation && f.annotation !== 'any') {
          count++;
          const el = document.createElement('span');
          el.className = 'filter-chip';
          el.innerHTML = `annotation: ${f.annotation}<button onclick="removeAnnotationFilter()">×</button>`;
          ct.appendChild(el);
        }

        if (badge) {
          badge.textContent = count;
          badge.classList.toggle('active', count > 0);
        }
      }

      window.removeValueRule = (idx) => { const f = getFilters(); f.valueRules.splice(idx, 1); setFilters(f); };
      window.removePassedRule = (idx) => { const f = getFilters(); f.passedRules.splice(idx, 1); setFilters(f); };
      window.removeAnnotationFilter = () => { const f = getFilters(); f.annotation = 'any'; setFilters(f); };

      // Column visibility
      function applyColumnVisibility() {
        const hidden = new Set(getHiddenCols());
        const allCols = ["function", "dataset", "labels", "input", "output", "reference", "error", "scores", "latency"];
        for (const col of allCols) {
          const isHidden = hidden.has(col);
          document.querySelectorAll(`#results-table [data-col="${col}"]`).forEach((el) => {
            el.classList.toggle('hidden', isHidden);
          });
        }
        document.querySelectorAll('#columns-menu input[data-col]').forEach((cb) => {
          cb.checked = !hidden.has(cb.getAttribute("data-col"));
        });
      }

      document.querySelectorAll('#columns-menu input[data-col]').forEach((cb) => {
        cb.addEventListener("change", (e) => {
          const col = e.target.getAttribute("data-col");
          const hidden = new Set(getHiddenCols());
          if (e.target.checked) hidden.delete(col);
          else hidden.add(col);
          setHiddenCols([...hidden]);
          applyColumnVisibility();
        });
      });

      // Reset buttons
      document.getElementById("reset-columns")?.addEventListener("click", () => {
        setHiddenCols(DEFAULT_HIDDEN_COLS);
        applyColumnVisibility();
      });
      document.getElementById("reset-sorting")?.addEventListener("click", () => {
        setSortState([]);
        const table = document.getElementById("results-table");
        if (table) applySortState(table);
      });
      document.getElementById("reset-widths")?.addEventListener("click", () => {
        setColWidths({});
        document.querySelectorAll('#results-table thead th[data-col]').forEach((th) => {
          th.style.width = '';
        });
      });

      // Clear filters
      document.getElementById('clear-filters')?.addEventListener('click', () => setFilters(defaultFilters()));

      // Filter wiring
      (function wireFilters() {
        const keySelect = document.getElementById('key-select');
        const addFv = document.getElementById('add-fv');
        const fvOp = document.getElementById('fv-op');
        const fvVal = document.getElementById('fv-val');
        const addFp = document.getElementById('add-fp');
        const fpVal = document.getElementById('fp-val');
        const faVal = document.getElementById('fa-val');

        if (addFv) addFv.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          const v = parseFloat(fvVal.value);
          if (!k || Number.isNaN(v)) return;
          const f = getFilters();
          f.valueRules.push({ key: k, op: fvOp.value, value: v });
          setFilters(f);
          fvVal.value = '';
        });

        if (addFp) addFp.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          if (!k) return;
          const f = getFilters();
          f.passedRules.push({ key: k, value: fpVal.value === 'true' });
          setFilters(f);
        });

        if (faVal) faVal.addEventListener('change', () => {
          const f = getFilters();
          f.annotation = faVal.value;
          setFilters(f);
        });

        renderActiveFilters();
      })();

      // Score keys for filter dropdown
      function computeScoreKeys() {
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return { all: [], meta: {} };
        const keys = new Set();
        const meta = {};
        tbody.querySelectorAll("tr[data-row='detail']").forEach(tr => {
          let scores = [];
          try { scores = JSON.parse(tr.getAttribute('data-original-scores') || '[]') || []; } catch {}
          (scores || []).forEach(s => {
            const k = s && s.key; if (!k) return;
            keys.add(k);
            const m = meta[k] || (meta[k] = { hasNumeric: false, hasPassed: false });
            if (!Number.isNaN(parseFloat(s.value))) m.hasNumeric = true;
            if (s.passed === true || s.passed === false) m.hasPassed = true;
          });
        });
        return { all: Array.from(keys).sort(), meta };
      }

      function populateScoreKeySelects() {
        const ks = computeScoreKeys();
        const sel = document.getElementById('key-select');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        ks.all.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.textContent = k; sel.appendChild(opt); });
        if (current && ks.all.includes(current)) sel.value = current; else if (ks.all.length) sel.value = ks.all[0];
        updateFilterSectionsVisibility();
      }

      function updateFilterSectionsVisibility() {
        const sel = document.getElementById('key-select');
        const ks = computeScoreKeys();
        const k = sel?.value || '';
        const m = ks.meta[k] || { hasNumeric: false, hasPassed: false };
        document.getElementById('value-section')?.classList.toggle('hidden', !m.hasNumeric);
        document.getElementById('passed-section')?.classList.toggle('hidden', !m.hasPassed);
      }

      document.getElementById('key-select')?.addEventListener('change', updateFilterSectionsVisibility);

      // Sorting
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: "base" });

      function getCellValue(tr, col) {
        const td = tr.querySelector(`td[data-col="${col}"]`);
        if (!td) return "";
        const dv = td.getAttribute("data-value");
        return dv !== null ? dv : td.textContent.trim();
      }

      function parseValue(value, type) {
        if (type === "number") {
          const num = parseFloat(value);
          return isNaN(num) ? Number.POSITIVE_INFINITY : num;
        }
        return value;
      }

      function compareValues(a, b, type) {
        if (type === "number") return a - b;
        return collator.compare(a, b);
      }

      function applySortState(table) {
        const state = getSortState();
        const headers = table.querySelectorAll("thead th[data-col]");
        headers.forEach((th) => th.setAttribute("aria-sort", "none"));
        const tbody = table.querySelector("tbody");
        const mainRows = Array.from(tbody.querySelectorAll("tr[data-row='main']"));

        mainRows.forEach((tr, i) => {
          if (!tr.hasAttribute("data-orig-index")) tr.setAttribute("data-orig-index", String(i));
        });

        if (!state.length) {
          mainRows.slice().sort((a, b) =>
            Number(a.getAttribute("data-orig-index")) - Number(b.getAttribute("data-orig-index"))
          ).forEach((tr) => {
            const id = tr.getAttribute('data-row-id');
            const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
            tbody.appendChild(tr);
            if (detail) tbody.appendChild(detail);
          });
          return;
        }

        state.forEach((s) => {
          const th = table.querySelector(`thead th[data-col="${s.col}"]`);
          if (th) th.setAttribute("aria-sort", s.dir === "asc" ? "ascending" : "descending");
        });

        mainRows.slice().sort((ra, rb) => {
          for (const s of state) {
            const type = s.type || "string";
            const va = parseValue(getCellValue(ra, s.col), type);
            const vb = parseValue(getCellValue(rb, s.col), type);
            const cmp = compareValues(va, vb, type);
            if (cmp !== 0) return s.dir === "asc" ? cmp : -cmp;
          }
          return Number(ra.getAttribute("data-orig-index")) - Number(rb.getAttribute("data-orig-index"));
        }).forEach((tr) => {
          const id = tr.getAttribute('data-row-id');
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          tbody.appendChild(tr);
          if (detail) tbody.appendChild(detail);
        });
      }

      function toggleSort(table, col, type, multi) {
        let state = getSortState();
        const idx = state.findIndex((s) => s.col === col);
        if (multi) {
          if (idx === -1) state.push({ col, dir: "asc", type });
          else if (state[idx].dir === "asc") state[idx].dir = "desc";
          else state.splice(idx, 1);
        } else {
          if (idx === 0 && state[0].dir === "asc") state = [{ col, dir: "desc", type }];
          else if (idx === 0 && state[0].dir === "desc") state = [];
          else state = [{ col, dir: "asc", type }];
        }
        setSortState(state);
        applySortState(table);
      }

      document.addEventListener("click", function (e) {
        const th = e.target.closest("#results thead th[data-col]");
        if (!th) return;
        const table = document.getElementById("results-table");
        if (!table) return;
        const col = th.getAttribute("data-col");
        const type = th.getAttribute("data-type") || "string";
        toggleSort(table, col, type, e.shiftKey);
      });

      // Column widths - only set on th elements, table-layout:fixed handles the rest
      function applyColumnWidths(table) {
        if (!table) return;
        const widths = getColWidths();
        Object.keys(widths).forEach((col) => {
          const w = widths[col];
          if (!w) return;
          const th = table.querySelector(`thead th[data-col="${col}"]`);
          if (th) th.style.width = `${w}px`;
        });
      }

      function initResizableColumns(table) {
        if (!table) return;
        const widths = getColWidths();
        const ths = table.querySelectorAll('thead th[data-col]');
        ths.forEach((th) => {
          if (getComputedStyle(th).position === 'static') th.style.position = 'relative';
          if (th.querySelector('.col-resizer')) return;

          const handle = document.createElement('div');
          handle.className = 'col-resizer';
          th.appendChild(handle);

          let startX = 0, startWidth = 0;
          const colKey = th.getAttribute('data-col');
          const minWidth = 50, maxWidth = 500;

          function onMouseMove(e) {
            const dx = e.clientX - startX;
            let newW = Math.max(minWidth, Math.min(maxWidth, startWidth + dx));
            th.style.width = `${newW}px`;
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.classList.remove('twevals-col-resize');
            const map = getColWidths();
            map[colKey] = Math.round(th.getBoundingClientRect().width);
            setColWidths(map);
          }

          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.classList.add('twevals-col-resize');
          });

          handle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });

          const saved = widths[colKey];
          if (saved) {
            th.style.width = `${saved}px`;
          }
        });
      }

      // Search & filtering
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        let timer;
        searchInput.addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(applyAllFilters, 120);
        });
      }

      function compare(op, a, b) {
        if (op === '>') return a > b;
        if (op === '>=') return a >= b;
        if (op === '<') return a < b;
        if (op === '<=') return a <= b;
        if (op === '==') return a === b;
        if (op === '!=') return a !== b;
        return false;
      }

      function rowMatchesFilters(mainTr, detailTr) {
        const f = getFilters();
        if (f.annotation && f.annotation !== 'any') {
          const ann = (detailTr?.getAttribute('data-original-annotation') || '').trim();
          const has = !!ann;
          if (f.annotation === 'yes' && !has) return false;
          if (f.annotation === 'no' && has) return false;
        }
        let scores = [];
        try { scores = JSON.parse(detailTr?.getAttribute('data-original-scores') || '[]') || []; } catch {}
        for (const vr of (f.valueRules || [])) {
          const s = scores.find(x => x && x.key === vr.key);
          if (!s) return false;
          const val = parseFloat(s.value);
          if (Number.isNaN(val)) return false;
          if (!compare(vr.op, val, vr.value)) return false;
        }
        for (const pr of (f.passedRules || [])) {
          const s = scores.find(x => x && x.key === pr.key);
          if (!s) return false;
          if ((s.passed === true) !== (pr.value === true)) return false;
        }
        return true;
      }

      function applyAllFilters() {
        const q = (document.getElementById('search-input')?.value || '').toLowerCase().trim();
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return;
        const mains = tbody.querySelectorAll("tr[data-row='main']");
        mains.forEach((tr) => {
          const id = tr.getAttribute('data-row-id');
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          let show = true;
          if (q) {
            const text = tr.textContent.toLowerCase();
            if (!text.includes(q)) show = false;
          }
          if (show) show = rowMatchesFilters(tr, detail);
          tr.classList.toggle('hidden', !show);
          if (!show && detail && !detail.hasAttribute('hidden')) detail.setAttribute('hidden', '');
        });
        updateFilteredSummary();
      }

      function updateFilteredSummary() {
        const container = document.getElementById('filtered-summary');
        const table = document.getElementById('results-table');
        if (!container || !table) return;
        const tbody = table.querySelector('tbody');
        const mains = Array.from(tbody.querySelectorAll("tr[data-row='main']"));
        const visible = mains.filter(tr => !tr.classList.contains('hidden'));
        const hasActive = (() => {
          const f = getFilters();
          return (f.valueRules.length + f.passedRules.length + (f.annotation !== 'any' ? 1 : 0)) > 0 ||
            (document.getElementById('search-input')?.value || '').trim().length > 0;
        })();
        container.classList.toggle('hidden', !hasActive);
        if (!hasActive) return;
        document.getElementById('filtered-count-chip').textContent = `Filtered: ${visible.length}/${mains.length}`;

        let sum = 0, cnt = 0;
        visible.forEach(tr => {
          const td = tr.querySelector("td[data-col='latency']");
          const v = parseFloat(td?.getAttribute('data-value') || '');
          if (!Number.isNaN(v)) { sum += v; cnt += 1; }
        });
        const avgEl = document.getElementById('filtered-avg-latency');
        if (avgEl) avgEl.textContent = cnt > 0 ? `Avg: ${(sum / cnt).toFixed(2)}s` : 'Avg: —';

        const chipsEl = document.getElementById('filtered-score-chips');
        if (chipsEl) chipsEl.innerHTML = '';
        const map = {};
        visible.forEach(tr => {
          const id = tr.getAttribute('data-row-id');
          const det = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          let scores = [];
          try { scores = JSON.parse(det?.getAttribute('data-original-scores') || '[]') || []; } catch {}
          scores.forEach(s => {
            const key = s?.key; if (!key) return;
            const d = map[key] || (map[key] = { passed: 0, failed: 0, bool: 0, sum: 0, count: 0 });
            if (s.passed === true) { d.passed++; d.bool++; }
            else if (s.passed === false) { d.failed++; d.bool++; }
            const val = parseFloat(s.value);
            if (!Number.isNaN(val)) { d.sum += val; d.count += 1; }
          });
        });
        Object.entries(map).forEach(([k, d]) => {
          const el = document.createElement('span');
          el.className = 'stat-chip';
          if (d.bool > 0) {
            const total = d.passed + d.failed;
            el.classList.add(d.passed === total ? 'success' : d.passed === 0 ? 'error' : 'warning');
            el.textContent = `${k}: ${d.passed}/${total}`;
          } else if (d.count > 0) {
            el.textContent = `${k}: ${(d.sum / d.count).toFixed(2)}`;
          } else return;
          chipsEl?.appendChild(el);
        });
      }

      // Expand/collapse
      function initExpandHandlers() {
        const container = document.getElementById('results');
        const tbody = document.querySelector('#results-table tbody');
        if (!container || !tbody) return;

        function closeAll() {
          tbody.querySelectorAll("tr[data-row='detail']").forEach((tr) => tr.setAttribute('hidden', ''));
          container.querySelectorAll('.expand-btn[aria-expanded="true"]').forEach((b) => {
            b.setAttribute('aria-expanded', 'false');
            b.querySelector('.icon').textContent = '▸';
          });
        }

        function openRow(rowId) {
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          const btn = container.querySelector(`.expand-btn[data-row-id='${rowId}']`);
          if (!detail || !btn) return;
          closeAll();
          detail.removeAttribute('hidden');
          btn.setAttribute('aria-expanded', 'true');
          btn.querySelector('.icon').textContent = '▾';
          try { localStorage.setItem(EXPANDED_ROW_KEY, rowId); } catch {}
        }

        container.querySelectorAll('.expand-btn').forEach((btn) => {
          const clone = btn.cloneNode(true);
          btn.parentNode.replaceChild(clone, btn);
          clone.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const rowId = clone.getAttribute('data-row-id');
            const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
            const isOpen = detail && !detail.hasAttribute('hidden');
            if (isOpen) {
              closeAll();
              try { localStorage.removeItem(EXPANDED_ROW_KEY); } catch {}
            } else {
              openRow(rowId);
            }
          });
        });

        window.restoreExpandedRow = function() {
          let rowId = null;
          try { rowId = localStorage.getItem(EXPANDED_ROW_KEY); } catch {}
          if (rowId) openRow(rowId);
        };
      }

      // Inline editing
      function initInlineEditing() {
        const container = document.getElementById('results');
        const table = document.getElementById('results-table');
        if (!container || !table) return;
        const runId = table.getAttribute('data-run-id') || 'latest';

        container.querySelectorAll('.edit-btn').forEach((btn) => {
          const rowId = btn.getAttribute('data-row-id');
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          const saveBtn = container.querySelector(`.save-btn[data-row-id='${rowId}']`);
          const cancelBtn = container.querySelector(`.cancel-btn[data-row-id='${rowId}']`);
          if (!detail || !saveBtn || !cancelBtn) return;

          btn.addEventListener('click', () => enterEdit(rowId));
          cancelBtn.addEventListener('click', () => exitEdit(rowId, true));
          saveBtn.addEventListener('click', () => saveEdit(rowId, runId));
        });

        function toggleEditUI(detail, editing) {
          detail.querySelectorAll('.view-section').forEach((el) => el.classList.toggle('hidden', editing));
          detail.querySelectorAll('.edit-section').forEach((el) => el.classList.toggle('hidden', !editing));
          const rowId = detail.getAttribute('data-row-id');
          container.querySelector(`.edit-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', editing);
          container.querySelector(`.save-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', !editing);
          container.querySelector(`.cancel-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', !editing);
        }

        function enterEdit(rowId) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          toggleEditUI(detail, true);
          const ds = detail.getAttribute('data-original-dataset') || '';
          const lbls = JSON.parse(detail.getAttribute('data-original-labels') || '[]');
          const md = JSON.parse(detail.getAttribute('data-original-metadata') || 'null');
          const ann = detail.getAttribute('data-original-annotation') || '';
          const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
          const lbInput = detail.querySelector(`#labels-input-${rowId}`);
          const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
          const annInput = detail.querySelector(`#annotation-input-${rowId}`);
          if (dsInput) dsInput.value = ds;
          if (lbInput) lbInput.value = (lbls || []).join(', ');
          if (mdInput) mdInput.value = md ? JSON.stringify(md, null, 2) : '';
          if (annInput) annInput.value = ann;
        }

        function exitEdit(rowId, resetValues) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          if (resetValues) {
            const ds = detail.getAttribute('data-original-dataset') || '';
            const lbls = JSON.parse(detail.getAttribute('data-original-labels') || '[]');
            const md = JSON.parse(detail.getAttribute('data-original-metadata') || 'null');
            const ann = detail.getAttribute('data-original-annotation') || '';
            const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
            const lbInput = detail.querySelector(`#labels-input-${rowId}`);
            const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
            const annInput = detail.querySelector(`#annotation-input-${rowId}`);
            if (dsInput) dsInput.value = ds;
            if (lbInput) lbInput.value = (lbls || []).join(', ');
            if (mdInput) mdInput.value = md ? JSON.stringify(md, null, 2) : '';
            if (annInput) annInput.value = ann;

            const scores = JSON.parse(detail.getAttribute('data-original-scores') || '[]');
            const editor = detail.querySelector(`#scores-editor-${rowId}`);
            if (editor) {
              const cards = editor.querySelectorAll('.score-card');
              cards.forEach((card, i) => {
                const s = scores[i];
                if (!s) return;
                const k = card.querySelector('[name="score-key"]');
                const v = card.querySelector('[name="score-value"]');
                const p = card.querySelector('[name="score-passed"]');
                const n = card.querySelector('[name="score-notes"]');
                if (k) k.value = s.key || '';
                if (v) v.value = s.value ?? '';
                if (p) p.value = s.passed === true ? 'true' : s.passed === false ? 'false' : '';
                if (n) n.value = s.notes ?? '';
              });
            }
          }
          toggleEditUI(detail, false);
        }

        async function saveEdit(rowId, runId) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
          const lbInput = detail.querySelector(`#labels-input-${rowId}`);
          const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
          const editor = detail.querySelector(`#scores-editor-${rowId}`);

          let metadata = null;
          const mdRaw = (mdInput && mdInput.value.trim()) || '';
          if (mdRaw) {
            try { metadata = JSON.parse(mdRaw); }
            catch { alert('Invalid metadata JSON'); return; }
          }

          const scorePayload = [];
          if (editor) {
            editor.querySelectorAll('.score-card').forEach((card) => {
              const k = card.querySelector('[name="score-key"]').value.trim();
              const vRaw = card.querySelector('[name="score-value"]').value.trim();
              const pVal = card.querySelector('[name="score-passed"]').value;
              const nVal = card.querySelector('[name="score-notes"]').value.trim();
              const s = { key: k };
              if (vRaw !== '') {
                const num = Number(vRaw);
                if (!Number.isNaN(num)) s.value = num;
              }
              if (pVal === 'true') s.passed = true;
              else if (pVal === 'false') s.passed = false;
              if (nVal !== '') s.notes = nVal;
              if (s.key && (s.value !== undefined || s.passed !== undefined || s.notes !== undefined)) {
                scorePayload.push(s);
              }
            });
          }

          const annInput = detail.querySelector(`#annotation-input-${rowId}`);
          const annValue = annInput ? annInput.value.trim() : '';

          const payload = {
            dataset: dsInput ? dsInput.value.trim() : undefined,
            labels: lbInput ? lbInput.value.split(',').map(x => x.trim()).filter(Boolean) : undefined,
            result: { metadata, scores: scorePayload, annotation: annValue || null }
          };

          try {
            const resp = await fetch(`/api/runs/${runId}/results/${rowId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error(await resp.text());
          } catch (e) {
            alert(`Save failed: ${e}`);
            return;
          }

          try { localStorage.setItem(EXPANDED_ROW_KEY, rowId); } catch {}
          htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
        }
      }

      // Actions menu
      function wireActionsMenu() {
        const table = document.getElementById('results-table');
        const runId = table ? (table.getAttribute('data-run-id') || 'latest') : 'latest';
        const menu = document.getElementById('actions-menu');
        if (!menu) return;

        menu.querySelectorAll('[data-action]').forEach((el) => {
          el.onclick = async (e) => {
            const act = e.currentTarget.getAttribute('data-action');
            menu.classList.remove('active');
            if (act === 'refresh') {
              showLoading();
              htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
            } else if (act === 'rerun') {
              try {
                showLoading();
                const resp = await fetch('/api/runs/rerun', { method: 'POST' });
                if (!resp.ok) throw new Error(await resp.text());
                htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
              } catch (e) {
                alert('Rerun failed: ' + e);
              } finally {
                hideLoading();
              }
            } else if (act === 'export-json') {
              window.location.href = `/api/runs/${runId}/export/json`;
            } else if (act === 'export-csv') {
              window.location.href = `/api/runs/${runId}/export/csv`;
            }
          };
        });
      }

      // Loading state
      function showLoading() { document.getElementById('loading-indicator')?.classList.add('active'); }
      function hideLoading() { document.getElementById('loading-indicator')?.classList.remove('active'); }
      document.body.addEventListener('htmx:beforeRequest', showLoading);
      document.body.addEventListener('htmx:afterSwap', hideLoading);
      document.body.addEventListener('htmx:responseError', hideLoading);

      // Copy to clipboard
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.copy-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-copy');
        const pre = document.getElementById(id);
        if (!pre) return;
        try {
          await navigator.clipboard.writeText(pre.innerText);
          const copyIcon = btn.querySelector('.copy-icon');
          const checkIcon = btn.querySelector('.check-icon');
          if (copyIcon && checkIcon) {
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');
            setTimeout(() => { copyIcon.classList.remove('hidden'); checkIcon.classList.add('hidden'); }, 900);
          }
        } catch {
          alert('Copy failed');
        }
      });

      // Lightweight live refresh when runs are still pending
      let liveUpdateTimer = null;
      function scheduleLiveRefresh() {
        if (liveUpdateTimer) {
          clearTimeout(liveUpdateTimer);
          liveUpdateTimer = null;
        }
        const hasPending = document.querySelector('[data-status="pending"], [data-status="running"]');
        if (!hasPending) return;
        liveUpdateTimer = setTimeout(() => {
          htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
        }, 1200);
      }

      // HTMX after swap handler
      document.addEventListener("htmx:afterSwap", function (e) {
        if (e.target.id === "results") {
          const table = document.getElementById("results-table");
          if (table) {
            applySortState(table);
            applyColumnWidths(table);
            initResizableColumns(table);
          }
          applyColumnVisibility();
          initExpandHandlers();
          initInlineEditing();
          if (window.restoreExpandedRow) restoreExpandedRow();
          wireActionsMenu();
          try { populateScoreKeySelects(); applyAllFilters(); } catch {}
          scheduleLiveRefresh();
        }
      });
    </script>
  </body>
</html>
