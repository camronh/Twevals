<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>twevals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace']
            }
          }
        }
      };
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      body { background: #09090b; color: #fafafa; }
      .dropdown-menu, .filters-panel, .columns-panel { display: none; }
      .dropdown-menu.active, .filters-panel.active, .columns-panel.active { display: block; }
      .filter-badge { display: none; }
      .filter-badge.active { display: flex; }
      .loading-indicator { display: none; }
      .loading-indicator.active { display: flex; }
      .spinner { width: 16px; height: 16px; border: 2px solid #27272a; border-top-color: #f59e0b; border-radius: 9999px; animation: spin 0.8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      #results-table thead th[aria-sort="ascending"]::after { content: " ↑"; color: #f59e0b; }
      #results-table thead th[aria-sort="descending"]::after { content: " ↓"; color: #f59e0b; }
      .col-resizer { position: absolute; right: 0; top: 0; width: 6px; height: 100%; cursor: col-resize; user-select: none; }
      .col-resizer:hover { background: linear-gradient(to right, transparent, rgba(245, 158, 11, 0.2)); }
      body.twevals-col-resize { cursor: col-resize !important; }
    </style>
  </head>
  <body class="min-h-screen bg-neutral-950 font-sans text-zinc-100">
    <div class="mx-auto w-full px-4 md:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 border-b border-zinc-900 py-6">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-amber-400 to-amber-600 font-mono text-lg font-bold text-neutral-900 shadow-lg shadow-amber-500/20">tw</div>
          <div class="font-mono text-2xl font-semibold tracking-tight text-zinc-100">twevals</div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div id="loading-indicator" class="loading-indicator items-center gap-2 text-sm text-zinc-400">
            <div class="spinner"></div>
            <span>Loading...</span>
          </div>

          <div class="search-wrapper relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <input id="search-input" type="search" class="search-input w-72 rounded-lg border border-zinc-800 bg-neutral-900 px-10 py-2 text-sm text-zinc-100 placeholder:text-zinc-500 focus:border-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/30" placeholder="Search results..." />
          </div>

          <div class="dropdown relative">
            <button id="actions-toggle" class="btn btn-primary inline-flex items-center gap-2 rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-neutral-900 shadow-sm transition hover:bg-amber-300">
              <span>Actions</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div id="actions-menu" class="dropdown-menu absolute right-0 mt-2 w-56 rounded-xl border border-zinc-800 bg-neutral-900/95 px-2 py-2 shadow-2xl backdrop-blur">
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 transition hover:bg-neutral-800/70" data-action="refresh">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                Refresh
              </button>
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 transition hover:bg-neutral-800/70" data-action="rerun">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Rerun Evals
              </button>
              <div class="my-1 h-px bg-zinc-800"></div>
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 transition hover:bg-neutral-800/70" data-action="export-json">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export JSON
              </button>
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-200 transition hover:bg-neutral-800/70" data-action="export-csv">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
              </button>
            </div>
          </div>

          <div class="dropdown relative">
            <button id="filters-toggle" class="btn btn-ghost relative inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-300 transition hover:border-amber-500/40 hover:text-amber-300">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              <span id="filters-count-badge" class="filter-badge absolute -right-2 -top-2 h-5 min-w-[18px] items-center justify-center rounded-full bg-amber-400 px-1 text-[11px] font-semibold text-neutral-900"></span>
            </button>
            <div id="filters-menu" class="filters-panel absolute right-0 mt-2 w-[420px] max-w-[90vw] rounded-2xl border border-zinc-800 bg-neutral-900/95 p-4 text-sm text-zinc-200 shadow-2xl backdrop-blur">
              <div class="filters-header mb-4 flex items-center justify-between">
                <span class="filters-title font-mono text-xs font-semibold uppercase tracking-wide text-zinc-300">Filters</span>
                <button id="clear-filters" class="filter-btn rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-xs text-zinc-300 transition hover:border-amber-500/40 hover:text-amber-300">Clear All</button>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-400">Score Key</div>
                <select id="key-select" class="filter-select w-full rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-100 focus:border-amber-500 focus:outline-none"></select>
              </div>

              <div class="filter-section mb-4" id="value-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-400">Value Condition</div>
                <div class="filter-row flex gap-2">
                  <select id="fv-op" class="filter-select w-20 rounded-lg border border-zinc-800 bg-neutral-900 px-2 py-2 text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">
                    <option value=">">&gt;</option>
                    <option value=">=">&gt;=</option>
                    <option value="<">&lt;</option>
                    <option value="<=">&lt;=</option>
                    <option value="==">=</option>
                    <option value="!=">!=</option>
                  </select>
                  <input id="fv-val" type="number" step="any" placeholder="value" class="filter-input flex-1 rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-100 focus:border-amber-500 focus:outline-none" />
                  <button id="add-fv" class="filter-btn rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-xs text-zinc-300 transition hover:border-amber-500/40 hover:text-amber-300">Add</button>
                </div>
              </div>

              <div class="filter-section mb-4" id="passed-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-400">Pass/Fail</div>
                <div class="filter-row flex gap-2">
                  <select id="fp-val" class="filter-select flex-1 rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">
                    <option value="true">Passed</option>
                    <option value="false">Failed</option>
                  </select>
                  <button id="add-fp" class="filter-btn rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-xs text-zinc-300 transition hover:border-amber-500/40 hover:text-amber-300">Add</button>
                </div>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-400">Has Annotation</div>
                <select id="fa-val" class="filter-select w-full rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">
                  <option value="any">Any</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="filter-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-400">Active Filters</div>
                <div id="active-filters" class="active-filters flex min-h-[28px] flex-wrap gap-2"></div>
              </div>
            </div>
          </div>

          <div class="dropdown relative">
            <button id="columns-toggle" class="btn btn-ghost inline-flex items-center gap-2 rounded-lg border border-zinc-800 bg-neutral-900 px-3 py-2 text-sm text-zinc-300 transition hover:border-amber-500/40 hover:text-amber-300">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </button>
            <div id="columns-menu" class="columns-panel absolute right-0 mt-2 w-64 rounded-2xl border border-zinc-800 bg-neutral-900/95 p-4 text-sm text-zinc-200 shadow-2xl backdrop-blur">
              <div class="filters-title mb-3 font-mono text-xs font-semibold uppercase tracking-wide text-zinc-300">Toggle Columns</div>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="function" checked class="h-4 w-4 accent-amber-500" /><span>Function</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="dataset" checked class="h-4 w-4 accent-amber-500" /><span>Dataset</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="labels" checked class="h-4 w-4 accent-amber-500" /><span>Labels</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="input" checked class="h-4 w-4 accent-amber-500" /><span>Input</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="reference" checked class="h-4 w-4 accent-amber-500" /><span>Reference</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="output" checked class="h-4 w-4 accent-amber-500" /><span>Output</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="error" class="h-4 w-4 accent-amber-500" /><span>Error</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="scores" checked class="h-4 w-4 accent-amber-500" /><span>Scores</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-200">
                <input type="checkbox" data-col="latency" checked class="h-4 w-4 accent-amber-500" /><span>Latency</span>
              </label>
              <div class="panel-actions mt-3 flex gap-2 border-t border-zinc-800 pt-3">
                <button id="reset-columns" class="flex-1 rounded-lg border border-zinc-800 bg-neutral-900 px-2 py-2 text-xs text-zinc-400 transition hover:border-amber-500/40 hover:text-amber-300">Reset Cols</button>
                <button id="reset-sorting" class="flex-1 rounded-lg border border-zinc-800 bg-neutral-900 px-2 py-2 text-xs text-zinc-400 transition hover:border-amber-500/40 hover:text-amber-300">Reset Sort</button>
                <button id="reset-widths" class="flex-1 rounded-lg border border-zinc-800 bg-neutral-900 px-2 py-2 text-xs text-zinc-400 transition hover:border-amber-500/40 hover:text-amber-300">Reset Width</button>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div id="results" hx-get="/results" hx-trigger="load" hx-swap="innerHTML" class="py-6"></div>
    </div>

    <script>
      // Storage keys
      const STORAGE_KEY = "twevals:hidden_columns";
      const SORT_STORAGE_KEY = "twevals:sort_state";
      const WIDTHS_STORAGE_KEY = "twevals:col_widths";
      const EXPANDED_ROW_KEY = "twevals:expanded_row";
      const FILTERS_STORAGE_KEY = "twevals:filters";

      // Helpers
      const DEFAULT_HIDDEN_COLS = ["error"];
      function getHiddenCols() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored === null) return DEFAULT_HIDDEN_COLS;
        try { return JSON.parse(stored); } catch { return DEFAULT_HIDDEN_COLS; }
      }
      function setHiddenCols(cols) { localStorage.setItem(STORAGE_KEY, JSON.stringify(cols)); }
      function getSortState() {
        try { return JSON.parse(localStorage.getItem(SORT_STORAGE_KEY) || "[]"); } catch { return []; }
      }
      function setSortState(state) { localStorage.setItem(SORT_STORAGE_KEY, JSON.stringify(state)); }
      function getColWidths() {
        try { return JSON.parse(localStorage.getItem(WIDTHS_STORAGE_KEY) || "{}"); } catch { return {}; }
      }
      function setColWidths(map) { localStorage.setItem(WIDTHS_STORAGE_KEY, JSON.stringify(map)); }
      function defaultFilters() { return { valueRules: [], passedRules: [], annotation: 'any' }; }
      function getFilters() {
        try { return JSON.parse(localStorage.getItem(FILTERS_STORAGE_KEY) || 'null') || defaultFilters(); } catch { return defaultFilters(); }
      }
      function setFilters(f) {
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(f));
        renderActiveFilters();
        applyAllFilters();
      }

      // Dropdown toggles
      function setupDropdown(toggleId, menuId, panelClass = 'dropdown-menu') {
        const toggle = document.getElementById(toggleId);
        const menu = document.getElementById(menuId);
        if (!toggle || !menu) return;

        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const isActive = menu.classList.contains('active');
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
          if (!isActive) menu.classList.add('active');
        });
      }

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
        }
      });

      setupDropdown('actions-toggle', 'actions-menu');
      setupDropdown('filters-toggle', 'filters-menu');
      setupDropdown('columns-toggle', 'columns-menu');

      // Render active filters
      function renderActiveFilters() {
        const f = getFilters();
        const ct = document.getElementById('active-filters');
        const badge = document.getElementById('filters-count-badge');
        if (!ct) return;
        ct.innerHTML = '';
        let count = 0;

        f.valueRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1 text-xs text-amber-200';
          el.innerHTML = `${r.key} ${r.op} ${r.value}<button class="ml-1 text-amber-200/80" onclick="removeValueRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        f.passedRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1 text-xs text-amber-200';
          el.innerHTML = `${r.key} = ${r.value ? 'pass' : 'fail'}<button class="ml-1 text-amber-200/80" onclick="removePassedRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        if (f.annotation && f.annotation !== 'any') {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1 text-xs text-amber-200';
          el.innerHTML = `annotation: ${f.annotation}<button class="ml-1 text-amber-200/80" onclick="removeAnnotationFilter()">×</button>`;
          ct.appendChild(el);
        }

        if (badge) {
          badge.textContent = count;
          badge.classList.toggle('active', count > 0);
        }
      }

      window.removeValueRule = (idx) => { const f = getFilters(); f.valueRules.splice(idx, 1); setFilters(f); };
      window.removePassedRule = (idx) => { const f = getFilters(); f.passedRules.splice(idx, 1); setFilters(f); };
      window.removeAnnotationFilter = () => { const f = getFilters(); f.annotation = 'any'; setFilters(f); };

      // Column visibility
      function applyColumnVisibility() {
        const hidden = new Set(getHiddenCols());
        const allCols = ["function", "dataset", "labels", "input", "output", "reference", "error", "scores", "latency"];
        for (const col of allCols) {
          const isHidden = hidden.has(col);
          document.querySelectorAll(`#results-table [data-col="${col}"]`).forEach((el) => {
            el.classList.toggle('hidden', isHidden);
          });
        }
        document.querySelectorAll('#columns-menu input[data-col]').forEach((cb) => {
          cb.checked = !hidden.has(cb.getAttribute("data-col"));
        });
      }

      document.querySelectorAll('#columns-menu input[data-col]').forEach((cb) => {
        cb.addEventListener("change", (e) => {
          const col = e.target.getAttribute("data-col");
          const hidden = new Set(getHiddenCols());
          if (e.target.checked) hidden.delete(col);
          else hidden.add(col);
          setHiddenCols([...hidden]);
          applyColumnVisibility();
        });
      });

      // Reset buttons
      document.getElementById("reset-columns")?.addEventListener("click", () => {
        setHiddenCols(DEFAULT_HIDDEN_COLS);
        applyColumnVisibility();
      });
      document.getElementById("reset-sorting")?.addEventListener("click", () => {
        setSortState([]);
        const table = document.getElementById("results-table");
        if (table) applySortState(table);
      });
      document.getElementById("reset-widths")?.addEventListener("click", () => {
        setColWidths({});
        document.querySelectorAll('#results-table thead th[data-col]').forEach((th) => {
          th.style.width = '';
        });
      });

      // Clear filters
      document.getElementById('clear-filters')?.addEventListener('click', () => setFilters(defaultFilters()));

      // Filter wiring
      (function wireFilters() {
        const keySelect = document.getElementById('key-select');
        const addFv = document.getElementById('add-fv');
        const fvOp = document.getElementById('fv-op');
        const fvVal = document.getElementById('fv-val');
        const addFp = document.getElementById('add-fp');
        const fpVal = document.getElementById('fp-val');
        const faVal = document.getElementById('fa-val');

        if (addFv) addFv.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          const v = parseFloat(fvVal.value);
          if (!k || Number.isNaN(v)) return;
          const f = getFilters();
          f.valueRules.push({ key: k, op: fvOp.value, value: v });
          setFilters(f);
          fvVal.value = '';
        });

        if (addFp) addFp.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          if (!k) return;
          const f = getFilters();
          f.passedRules.push({ key: k, value: fpVal.value === 'true' });
          setFilters(f);
        });

        if (faVal) faVal.addEventListener('change', () => {
          const f = getFilters();
          f.annotation = faVal.value;
          setFilters(f);
        });

        renderActiveFilters();
      })();

      // Score keys for filter dropdown
      function computeScoreKeys() {
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return { all: [], meta: {} };
        const keys = new Set();
        const meta = {};
        tbody.querySelectorAll("tr[data-row='detail']").forEach(tr => {
          let scores = [];
          try { scores = JSON.parse(tr.getAttribute('data-original-scores') || '[]') || []; } catch {}
          (scores || []).forEach(s => {
            const k = s && s.key; if (!k) return;
            keys.add(k);
            const m = meta[k] || (meta[k] = { hasNumeric: false, hasPassed: false });
            if (!Number.isNaN(parseFloat(s.value))) m.hasNumeric = true;
            if (s.passed === true || s.passed === false) m.hasPassed = true;
          });
        });
        return { all: Array.from(keys).sort(), meta };
      }

      function populateScoreKeySelects() {
        const ks = computeScoreKeys();
        const sel = document.getElementById('key-select');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        ks.all.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.textContent = k; sel.appendChild(opt); });
        if (current && ks.all.includes(current)) sel.value = current; else if (ks.all.length) sel.value = ks.all[0];
        updateFilterSectionsVisibility();
      }

      function updateFilterSectionsVisibility() {
        const sel = document.getElementById('key-select');
        const ks = computeScoreKeys();
        const k = sel?.value || '';
        const m = ks.meta[k] || { hasNumeric: false, hasPassed: false };
        document.getElementById('value-section')?.classList.toggle('hidden', !m.hasNumeric);
        document.getElementById('passed-section')?.classList.toggle('hidden', !m.hasPassed);
      }

      document.getElementById('key-select')?.addEventListener('change', updateFilterSectionsVisibility);

      // Sorting
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: "base" });

      function getCellValue(tr, col) {
        const td = tr.querySelector(`td[data-col="${col}"]`);
        if (!td) return "";
        const dv = td.getAttribute("data-value");
        return dv !== null ? dv : td.textContent.trim();
      }

      function parseValue(value, type) {
        if (type === "number") {
          const num = parseFloat(value);
          return isNaN(num) ? Number.POSITIVE_INFINITY : num;
        }
        return value;
      }

      function compareValues(a, b, type) {
        if (type === "number") return a - b;
        return collator.compare(a, b);
      }

      function applySortState(table) {
        const state = getSortState();
        const headers = table.querySelectorAll("thead th[data-col]");
        headers.forEach((th) => th.setAttribute("aria-sort", "none"));
        const tbody = table.querySelector("tbody");
        const mainRows = Array.from(tbody.querySelectorAll("tr[data-row='main']"));

        mainRows.forEach((tr, i) => {
          if (!tr.hasAttribute("data-orig-index")) tr.setAttribute("data-orig-index", String(i));
        });

        if (!state.length) {
          mainRows.slice().sort((a, b) =>
            Number(a.getAttribute("data-orig-index")) - Number(b.getAttribute("data-orig-index"))
          ).forEach((tr) => {
            const id = tr.getAttribute('data-row-id');
            const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
            tbody.appendChild(tr);
            if (detail) tbody.appendChild(detail);
          });
          return;
        }

        state.forEach((s) => {
          const th = table.querySelector(`thead th[data-col="${s.col}"]`);
          if (th) th.setAttribute("aria-sort", s.dir === "asc" ? "ascending" : "descending");
        });

        mainRows.slice().sort((ra, rb) => {
          for (const s of state) {
            const type = s.type || "string";
            const va = parseValue(getCellValue(ra, s.col), type);
            const vb = parseValue(getCellValue(rb, s.col), type);
            const cmp = compareValues(va, vb, type);
            if (cmp !== 0) return s.dir === "asc" ? cmp : -cmp;
          }
          return Number(ra.getAttribute("data-orig-index")) - Number(rb.getAttribute("data-orig-index"));
        }).forEach((tr) => {
          const id = tr.getAttribute('data-row-id');
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          tbody.appendChild(tr);
          if (detail) tbody.appendChild(detail);
        });
      }

      function toggleSort(table, col, type, multi) {
        let state = getSortState();
        const idx = state.findIndex((s) => s.col === col);
        if (multi) {
          if (idx === -1) state.push({ col, dir: "asc", type });
          else if (state[idx].dir === "asc") state[idx].dir = "desc";
          else state.splice(idx, 1);
        } else {
          if (idx === 0 && state[0].dir === "asc") state = [{ col, dir: "desc", type }];
          else if (idx === 0 && state[0].dir === "desc") state = [];
          else state = [{ col, dir: "asc", type }];
        }
        setSortState(state);
        applySortState(table);
      }

      document.addEventListener("click", function (e) {
        const th = e.target.closest("#results thead th[data-col]");
        if (!th) return;
        const table = document.getElementById("results-table");
        if (!table) return;
        const col = th.getAttribute("data-col");
        const type = th.getAttribute("data-type") || "string";
        toggleSort(table, col, type, e.shiftKey);
      });

      // Column widths - only set on th elements, table-layout:fixed handles the rest
      function applyColumnWidths(table) {
        if (!table) return;
        const widths = getColWidths();
        Object.keys(widths).forEach((col) => {
          const w = widths[col];
          if (!w) return;
          const th = table.querySelector(`thead th[data-col="${col}"]`);
          if (th) th.style.width = `${w}px`;
        });
      }

      function initResizableColumns(table) {
        if (!table) return;
        const widths = getColWidths();
        const ths = table.querySelectorAll('thead th[data-col]');
        ths.forEach((th) => {
          if (getComputedStyle(th).position === 'static') th.style.position = 'relative';
          if (th.querySelector('.col-resizer')) return;

          const handle = document.createElement('div');
          handle.className = 'col-resizer';
          th.appendChild(handle);

          let startX = 0, startWidth = 0;
          const colKey = th.getAttribute('data-col');
          const minWidth = 50, maxWidth = 500;

          function onMouseMove(e) {
            const dx = e.clientX - startX;
            let newW = Math.max(minWidth, Math.min(maxWidth, startWidth + dx));
            th.style.width = `${newW}px`;
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.classList.remove('twevals-col-resize');
            const map = getColWidths();
            map[colKey] = Math.round(th.getBoundingClientRect().width);
            setColWidths(map);
          }

          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.classList.add('twevals-col-resize');
          });

          handle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });

          const saved = widths[colKey];
          if (saved) {
            th.style.width = `${saved}px`;
          }
        });
      }

      // Search & filtering
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        let timer;
        searchInput.addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(applyAllFilters, 120);
        });
      }

      function compare(op, a, b) {
        if (op === '>') return a > b;
        if (op === '>=') return a >= b;
        if (op === '<') return a < b;
        if (op === '<=') return a <= b;
        if (op === '==') return a === b;
        if (op === '!=') return a !== b;
        return false;
      }

      function rowMatchesFilters(mainTr, detailTr) {
        const f = getFilters();
        if (f.annotation && f.annotation !== 'any') {
          const ann = (detailTr?.getAttribute('data-original-annotation') || '').trim();
          const has = !!ann;
          if (f.annotation === 'yes' && !has) return false;
          if (f.annotation === 'no' && has) return false;
        }
        let scores = [];
        try { scores = JSON.parse(detailTr?.getAttribute('data-original-scores') || '[]') || []; } catch {}
        for (const vr of (f.valueRules || [])) {
          const s = scores.find(x => x && x.key === vr.key);
          if (!s) return false;
          const val = parseFloat(s.value);
          if (Number.isNaN(val)) return false;
          if (!compare(vr.op, val, vr.value)) return false;
        }
        for (const pr of (f.passedRules || [])) {
          const s = scores.find(x => x && x.key === pr.key);
          if (!s) return false;
          if ((s.passed === true) !== (pr.value === true)) return false;
        }
        return true;
      }

      function applyAllFilters() {
        const q = (document.getElementById('search-input')?.value || '').toLowerCase().trim();
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return;
        const mains = tbody.querySelectorAll("tr[data-row='main']");
        mains.forEach((tr) => {
          const id = tr.getAttribute('data-row-id');
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          let show = true;
          if (q) {
            const text = tr.textContent.toLowerCase();
            if (!text.includes(q)) show = false;
          }
          if (show) show = rowMatchesFilters(tr, detail);
          tr.classList.toggle('hidden', !show);
          if (!show && detail && !detail.hasAttribute('hidden')) detail.setAttribute('hidden', '');
        });
        updateFilteredSummary();
      }

      function updateFilteredSummary() {
        const container = document.getElementById('filtered-summary');
        const table = document.getElementById('results-table');
        if (!container || !table) return;
        const tbody = table.querySelector('tbody');
        const mains = Array.from(tbody.querySelectorAll("tr[data-row='main']"));
        const visible = mains.filter(tr => !tr.classList.contains('hidden'));
        const hasActive = (() => {
          const f = getFilters();
          return (f.valueRules.length + f.passedRules.length + (f.annotation !== 'any' ? 1 : 0)) > 0 ||
            (document.getElementById('search-input')?.value || '').trim().length > 0;
        })();
        container.classList.toggle('hidden', !hasActive);
        if (!hasActive) return;
        document.getElementById('filtered-count-chip').textContent = `Filtered: ${visible.length}/${mains.length}`;

        let sum = 0, cnt = 0;
        visible.forEach(tr => {
          const td = tr.querySelector("td[data-col='latency']");
          const v = parseFloat(td?.getAttribute('data-value') || '');
          if (!Number.isNaN(v)) { sum += v; cnt += 1; }
        });
        const avgEl = document.getElementById('filtered-avg-latency');
        if (avgEl) avgEl.textContent = cnt > 0 ? `Avg: ${(sum / cnt).toFixed(2)}s` : 'Avg: —';

        const chipsEl = document.getElementById('filtered-score-chips');
        if (chipsEl) chipsEl.innerHTML = '';
        const map = {};
        visible.forEach(tr => {
          const id = tr.getAttribute('data-row-id');
          const det = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          let scores = [];
          try { scores = JSON.parse(det?.getAttribute('data-original-scores') || '[]') || []; } catch {}
          scores.forEach(s => {
            const key = s?.key; if (!key) return;
            const d = map[key] || (map[key] = { passed: 0, failed: 0, bool: 0, sum: 0, count: 0 });
            if (s.passed === true) { d.passed++; d.bool++; }
            else if (s.passed === false) { d.failed++; d.bool++; }
            const val = parseFloat(s.value);
            if (!Number.isNaN(val)) { d.sum += val; d.count += 1; }
          });
        });
        Object.entries(map).forEach(([k, d]) => {
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-zinc-800 bg-neutral-900 px-3 py-1 text-xs font-semibold text-zinc-200';
          if (d.bool > 0) {
            const total = d.passed + d.failed;
            if (d.passed === total) el.classList.add('border-emerald-500/40', 'bg-emerald-500/10', 'text-emerald-200');
            else if (d.passed === 0) el.classList.add('border-rose-500/40', 'bg-rose-500/10', 'text-rose-200');
            else el.classList.add('border-amber-500/40', 'bg-amber-500/10', 'text-amber-200');
            el.textContent = `${k}: ${d.passed}/${total}`;
          } else if (d.count > 0) {
            el.textContent = `${k}: ${(d.sum / d.count).toFixed(2)}`;
          } else return;
          chipsEl?.appendChild(el);
        });
      }

      // Expand/collapse
      function initExpandHandlers() {
        const container = document.getElementById('results');
        const tbody = document.querySelector('#results-table tbody');
        if (!container || !tbody) return;

        function closeAll() {
          tbody.querySelectorAll("tr[data-row='detail']").forEach((tr) => tr.setAttribute('hidden', ''));
          container.querySelectorAll('.expand-btn[aria-expanded="true"]').forEach((b) => {
            b.setAttribute('aria-expanded', 'false');
            b.querySelector('.icon').textContent = '▸';
          });
        }

        function openRow(rowId) {
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          const btn = container.querySelector(`.expand-btn[data-row-id='${rowId}']`);
          if (!detail || !btn) return;
          closeAll();
          detail.removeAttribute('hidden');
          btn.setAttribute('aria-expanded', 'true');
          btn.querySelector('.icon').textContent = '▾';
          try { localStorage.setItem(EXPANDED_ROW_KEY, rowId); } catch {}
        }

        container.querySelectorAll('.expand-btn').forEach((btn) => {
          const clone = btn.cloneNode(true);
          btn.parentNode.replaceChild(clone, btn);
          clone.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const rowId = clone.getAttribute('data-row-id');
            const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
            const isOpen = detail && !detail.hasAttribute('hidden');
            if (isOpen) {
              closeAll();
              try { localStorage.removeItem(EXPANDED_ROW_KEY); } catch {}
            } else {
              openRow(rowId);
            }
          });
        });

        window.restoreExpandedRow = function() {
          let rowId = null;
          try { rowId = localStorage.getItem(EXPANDED_ROW_KEY); } catch {}
          if (rowId) openRow(rowId);
        };
      }

      // Inline editing
      function initInlineEditing() {
        const container = document.getElementById('results');
        const table = document.getElementById('results-table');
        if (!container || !table) return;
        const runId = table.getAttribute('data-run-id') || 'latest';

        container.querySelectorAll('.edit-btn').forEach((btn) => {
          const rowId = btn.getAttribute('data-row-id');
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          const saveBtn = container.querySelector(`.save-btn[data-row-id='${rowId}']`);
          const cancelBtn = container.querySelector(`.cancel-btn[data-row-id='${rowId}']`);
          if (!detail || !saveBtn || !cancelBtn) return;

          btn.addEventListener('click', () => enterEdit(rowId));
          cancelBtn.addEventListener('click', () => exitEdit(rowId, true));
          saveBtn.addEventListener('click', () => saveEdit(rowId, runId));
        });

        function toggleEditUI(detail, editing) {
          detail.querySelectorAll('.view-section').forEach((el) => el.classList.toggle('hidden', editing));
          detail.querySelectorAll('.edit-section').forEach((el) => el.classList.toggle('hidden', !editing));
          const rowId = detail.getAttribute('data-row-id');
          container.querySelector(`.edit-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', editing);
          container.querySelector(`.save-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', !editing);
          container.querySelector(`.cancel-btn[data-row-id='${rowId}']`)?.classList.toggle('hidden', !editing);
        }

        function enterEdit(rowId) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          toggleEditUI(detail, true);
          const ds = detail.getAttribute('data-original-dataset') || '';
          const lbls = JSON.parse(detail.getAttribute('data-original-labels') || '[]');
          const md = JSON.parse(detail.getAttribute('data-original-metadata') || 'null');
          const ann = detail.getAttribute('data-original-annotation') || '';
          const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
          const lbInput = detail.querySelector(`#labels-input-${rowId}`);
          const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
          const annInput = detail.querySelector(`#annotation-input-${rowId}`);
          if (dsInput) dsInput.value = ds;
          if (lbInput) lbInput.value = (lbls || []).join(', ');
          if (mdInput) mdInput.value = md ? JSON.stringify(md, null, 2) : '';
          if (annInput) annInput.value = ann;
        }

        function exitEdit(rowId, resetValues) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          if (resetValues) {
            const ds = detail.getAttribute('data-original-dataset') || '';
            const lbls = JSON.parse(detail.getAttribute('data-original-labels') || '[]');
            const md = JSON.parse(detail.getAttribute('data-original-metadata') || 'null');
            const ann = detail.getAttribute('data-original-annotation') || '';
            const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
            const lbInput = detail.querySelector(`#labels-input-${rowId}`);
            const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
            const annInput = detail.querySelector(`#annotation-input-${rowId}`);
            if (dsInput) dsInput.value = ds;
            if (lbInput) lbInput.value = (lbls || []).join(', ');
            if (mdInput) mdInput.value = md ? JSON.stringify(md, null, 2) : '';
            if (annInput) annInput.value = ann;

            const scores = JSON.parse(detail.getAttribute('data-original-scores') || '[]');
            const editor = detail.querySelector(`#scores-editor-${rowId}`);
            if (editor) {
              const cards = editor.querySelectorAll('.score-card');
              cards.forEach((card, i) => {
                const s = scores[i];
                if (!s) return;
                const k = card.querySelector('[name="score-key"]');
                const v = card.querySelector('[name="score-value"]');
                const p = card.querySelector('[name="score-passed"]');
                const n = card.querySelector('[name="score-notes"]');
                if (k) k.value = s.key || '';
                if (v) v.value = s.value ?? '';
                if (p) p.value = s.passed === true ? 'true' : s.passed === false ? 'false' : '';
                if (n) n.value = s.notes ?? '';
              });
            }
          }
          toggleEditUI(detail, false);
        }

        async function saveEdit(rowId, runId) {
          const detail = container.querySelector(`tr[data-row='detail'][data-row-id='${rowId}']`);
          if (!detail) return;
          const dsInput = detail.querySelector(`#dataset-input-${rowId}`);
          const lbInput = detail.querySelector(`#labels-input-${rowId}`);
          const mdInput = detail.querySelector(`#metadata-input-${rowId}`);
          const editor = detail.querySelector(`#scores-editor-${rowId}`);

          let metadata = null;
          const mdRaw = (mdInput && mdInput.value.trim()) || '';
          if (mdRaw) {
            try { metadata = JSON.parse(mdRaw); }
            catch { alert('Invalid metadata JSON'); return; }
          }

          const scorePayload = [];
          if (editor) {
            editor.querySelectorAll('.score-card').forEach((card) => {
              const k = card.querySelector('[name="score-key"]').value.trim();
              const vRaw = card.querySelector('[name="score-value"]').value.trim();
              const pVal = card.querySelector('[name="score-passed"]').value;
              const nVal = card.querySelector('[name="score-notes"]').value.trim();
              const s = { key: k };
              if (vRaw !== '') {
                const num = Number(vRaw);
                if (!Number.isNaN(num)) s.value = num;
              }
              if (pVal === 'true') s.passed = true;
              else if (pVal === 'false') s.passed = false;
              if (nVal !== '') s.notes = nVal;
              if (s.key && (s.value !== undefined || s.passed !== undefined || s.notes !== undefined)) {
                scorePayload.push(s);
              }
            });
          }

          const annInput = detail.querySelector(`#annotation-input-${rowId}`);
          const annValue = annInput ? annInput.value.trim() : '';

          const payload = {
            dataset: dsInput ? dsInput.value.trim() : undefined,
            labels: lbInput ? lbInput.value.split(',').map(x => x.trim()).filter(Boolean) : undefined,
            result: { metadata, scores: scorePayload, annotation: annValue || null }
          };

          try {
            const resp = await fetch(`/api/runs/${runId}/results/${rowId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error(await resp.text());
          } catch (e) {
            alert(`Save failed: ${e}`);
            return;
          }

          try { localStorage.setItem(EXPANDED_ROW_KEY, rowId); } catch {}
          htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
        }
      }

      // Actions menu
      function wireActionsMenu() {
        const table = document.getElementById('results-table');
        const runId = table ? (table.getAttribute('data-run-id') || 'latest') : 'latest';
        const menu = document.getElementById('actions-menu');
        if (!menu) return;

        menu.querySelectorAll('[data-action]').forEach((el) => {
          el.onclick = async (e) => {
            const act = e.currentTarget.getAttribute('data-action');
            menu.classList.remove('active');
            if (act === 'refresh') {
              showLoading();
              htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
            } else if (act === 'rerun') {
              try {
                showLoading();
                const resp = await fetch('/api/runs/rerun', { method: 'POST' });
                if (!resp.ok) throw new Error(await resp.text());
                htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
              } catch (e) {
                alert('Rerun failed: ' + e);
              } finally {
                hideLoading();
              }
            } else if (act === 'export-json') {
              window.location.href = `/api/runs/${runId}/export/json`;
            } else if (act === 'export-csv') {
              window.location.href = `/api/runs/${runId}/export/csv`;
            }
          };
        });
      }

      // Loading state
      function showLoading(evt) {
        const silent = evt?.detail?.requestConfig?.headers?.['X-Silent-Refresh'];
        if (silent) return;
        document.getElementById('loading-indicator')?.classList.add('active');
      }
      function hideLoading(evt) {
        const silent = evt?.detail?.requestConfig?.headers?.['X-Silent-Refresh'];
        if (silent) return;
        document.getElementById('loading-indicator')?.classList.remove('active');
      }
      document.body.addEventListener('htmx:beforeRequest', showLoading);
      document.body.addEventListener('htmx:afterSwap', hideLoading);
      document.body.addEventListener('htmx:responseError', hideLoading);

      // Copy to clipboard
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.copy-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-copy');
        const pre = document.getElementById(id);
        if (!pre) return;
        try {
          await navigator.clipboard.writeText(pre.innerText);
          const copyIcon = btn.querySelector('.copy-icon');
          const checkIcon = btn.querySelector('.check-icon');
          if (copyIcon && checkIcon) {
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');
            setTimeout(() => { copyIcon.classList.remove('hidden'); checkIcon.classList.add('hidden'); }, 900);
          }
        } catch {
          alert('Copy failed');
        }
      });

      // Lightweight live refresh when runs are still pending
      let liveUpdateTimer = null;
      function scheduleLiveRefresh() {
        if (liveUpdateTimer) {
          clearTimeout(liveUpdateTimer);
          liveUpdateTimer = null;
        }
        const hasPending = document.querySelector('[data-status="pending"], [data-status="running"]');
        if (!hasPending) return;
        liveUpdateTimer = setTimeout(() => {
          htmx.ajax('GET', '/results', {
            target: '#results',
            swap: 'innerHTML',
            headers: { 'X-Silent-Refresh': '1' },
          });
        }, 1200);
      }

      // HTMX after swap handler
      document.addEventListener("htmx:afterSwap", function (e) {
        if (e.target.id === "results") {
          const table = document.getElementById("results-table");
          if (table) {
            applySortState(table);
            applyColumnWidths(table);
            initResizableColumns(table);
          }
          applyColumnVisibility();
          initExpandHandlers();
          initInlineEditing();
          if (window.restoreExpandedRow) restoreExpandedRow();
          wireActionsMenu();
          try { populateScoreKeySelects(); applyAllFilters(); } catch {}
          scheduleLiveRefresh();
        }
      });
    </script>
  </body>
</html>
