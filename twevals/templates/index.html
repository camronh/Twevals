<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>twevals</title>
    <link rel="icon" type="image/png" href="/static/logo.png" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace']
            }
          }
        }
      };
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
      .dropdown-menu, .filters-panel, .columns-panel { display: none; }
      .dropdown-menu.active, .filters-panel.active, .columns-panel.active { display: block; }
      .filter-badge { display: none; }
      .filter-badge.active { display: flex; }
      .loading-indicator { display: none; }
      .loading-indicator.active { display: flex; }
      .spinner { width: 16px; height: 16px; border: 2px solid currentColor; border-top-color: #2563eb; border-radius: 9999px; animation: spin 0.8s linear infinite; opacity: 0.3; }
      .spinner { border-top-color: #2563eb; }
      @keyframes spin { to { transform: rotate(360deg); } }
      /* Smooth HTMX swaps to prevent flicker */
      #results { min-height: 200px; }
      .htmx-swapping { opacity: 1; }
      .htmx-settling { opacity: 1; }
      #results-table thead th[aria-sort="ascending"]::after { content: " ↑"; color: #2563eb; }
      #results-table thead th[aria-sort="descending"]::after { content: " ↓"; color: #2563eb; }
      .col-resizer { position: absolute; right: 0; top: 0; width: 6px; height: 100%; cursor: col-resize; user-select: none; }
      .col-resizer:hover { background: linear-gradient(to right, transparent, rgba(37, 99, 235, 0.2)); }
      body.twevals-col-resize { cursor: col-resize !important; }
      /* Custom checkbox styling */
      .row-checkbox, #select-all-checkbox {
        appearance: none;
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border: 1.5px solid #a1a1aa;
        border-radius: 4px;
        background: transparent;
        cursor: pointer;
        transition: all 0.15s ease;
        position: relative;
        vertical-align: middle;
      }
      .row-checkbox:hover, #select-all-checkbox:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.08);
      }
      .row-checkbox:checked, #select-all-checkbox:checked {
        background: #3b82f6;
        border-color: #3b82f6;
      }
      .row-checkbox:checked::after, #select-all-checkbox:checked::after {
        content: '';
        position: absolute;
        left: 4.5px;
        top: 1.5px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
      }
      .row-checkbox:indeterminate, #select-all-checkbox:indeterminate {
        background: #3b82f6;
        border-color: #3b82f6;
      }
      .row-checkbox:indeterminate::after, #select-all-checkbox:indeterminate::after {
        content: '';
        position: absolute;
        left: 3px;
        top: 6px;
        width: 8px;
        height: 2px;
        background: white;
        border-radius: 1px;
      }
      .row-checkbox:focus, #select-all-checkbox:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }
      .dark .row-checkbox, .dark #select-all-checkbox {
        border-color: #52525b;
      }
      .dark .row-checkbox:hover, .dark #select-all-checkbox:hover {
        border-color: #60a5fa;
        background: rgba(96, 165, 250, 0.1);
      }
      /* Expanded row styling */
      tr[data-row="main"].expanded {
        background: rgba(59, 130, 246, 0.04);
      }
      .dark tr[data-row="main"].expanded {
        background: rgba(59, 130, 246, 0.08);
      }
      tr[data-row="main"].expanded td {
        vertical-align: top;
      }
      tr[data-row="main"].expanded .line-clamp-2 {
        -webkit-line-clamp: unset;
        line-clamp: unset;
        white-space: pre-wrap;
      }
      tr[data-row="main"].expanded .expand-chevron {
        transform: rotate(90deg);
      }
      .expand-chevron {
        transition: transform 0.15s ease;
      }
      /* Scores wrap when row expanded */
      tr[data-row="main"].expanded td[data-col="scores"] > div {
        flex-wrap: wrap;
        overflow: visible;
      }
      tr[data-row="main"].expanded .score-badge {
        max-width: unset;
      }
      tr[data-row="main"].expanded .score-extra {
        display: inline-flex;
      }
      tr[data-row="main"].expanded .score-overflow {
        display: none;
      }
      /* Prevent cell content overflow */
      #results-table td {
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 0; /* Forces table-fixed cells to respect width */
      }
    </style>
    <script>
      // Apply saved theme before page renders to prevent flash
      (function() {
        const saved = localStorage.getItem('twevals:theme');
        if (saved === 'light') document.documentElement.classList.remove('dark');
      })();
    </script>
  </head>
  <body class="min-h-screen bg-blue-50/40 font-sans text-zinc-800 dark:bg-neutral-950 dark:text-zinc-100">
    <div class="mx-auto w-full px-4 md:px-6">
      <header class="sticky top-0 z-30 flex flex-wrap items-center justify-between gap-4 border-b border-blue-200/60 bg-blue-50/95 py-4 backdrop-blur-sm dark:border-zinc-900 dark:bg-neutral-950/95">
        <div class="flex items-center gap-3">
          <img src="/static/logo.png" alt="twevals" class="h-10 w-10" />
          <div class="font-mono text-2xl font-semibold tracking-tight text-zinc-900 dark:text-zinc-100">twevals</div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div id="loading-indicator" class="loading-indicator items-center gap-2 text-sm text-zinc-400">
            <div class="spinner"></div>
            <span>Loading...</span>
          </div>

          <div class="search-wrapper relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <input id="search-input" type="search" class="search-input w-72 rounded-lg border border-blue-200 bg-white px-10 py-2 text-sm text-zinc-800 shadow-sm placeholder:text-zinc-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100 dark:shadow-none dark:placeholder:text-zinc-500" placeholder="Search results..." />
          </div>

          <div class="dropdown relative">
            <button id="actions-toggle" class="btn btn-primary inline-flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 text-sm font-semibold text-white shadow-md shadow-blue-500/25 transition hover:bg-blue-600 hover:shadow-lg hover:shadow-blue-500/30 dark:bg-blue-600 dark:text-white dark:shadow-none dark:hover:bg-blue-500">
              <span>Actions</span>
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M6 9l6 6 6-6"/>
              </svg>
            </button>
            <div id="actions-menu" class="dropdown-menu absolute right-0 z-50 mt-2 w-56 rounded-xl border border-blue-200/80 bg-white px-2 py-2 shadow-xl shadow-blue-900/10 dark:border-zinc-800 dark:bg-neutral-900 dark:shadow-2xl dark:shadow-black/20">
              <button id="theme-toggle" class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-700 transition hover:bg-blue-50 hover:text-blue-800 dark:text-zinc-200 dark:hover:bg-neutral-800/70 dark:hover:text-zinc-200">
                <svg id="theme-icon-sun" class="hidden dark:block" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="5"/>
                  <line x1="12" y1="1" x2="12" y2="3"/>
                  <line x1="12" y1="21" x2="12" y2="23"/>
                  <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                  <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                  <line x1="1" y1="12" x2="3" y2="12"/>
                  <line x1="21" y1="12" x2="23" y2="12"/>
                  <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                  <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg id="theme-icon-moon" class="block dark:hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
                </svg>
                <span id="theme-label" class="dark:hidden">Dark Mode</span>
                <span id="theme-label-dark" class="hidden dark:inline">Light Mode</span>
              </button>
              <div class="my-1 h-px bg-zinc-200 dark:bg-zinc-800"></div>
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-700 transition hover:bg-blue-50 hover:text-blue-800 dark:text-zinc-200 dark:hover:bg-neutral-800/70 dark:hover:text-zinc-200" data-action="export-json">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export JSON
              </button>
              <button class="dropdown-item flex w-full items-center gap-3 rounded-lg px-3 py-2 text-sm text-zinc-700 transition hover:bg-blue-50 hover:text-blue-800 dark:text-zinc-200 dark:hover:bg-neutral-800/70 dark:hover:text-zinc-200" data-action="export-csv">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export CSV
              </button>
            </div>
          </div>

          <button id="settings-toggle" class="btn btn-ghost inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-600 shadow-sm transition hover:border-blue-400 hover:bg-blue-50 hover:text-blue-700 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:shadow-none dark:hover:border-blue-500/40 dark:hover:bg-transparent dark:hover:text-blue-400" title="Settings">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
          </button>

          <div class="dropdown relative">
            <button id="filters-toggle" class="btn btn-ghost relative inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-600 shadow-sm transition hover:border-blue-400 hover:bg-blue-50 hover:text-blue-700 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:shadow-none dark:hover:border-blue-500/40 dark:hover:bg-transparent dark:hover:text-blue-400">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              <span id="filters-count-badge" class="filter-badge absolute -right-2 -top-2 h-5 min-w-[18px] items-center justify-center rounded-full bg-blue-600 px-1 text-[11px] font-semibold text-neutral-900"></span>
            </button>
            <div id="filters-menu" class="filters-panel absolute right-0 z-50 mt-2 w-[420px] max-w-[90vw] rounded-2xl border border-blue-200/80 bg-white p-4 text-sm text-zinc-700 shadow-xl shadow-blue-900/10 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-200 dark:shadow-2xl dark:shadow-black/20">
              <div class="filters-header mb-4 flex items-center justify-between">
                <span class="filters-title font-mono text-xs font-semibold uppercase tracking-wide text-blue-700 dark:text-zinc-300">Filters</span>
                <button id="clear-filters" class="filter-btn rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:hover:text-blue-400">Clear All</button>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Score Key</div>
                <select id="key-select" class="filter-select w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100"></select>
              </div>

              <div class="filter-section mb-4" id="value-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Value Condition</div>
                <div class="filter-row flex gap-2">
                  <select id="fv-op" class="filter-select w-20 rounded-lg border border-blue-200 bg-white px-2 py-2 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100">
                    <option value=">">&gt;</option>
                    <option value=">=">&gt;=</option>
                    <option value="<">&lt;</option>
                    <option value="<=">&lt;=</option>
                    <option value="==">=</option>
                    <option value="!=">!=</option>
                  </select>
                  <input id="fv-val" type="number" step="any" placeholder="value" class="filter-input flex-1 rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100" />
                  <button id="add-fv" class="filter-btn rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:hover:text-blue-400">Add</button>
                </div>
              </div>

              <div class="filter-section mb-4" id="passed-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Pass/Fail</div>
                <div class="filter-row flex gap-2">
                  <select id="fp-val" class="filter-select flex-1 rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100">
                    <option value="true">Passed</option>
                    <option value="false">Failed</option>
                  </select>
                  <button id="add-fp" class="filter-btn rounded-lg border border-blue-200 bg-blue-50 px-3 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:hover:text-blue-400">Add</button>
                </div>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Has Annotation</div>
                <select id="fa-val" class="filter-select w-full rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-100">
                  <option value="any">Any</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Dataset</div>
                <div id="dataset-pills" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="filter-section mb-4">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-blue-700/70 dark:text-zinc-400">Labels</div>
                <div id="label-pills" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="filter-section">
                <div class="filter-label mb-2 text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Active Filters</div>
                <div id="active-filters" class="active-filters flex min-h-[28px] flex-wrap gap-2"></div>
              </div>
            </div>
          </div>

          <div class="dropdown relative">
            <button id="columns-toggle" class="btn btn-ghost inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-white px-3 py-2 text-sm text-zinc-600 shadow-sm transition hover:border-blue-400 hover:bg-blue-50 hover:text-blue-700 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-300 dark:shadow-none dark:hover:border-blue-500/40 dark:hover:bg-transparent dark:hover:text-blue-400">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/>
                <rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/>
                <rect x="3" y="14" width="7" height="7"/>
              </svg>
            </button>
            <div id="columns-menu" class="columns-panel absolute right-0 z-50 mt-2 w-64 rounded-2xl border border-blue-200/80 bg-white p-4 text-sm text-zinc-700 shadow-xl shadow-blue-900/10 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-200 dark:shadow-2xl dark:shadow-black/20">
              <div class="filters-title mb-3 font-mono text-xs font-semibold uppercase tracking-wide text-blue-700 dark:text-zinc-300">Toggle Columns</div>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="function" checked class="h-4 w-4 accent-blue-500" /><span>Function</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="input" checked class="h-4 w-4 accent-blue-500" /><span>Input</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="reference" checked class="h-4 w-4 accent-blue-500" /><span>Reference</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="output" checked class="h-4 w-4 accent-blue-500" /><span>Output</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="error" class="h-4 w-4 accent-blue-500" /><span>Error</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="scores" checked class="h-4 w-4 accent-blue-500" /><span>Scores</span>
              </label>
              <label class="column-toggle flex items-center gap-3 py-1 text-sm text-zinc-700 dark:text-zinc-200">
                <input type="checkbox" data-col="latency" checked class="h-4 w-4 accent-blue-500" /><span>Latency</span>
              </label>
              <div class="panel-actions mt-3 flex gap-2 border-t border-blue-200/60 pt-3 dark:border-zinc-800">
                <button id="reset-columns" class="flex-1 rounded-lg border border-blue-200 bg-blue-50 px-2 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-400 dark:hover:text-blue-400">Reset Cols</button>
                <button id="reset-sorting" class="flex-1 rounded-lg border border-blue-200 bg-blue-50 px-2 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-400 dark:hover:text-blue-400">Reset Sort</button>
                <button id="reset-widths" class="flex-1 rounded-lg border border-blue-200 bg-blue-50 px-2 py-2 text-xs text-blue-700 transition hover:bg-blue-100 dark:border-zinc-800 dark:bg-neutral-900 dark:text-zinc-400 dark:hover:text-blue-400">Reset Width</button>
              </div>
            </div>
          </div>

          <!-- Run Controls -->
          <div id="run-controls" class="flex items-center gap-2">
            <button id="play-btn" class="inline-flex items-center gap-1.5 rounded-lg bg-emerald-500 px-3 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-emerald-600 dark:bg-emerald-600 dark:hover:bg-emerald-500" title="Rerun evals">
              <svg class="play-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"/>
              </svg>
              <svg class="stop-icon hidden" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="6" width="12" height="12"/>
              </svg>
              <span id="play-btn-text">Run</span>
            </button>
          </div>
        </div>
      </header>

      <div id="results" hx-get="/results" hx-trigger="load" hx-swap="innerHTML" class="py-6"></div>
    </div>

    <!-- Footer -->
    <footer class="border-t border-blue-200/60 bg-blue-50/30 py-4 dark:border-zinc-800/60 dark:bg-transparent">
      <div class="mx-auto flex max-w-screen-2xl items-center justify-center gap-6 px-6 text-sm text-zinc-500 dark:text-zinc-400">
        <a href="https://github.com/camronh/Twevals" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 transition hover:text-blue-600 dark:hover:text-blue-400">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          <span>GitHub</span>
        </a>
        <a href="https://twevals.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 transition hover:text-blue-600 dark:hover:text-blue-400">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          <span>Docs</span>
        </a>
      </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/50" id="settings-backdrop"></div>
      <div class="absolute left-1/2 top-1/2 w-full max-w-md -translate-x-1/2 -translate-y-1/2 rounded-2xl border border-blue-200/80 bg-white p-6 shadow-2xl dark:border-zinc-800 dark:bg-neutral-900">
        <div class="mb-6 flex items-center justify-between">
          <h2 class="font-mono text-lg font-semibold text-zinc-900 dark:text-zinc-100">Settings</h2>
          <button id="settings-close" class="text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>

        <form id="settings-form" class="space-y-4">
          <div class="flex items-center justify-between">
            <label class="text-sm text-zinc-700 dark:text-zinc-300">Concurrency</label>
            <input type="number" name="concurrency" min="0" class="w-24 rounded-lg border border-blue-200 bg-white px-3 py-1.5 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-700 dark:bg-neutral-800 dark:text-zinc-100" />
          </div>
          <div class="flex items-center justify-between">
            <label class="text-sm text-zinc-700 dark:text-zinc-300">Results directory</label>
            <input type="text" name="results_dir" class="w-40 rounded-lg border border-blue-200 bg-white px-3 py-1.5 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-700 dark:bg-neutral-800 dark:text-zinc-100" />
          </div>
          <div class="flex items-center justify-between">
            <label class="text-sm text-zinc-700 dark:text-zinc-300">Timeout (seconds)</label>
            <input type="number" name="timeout" min="0" step="0.1" class="w-24 rounded-lg border border-blue-200 bg-white px-3 py-1.5 text-sm text-zinc-800 focus:border-blue-500 focus:outline-none dark:border-zinc-700 dark:bg-neutral-800 dark:text-zinc-100" placeholder="none" />
          </div>

          <div class="flex justify-end gap-3 border-t border-blue-200/60 pt-4 dark:border-zinc-800">
            <button type="button" id="settings-cancel" class="rounded-lg border border-blue-200 bg-white px-4 py-2 text-sm text-zinc-600 transition hover:bg-blue-50 dark:border-zinc-700 dark:bg-neutral-800 dark:text-zinc-300 dark:hover:bg-neutral-700">Cancel</button>
            <button type="submit" class="rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500">Save</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Storage keys (persisted)
      const STORAGE_KEY = "twevals:hidden_columns";
      const WIDTHS_STORAGE_KEY = "twevals:col_widths";
      const THEME_STORAGE_KEY = "twevals:theme";

      // Theme toggle
      document.getElementById('theme-toggle')?.addEventListener('click', () => {
        const html = document.documentElement;
        const isDark = html.classList.contains('dark');
        if (isDark) {
          html.classList.remove('dark');
          localStorage.setItem(THEME_STORAGE_KEY, 'light');
        } else {
          html.classList.add('dark');
          localStorage.setItem(THEME_STORAGE_KEY, 'dark');
        }
      });

      // In-memory state (not persisted)
      let _sortState = [];
      let _filters = defaultFilters();
      const selectedIndices = new Set();

      // Helpers
      const DEFAULT_HIDDEN_COLS = ["error"];
      function getHiddenCols() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored === null) return DEFAULT_HIDDEN_COLS;
        try { return JSON.parse(stored); } catch { return DEFAULT_HIDDEN_COLS; }
      }
      function setHiddenCols(cols) { localStorage.setItem(STORAGE_KEY, JSON.stringify(cols)); }
      function getSortState() { return _sortState; }
      function setSortState(state) { _sortState = state; }
      function getColWidths() {
        try { return JSON.parse(localStorage.getItem(WIDTHS_STORAGE_KEY) || "{}"); } catch { return {}; }
      }
      function setColWidths(map) { localStorage.setItem(WIDTHS_STORAGE_KEY, JSON.stringify(map)); }
      function defaultFilters() { return { valueRules: [], passedRules: [], annotation: 'any', selectedDatasets: [], selectedLabels: [] }; }
      function getFilters() { return _filters; }
      function setFilters(f) {
        _filters = f || defaultFilters();
        sessionStorage.setItem('twevals:filters', JSON.stringify(_filters));
        renderActiveFilters();
        applyAllFilters();
      }

      // Selection management
      let _isRunning = false;

      function updateSelectionUI() {
        const count = selectedIndices.size;
        const playBtnText = document.getElementById('play-btn-text');
        if (playBtnText && !_isRunning) {
          playBtnText.textContent = count ? `Run (${count})` : 'Run';
        }
        updateSelectAllState();
      }

      function setRunningState(running) {
        _isRunning = running;
        const btn = document.getElementById('play-btn');
        const playIcon = btn?.querySelector('.play-icon');
        const stopIcon = btn?.querySelector('.stop-icon');
        const btnText = document.getElementById('play-btn-text');
        if (running) {
          btn?.classList.remove('bg-emerald-500', 'hover:bg-emerald-600', 'dark:bg-emerald-600', 'dark:hover:bg-emerald-500');
          btn?.classList.add('bg-rose-500', 'hover:bg-rose-600', 'dark:bg-rose-600', 'dark:hover:bg-rose-500');
          playIcon?.classList.add('hidden');
          stopIcon?.classList.remove('hidden');
          if (btnText) btnText.textContent = 'Stop';
        } else {
          btn?.classList.remove('bg-rose-500', 'hover:bg-rose-600', 'dark:bg-rose-600', 'dark:hover:bg-rose-500');
          btn?.classList.add('bg-emerald-500', 'hover:bg-emerald-600', 'dark:bg-emerald-600', 'dark:hover:bg-emerald-500');
          playIcon?.classList.remove('hidden');
          stopIcon?.classList.add('hidden');
          updateSelectionUI();
        }
      }

      function checkRunningState() {
        const hasPending = document.querySelector('[data-status="pending"], [data-status="running"]');
        setRunningState(!!hasPending);
      }

      function updateSelectAllState() {
        const selectAll = document.getElementById('select-all-checkbox');
        if (!selectAll) return;
        const visibleRows = getVisibleMainRows();
        if (visibleRows.length === 0) {
          selectAll.checked = false;
          selectAll.indeterminate = false;
          return;
        }
        const visibleSelected = visibleRows.filter(r => selectedIndices.has(parseInt(r.dataset.rowId))).length;
        selectAll.checked = visibleSelected === visibleRows.length;
        selectAll.indeterminate = visibleSelected > 0 && visibleSelected < visibleRows.length;
      }

      function getVisibleMainRows() {
        return Array.from(document.querySelectorAll('tr[data-row="main"]:not(.hidden)'));
      }

      function syncCheckboxesToSelection() {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
          const idx = parseInt(cb.dataset.rowId);
          cb.checked = selectedIndices.has(idx);
        });
        updateSelectionUI();
      }

      // Dropdown toggles
      function setupDropdown(toggleId, menuId, panelClass = 'dropdown-menu') {
        const toggle = document.getElementById(toggleId);
        const menu = document.getElementById(menuId);
        if (!toggle || !menu) return;

        toggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const isActive = menu.classList.contains('active');
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
          if (!isActive) menu.classList.add('active');
        });
      }

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown') && !e.target.closest('.filters-panel') && !e.target.closest('.columns-panel')) {
          document.querySelectorAll('.dropdown-menu.active, .filters-panel.active, .columns-panel.active').forEach(m => m.classList.remove('active'));
        }
      });

      setupDropdown('actions-toggle', 'actions-menu');
      setupDropdown('filters-toggle', 'filters-menu');
      setupDropdown('columns-toggle', 'columns-menu');

      // Render active filters
      function renderActiveFilters() {
        const f = getFilters();
        const ct = document.getElementById('active-filters');
        const badge = document.getElementById('filters-count-badge');
        if (!ct) return;
        ct.innerHTML = '';
        let count = 0;

        f.valueRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-blue-500/30 bg-blue-500/10 px-3 py-1 text-xs text-blue-200';
          el.innerHTML = `${r.key} ${r.op} ${r.value}<button class="ml-1 text-blue-200/80" onclick="removeValueRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        f.passedRules.forEach((r, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-blue-500/30 bg-blue-500/10 px-3 py-1 text-xs text-blue-200';
          el.innerHTML = `${r.key} = ${r.value ? 'pass' : 'fail'}<button class="ml-1 text-blue-200/80" onclick="removePassedRule(${idx})">×</button>`;
          ct.appendChild(el);
        });

        if (f.annotation && f.annotation !== 'any') {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-blue-500/30 bg-blue-500/10 px-3 py-1 text-xs text-blue-200';
          el.innerHTML = `annotation: ${f.annotation}<button class="ml-1 text-blue-200/80" onclick="removeAnnotationFilter()">×</button>`;
          ct.appendChild(el);
        }

        (f.selectedDatasets || []).forEach((ds, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-emerald-500/30 bg-emerald-500/10 px-3 py-1 text-xs text-emerald-200';
          el.innerHTML = `dataset: ${ds}<button class="ml-1 text-emerald-200/80" onclick="removeDatasetFilter(${idx})">×</button>`;
          ct.appendChild(el);
        });

        (f.selectedLabels || []).forEach((la, idx) => {
          count++;
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-amber-500/30 bg-amber-500/10 px-3 py-1 text-xs text-amber-200';
          el.innerHTML = `label: ${la}<button class="ml-1 text-amber-200/80" onclick="removeLabelFilter(${idx})">×</button>`;
          ct.appendChild(el);
        });

        if (badge) {
          badge.textContent = count;
          badge.classList.toggle('active', count > 0);
        }
      }

      window.removeValueRule = (idx) => { const f = getFilters(); f.valueRules.splice(idx, 1); setFilters(f); };
      window.removePassedRule = (idx) => { const f = getFilters(); f.passedRules.splice(idx, 1); setFilters(f); };
      window.removeAnnotationFilter = () => { const f = getFilters(); f.annotation = 'any'; setFilters(f); };
      window.removeDatasetFilter = (idx) => { const f = getFilters(); f.selectedDatasets.splice(idx, 1); setFilters(f); populateDatasetLabelPills(); };
      window.removeLabelFilter = (idx) => { const f = getFilters(); f.selectedLabels.splice(idx, 1); setFilters(f); populateDatasetLabelPills(); };

      // Column visibility
      function applyColumnVisibility() {
        const toggles = Array.from(document.querySelectorAll('#columns-menu input[data-col]'));
        if (!toggles.length) return;

        const cols = toggles.map((cb) => cb.getAttribute("data-col"));
        const stored = getHiddenCols();
        const hidden = new Set(stored.filter((c) => cols.includes(c)));
        if (hidden.size !== stored.length) setHiddenCols([...hidden]);

        cols.forEach((col) => {
          const isHidden = hidden.has(col);
          document.querySelectorAll(`#results-table [data-col="${col}"]`).forEach((el) => {
            el.classList.toggle('hidden', isHidden);
          });
        });
        toggles.forEach((cb) => {
          cb.checked = !hidden.has(cb.getAttribute("data-col"));
        });
      }

      document.querySelectorAll('#columns-menu input[data-col]').forEach((cb) => {
        cb.addEventListener("change", (e) => {
          const col = e.target.getAttribute("data-col");
          const hidden = new Set(getHiddenCols());
          if (e.target.checked) hidden.delete(col);
          else hidden.add(col);
          setHiddenCols([...hidden]);
          applyColumnVisibility();
        });
      });

      // Reset buttons
      document.getElementById("reset-columns")?.addEventListener("click", () => {
        setHiddenCols(DEFAULT_HIDDEN_COLS);
        applyColumnVisibility();
      });
      document.getElementById("reset-sorting")?.addEventListener("click", () => {
        setSortState([]);
        const table = document.getElementById("results-table");
        if (table) applySortState(table);
      });
      document.getElementById("reset-widths")?.addEventListener("click", () => {
        setColWidths({});
        document.querySelectorAll('#results-table thead th[data-col]').forEach((th) => {
          th.style.width = '';
        });
      });

      // Clear filters
      document.getElementById('clear-filters')?.addEventListener('click', () => {
        setFilters(defaultFilters());
        populateDatasetLabelPills();
      });

      // Filter wiring
      (function wireFilters() {
        const keySelect = document.getElementById('key-select');
        const addFv = document.getElementById('add-fv');
        const fvOp = document.getElementById('fv-op');
        const fvVal = document.getElementById('fv-val');
        const addFp = document.getElementById('add-fp');
        const fpVal = document.getElementById('fp-val');
        const faVal = document.getElementById('fa-val');

        if (addFv) addFv.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          const v = parseFloat(fvVal.value);
          if (!k || Number.isNaN(v)) return;
          const f = getFilters();
          f.valueRules.push({ key: k, op: fvOp.value, value: v });
          setFilters(f);
          fvVal.value = '';
        });

        if (addFp) addFp.addEventListener('click', () => {
          const k = (keySelect?.value || '').trim();
          if (!k) return;
          const f = getFilters();
          f.passedRules.push({ key: k, value: fpVal.value === 'true' });
          setFilters(f);
        });

        if (faVal) faVal.addEventListener('change', () => {
          const f = getFilters();
          f.annotation = faVal.value;
          setFilters(f);
        });

        renderActiveFilters();
      })();

      // Score keys for filter dropdown
      function computeScoreKeys() {
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return { all: [], meta: {} };
        const keys = new Set();
        const meta = {};
        tbody.querySelectorAll("tr[data-row='main']").forEach(tr => {
          let scores = [];
          try { scores = JSON.parse(tr.getAttribute('data-scores') || '[]') || []; } catch {}
          (scores || []).forEach(s => {
            const k = s && s.key; if (!k) return;
            keys.add(k);
            const m = meta[k] || (meta[k] = { hasNumeric: false, hasPassed: false });
            if (!Number.isNaN(parseFloat(s.value))) m.hasNumeric = true;
            if (s.passed === true || s.passed === false) m.hasPassed = true;
          });
        });
        return { all: Array.from(keys).sort(), meta };
      }

      function populateScoreKeySelects() {
        const ks = computeScoreKeys();
        const sel = document.getElementById('key-select');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        ks.all.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.textContent = k; sel.appendChild(opt); });
        if (current && ks.all.includes(current)) sel.value = current; else if (ks.all.length) sel.value = ks.all[0];
        updateFilterSectionsVisibility();
      }

      function updateFilterSectionsVisibility() {
        const sel = document.getElementById('key-select');
        const ks = computeScoreKeys();
        const k = sel?.value || '';
        const m = ks.meta[k] || { hasNumeric: false, hasPassed: false };
        document.getElementById('value-section')?.classList.toggle('hidden', !m.hasNumeric);
        document.getElementById('passed-section')?.classList.toggle('hidden', !m.hasPassed);
      }

      document.getElementById('key-select')?.addEventListener('change', updateFilterSectionsVisibility);

      // Dataset/Label filters
      function computeDatasetLabels() {
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return { datasets: [], labels: [] };
        const datasets = new Set();
        const labels = new Set();
        tbody.querySelectorAll("tr[data-row='main']").forEach(tr => {
          const ds = (tr.getAttribute('data-dataset') || '').trim();
          if (ds) datasets.add(ds);
          try {
            const lbls = JSON.parse(tr.getAttribute('data-labels') || '[]') || [];
            lbls.forEach(l => labels.add(l));
          } catch {}
        });
        return { datasets: Array.from(datasets).sort(), labels: Array.from(labels).sort() };
      }

      function populateDatasetLabelPills() {
        const { datasets, labels } = computeDatasetLabels();
        const f = getFilters();
        const dsCt = document.getElementById('dataset-pills');
        const laCt = document.getElementById('label-pills');
        if (dsCt) {
          dsCt.innerHTML = '';
          if (datasets.length === 0) {
            dsCt.innerHTML = '<span class="text-xs text-zinc-400 italic">No datasets</span>';
          } else {
            datasets.forEach(ds => {
              const isSelected = f.selectedDatasets?.includes(ds);
              const pill = document.createElement('button');
              pill.className = `rounded-full px-3 py-1 text-xs font-medium transition ${isSelected ? 'bg-blue-500 text-white' : 'bg-zinc-100 text-zinc-600 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700'}`;
              pill.textContent = ds;
              pill.onclick = (e) => { e.stopPropagation(); toggleDatasetFilter(ds); };
              dsCt.appendChild(pill);
            });
          }
        }
        if (laCt) {
          laCt.innerHTML = '';
          if (labels.length === 0) {
            laCt.innerHTML = '<span class="text-xs text-zinc-400 italic">No labels</span>';
          } else {
            labels.forEach(la => {
              const isSelected = f.selectedLabels?.includes(la);
              const pill = document.createElement('button');
              pill.className = `rounded-full px-3 py-1 text-xs font-medium transition ${isSelected ? 'bg-blue-500 text-white' : 'bg-zinc-100 text-zinc-600 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700'}`;
              pill.textContent = la;
              pill.onclick = (e) => { e.stopPropagation(); toggleLabelFilter(la); };
              laCt.appendChild(pill);
            });
          }
        }
      }

      function toggleDatasetFilter(ds) {
        const f = getFilters();
        const idx = f.selectedDatasets.indexOf(ds);
        if (idx >= 0) f.selectedDatasets.splice(idx, 1);
        else f.selectedDatasets.push(ds);
        setFilters(f);
        populateDatasetLabelPills();
      }

      function toggleLabelFilter(la) {
        const f = getFilters();
        const idx = f.selectedLabels.indexOf(la);
        if (idx >= 0) f.selectedLabels.splice(idx, 1);
        else f.selectedLabels.push(la);
        setFilters(f);
        populateDatasetLabelPills();
      }

      // Sorting
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: "base" });

      function getCellValue(tr, col) {
        const td = tr.querySelector(`td[data-col="${col}"]`);
        if (!td) return "";
        const dv = td.getAttribute("data-value");
        return dv !== null ? dv : td.textContent.trim();
      }

      function parseValue(value, type) {
        if (type === "number") {
          const num = parseFloat(value);
          return isNaN(num) ? Number.POSITIVE_INFINITY : num;
        }
        return value;
      }

      function compareValues(a, b, type) {
        if (type === "number") return a - b;
        return collator.compare(a, b);
      }

      function applySortState(table) {
        const state = getSortState();
        const headers = table.querySelectorAll("thead th[data-col]");
        headers.forEach((th) => th.setAttribute("aria-sort", "none"));
        const tbody = table.querySelector("tbody");
        const mainRows = Array.from(tbody.querySelectorAll("tr[data-row='main']"));

        mainRows.forEach((tr, i) => {
          if (!tr.hasAttribute("data-orig-index")) tr.setAttribute("data-orig-index", String(i));
        });

        if (!state.length) {
          mainRows.slice().sort((a, b) =>
            Number(a.getAttribute("data-orig-index")) - Number(b.getAttribute("data-orig-index"))
          ).forEach((tr) => {
            const id = tr.getAttribute('data-row-id');
            const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
            tbody.appendChild(tr);
            if (detail) tbody.appendChild(detail);
          });
          return;
        }

        state.forEach((s) => {
          const th = table.querySelector(`thead th[data-col="${s.col}"]`);
          if (th) th.setAttribute("aria-sort", s.dir === "asc" ? "ascending" : "descending");
        });

        mainRows.slice().sort((ra, rb) => {
          for (const s of state) {
            const type = s.type || "string";
            const va = parseValue(getCellValue(ra, s.col), type);
            const vb = parseValue(getCellValue(rb, s.col), type);
            const cmp = compareValues(va, vb, type);
            if (cmp !== 0) return s.dir === "asc" ? cmp : -cmp;
          }
          return Number(ra.getAttribute("data-orig-index")) - Number(rb.getAttribute("data-orig-index"));
        }).forEach((tr) => {
          const id = tr.getAttribute('data-row-id');
          const detail = tbody.querySelector(`tr[data-row='detail'][data-row-id='${id}']`);
          tbody.appendChild(tr);
          if (detail) tbody.appendChild(detail);
        });
      }

      function toggleSort(table, col, type, multi) {
        let state = getSortState();
        const idx = state.findIndex((s) => s.col === col);
        if (multi) {
          if (idx === -1) state.push({ col, dir: "asc", type });
          else if (state[idx].dir === "asc") state[idx].dir = "desc";
          else state.splice(idx, 1);
        } else {
          if (idx === 0 && state[0].dir === "asc") state = [{ col, dir: "desc", type }];
          else if (idx === 0 && state[0].dir === "desc") state = [];
          else state = [{ col, dir: "asc", type }];
        }
        setSortState(state);
        applySortState(table);
      }

      document.addEventListener("click", function (e) {
        const th = e.target.closest("#results thead th[data-col]");
        if (!th) return;
        const table = document.getElementById("results-table");
        if (!table) return;
        const col = th.getAttribute("data-col");
        const type = th.getAttribute("data-type") || "string";
        toggleSort(table, col, type, e.shiftKey);
      });

      // Column widths - only set on th elements, table-layout:fixed handles the rest
      function applyColumnWidths(table) {
        if (!table) return;
        const widths = getColWidths();
        Object.keys(widths).forEach((col) => {
          const w = widths[col];
          if (!w) return;
          const th = table.querySelector(`thead th[data-col="${col}"]`);
          if (th) th.style.width = `${w}px`;
        });
      }

      function initResizableColumns(table) {
        if (!table) return;
        const widths = getColWidths();
        const ths = table.querySelectorAll('thead th[data-col]');
        ths.forEach((th) => {
          if (getComputedStyle(th).position === 'static') th.style.position = 'relative';
          if (th.querySelector('.col-resizer')) return;

          const handle = document.createElement('div');
          handle.className = 'col-resizer';
          th.appendChild(handle);

          let startX = 0, startWidth = 0;
          const colKey = th.getAttribute('data-col');
          const minWidth = 50, maxWidth = 500;

          function onMouseMove(e) {
            const dx = e.clientX - startX;
            let newW = Math.max(minWidth, Math.min(maxWidth, startWidth + dx));
            th.style.width = `${newW}px`;
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            document.body.classList.remove('twevals-col-resize');
            const map = getColWidths();
            map[colKey] = Math.round(th.getBoundingClientRect().width);
            setColWidths(map);
          }

          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            startX = e.clientX;
            startWidth = th.getBoundingClientRect().width;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.body.classList.add('twevals-col-resize');
          });

          handle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); });

          const saved = widths[colKey];
          if (saved) {
            th.style.width = `${saved}px`;
          }
        });
      }

      // Search & filtering
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        let timer;
        searchInput.addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(() => {
            sessionStorage.setItem('twevals:search', searchInput.value);
            applyAllFilters();
          }, 120);
        });
      }

      function compare(op, a, b) {
        if (op === '>') return a > b;
        if (op === '>=') return a >= b;
        if (op === '<') return a < b;
        if (op === '<=') return a <= b;
        if (op === '==') return a === b;
        if (op === '!=') return a !== b;
        return false;
      }

      function rowMatchesFilters(mainTr) {
        const f = getFilters();
        if (f.annotation && f.annotation !== 'any') {
          const ann = (mainTr?.getAttribute('data-annotation') || '').trim();
          const has = !!ann;
          if (f.annotation === 'yes' && !has) return false;
          if (f.annotation === 'no' && has) return false;
        }
        // Dataset filter
        if (f.selectedDatasets && f.selectedDatasets.length > 0) {
          const ds = (mainTr?.getAttribute('data-dataset') || '').trim();
          if (!f.selectedDatasets.includes(ds)) return false;
        }
        // Labels filter (row must have at least one of the selected labels)
        if (f.selectedLabels && f.selectedLabels.length > 0) {
          let rowLabels = [];
          try { rowLabels = JSON.parse(mainTr?.getAttribute('data-labels') || '[]') || []; } catch {}
          const hasMatch = f.selectedLabels.some(l => rowLabels.includes(l));
          if (!hasMatch) return false;
        }
        let scores = [];
        try { scores = JSON.parse(mainTr?.getAttribute('data-scores') || '[]') || []; } catch {}
        for (const vr of (f.valueRules || [])) {
          const s = scores.find(x => x && x.key === vr.key);
          if (!s) return false;
          const val = parseFloat(s.value);
          if (Number.isNaN(val)) return false;
          if (!compare(vr.op, val, vr.value)) return false;
        }
        for (const pr of (f.passedRules || [])) {
          const s = scores.find(x => x && x.key === pr.key);
          if (!s) return false;
          if ((s.passed === true) !== (pr.value === true)) return false;
        }
        return true;
      }

      function applyAllFilters() {
        const q = (document.getElementById('search-input')?.value || '').toLowerCase().trim();
        const tbody = document.querySelector('#results-table tbody');
        if (!tbody) return;
        const mains = tbody.querySelectorAll("tr[data-row='main']");
        mains.forEach((tr) => {
          let show = true;
          if (q) {
            const text = tr.textContent.toLowerCase();
            if (!text.includes(q)) show = false;
          }
          if (show) show = rowMatchesFilters(tr);
          tr.classList.toggle('hidden', !show);
        });
        updateFilteredSummary();
      }

      function updateFilteredSummary() {
        const container = document.getElementById('filtered-summary');
        const table = document.getElementById('results-table');
        if (!container || !table) return;
        const tbody = table.querySelector('tbody');
        const mains = Array.from(tbody.querySelectorAll("tr[data-row='main']"));
        const visible = mains.filter(tr => !tr.classList.contains('hidden'));
        const hasActive = (() => {
          const f = getFilters();
          return (f.valueRules.length + f.passedRules.length + (f.selectedDatasets?.length || 0) + (f.selectedLabels?.length || 0) + (f.annotation !== 'any' ? 1 : 0)) > 0 ||
            (document.getElementById('search-input')?.value || '').trim().length > 0;
        })();
        container.classList.toggle('hidden', !hasActive);
        if (!hasActive) return;
        document.getElementById('filtered-count-chip').textContent = `Filtered: ${visible.length}/${mains.length}`;

        let sum = 0, cnt = 0;
        visible.forEach(tr => {
          const td = tr.querySelector("td[data-col='latency']");
          const v = parseFloat(td?.getAttribute('data-value') || '');
          if (!Number.isNaN(v)) { sum += v; cnt += 1; }
        });
        const avgEl = document.getElementById('filtered-avg-latency');
        if (avgEl) avgEl.textContent = cnt > 0 ? `Avg: ${(sum / cnt).toFixed(2)}s` : 'Avg: —';

        const chipsEl = document.getElementById('filtered-score-chips');
        if (chipsEl) chipsEl.innerHTML = '';
        const map = {};
        visible.forEach(tr => {
          let scores = [];
          try { scores = JSON.parse(tr.getAttribute('data-scores') || '[]') || []; } catch {}
          scores.forEach(s => {
            const key = s?.key; if (!key) return;
            const d = map[key] || (map[key] = { passed: 0, failed: 0, bool: 0, sum: 0, count: 0 });
            if (s.passed === true) { d.passed++; d.bool++; }
            else if (s.passed === false) { d.failed++; d.bool++; }
            const val = parseFloat(s.value);
            if (!Number.isNaN(val)) { d.sum += val; d.count += 1; }
          });
        });
        Object.entries(map).forEach(([k, d]) => {
          const el = document.createElement('span');
          el.className = 'inline-flex items-center gap-2 rounded-full border border-zinc-800 bg-neutral-900 px-3 py-1 text-xs font-semibold text-zinc-200';
          if (d.bool > 0) {
            const total = d.passed + d.failed;
            if (d.passed === total) el.classList.add('border-emerald-500/40', 'bg-emerald-500/10', 'text-emerald-200');
            else if (d.passed === 0) el.classList.add('border-rose-500/40', 'bg-rose-500/10', 'text-rose-200');
            else el.classList.add('border-blue-500/40', 'bg-blue-500/10', 'text-blue-200');
            el.textContent = `${k}: ${d.passed}/${total}`;
          } else if (d.count > 0) {
            el.textContent = `${k}: ${(d.sum / d.count).toFixed(2)}`;
          } else return;
          chipsEl?.appendChild(el);
        });
      }

      // Scroll restoration for returning from detail page
      function initScrollRestoration() {
        const savedY = sessionStorage.getItem('twevals:scrollY');
        if (savedY !== null) {
          window.scrollTo(0, parseInt(savedY, 10));
          sessionStorage.removeItem('twevals:scrollY');
        }
        // Clean up any scroll param from URL
        const params = new URLSearchParams(window.location.search);
        if (params.has('scroll')) {
          history.replaceState(null, '', window.location.pathname);
        }
      }

      // Save scroll position before navigating to detail page
      document.addEventListener('click', (e) => {
        const link = e.target.closest('a[href*="/runs/"][href*="/results/"]');
        if (link) {
          sessionStorage.setItem('twevals:scrollY', window.scrollY.toString());
        }
      });

      // Actions menu
      function wireActionsMenu() {
        const table = document.getElementById('results-table');
        const runId = table ? (table.getAttribute('data-run-id') || 'latest') : 'latest';
        const menu = document.getElementById('actions-menu');
        if (!menu) return;

        menu.querySelectorAll('[data-action]').forEach((el) => {
          el.onclick = async (e) => {
            const act = e.currentTarget.getAttribute('data-action');
            menu.classList.remove('active');
            if (act === 'export-json') {
              window.location.href = `/api/runs/${runId}/export/json`;
            } else if (act === 'export-csv') {
              window.location.href = `/api/runs/${runId}/export/csv`;
            }
          };
        });
      }

      // Loading state
      function showLoading(evt) {
        const silent = evt?.detail?.requestConfig?.headers?.['X-Silent-Refresh'];
        if (silent) return;
        document.getElementById('loading-indicator')?.classList.add('active');
      }
      function hideLoading(evt) {
        const silent = evt?.detail?.requestConfig?.headers?.['X-Silent-Refresh'];
        if (silent) return;
        document.getElementById('loading-indicator')?.classList.remove('active');
      }
      document.body.addEventListener('htmx:beforeRequest', showLoading);
      document.body.addEventListener('htmx:afterSwap', hideLoading);
      document.body.addEventListener('htmx:responseError', hideLoading);

      // Copy to clipboard
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.copy-btn');
        if (!btn) return;
        const id = btn.getAttribute('data-copy');
        const pre = document.getElementById(id);
        if (!pre) return;
        try {
          await navigator.clipboard.writeText(pre.innerText);
          const copyIcon = btn.querySelector('.copy-icon');
          const checkIcon = btn.querySelector('.check-icon');
          if (copyIcon && checkIcon) {
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');
            setTimeout(() => { copyIcon.classList.remove('hidden'); checkIcon.classList.add('hidden'); }, 900);
          }
        } catch {
          alert('Copy failed');
        }
      });

      // Play/Stop button - rerun selected or all, or stop if running
      document.getElementById('play-btn')?.addEventListener('click', async () => {
        if (_isRunning) {
          // Stop running evals
          try {
            await fetch('/api/runs/stop', { method: 'POST' });
          } catch (e) {
            console.error('Stop failed:', e);
          }
          htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
          return;
        }
        let started = false;
        try {
          showLoading();
          const body = selectedIndices.size > 0 ? { indices: Array.from(selectedIndices) } : {};
          const resp = await fetch('/api/runs/rerun', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          if (!resp.ok) {
            let msg = '';
            try {
              const data = await resp.json();
              msg = data?.detail || data?.message || '';
            } catch {
              msg = await resp.text();
            }
            throw new Error(msg || `HTTP ${resp.status}`);
          }
          started = true;
          setRunningState(true);
          htmx.ajax('GET', '/results', { target: '#results', swap: 'innerHTML' });
        } catch (e) {
          alert('Rerun failed: ' + e);
        } finally {
          if (!started) hideLoading();
        }
      });

      // Select-all checkbox
      let lastCheckedIdx = null;
      let pendingShiftClick = null; // Track shift-click for the change handler

      // Capture shift state on click (before change event)
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('row-checkbox') && e.shiftKey && lastCheckedIdx !== null) {
          pendingShiftClick = { idx: parseInt(e.target.dataset.rowId), checked: !e.target.checked };
        }
      }, true); // Use capture phase to run before change

      document.addEventListener('change', (e) => {
        if (e.target.id === 'select-all-checkbox') {
          const visibleRows = getVisibleMainRows();
          visibleRows.forEach(row => {
            const idx = parseInt(row.dataset.rowId);
            const cb = row.querySelector('.row-checkbox');
            if (e.target.checked) {
              selectedIndices.add(idx);
              if (cb) cb.checked = true;
            } else {
              selectedIndices.delete(idx);
              if (cb) cb.checked = false;
            }
          });
          updateSelectionUI();
        }
        // Individual row checkbox
        if (e.target.classList.contains('row-checkbox')) {
          const idx = parseInt(e.target.dataset.rowId);
          const shouldCheck = e.target.checked;

          // Handle shift-click range selection
          if (pendingShiftClick && pendingShiftClick.idx === idx) {
            const visibleRows = getVisibleMainRows();
            const visibleIndices = visibleRows.map(r => parseInt(r.dataset.rowId));
            const lastPos = visibleIndices.indexOf(lastCheckedIdx);
            const currentPos = visibleIndices.indexOf(idx);
            if (lastPos !== -1 && currentPos !== -1) {
              const start = Math.min(lastPos, currentPos);
              const end = Math.max(lastPos, currentPos);
              for (let i = start; i <= end; i++) {
                const rowIdx = visibleIndices[i];
                const row = visibleRows[i];
                const cb = row.querySelector('.row-checkbox');
                if (shouldCheck) {
                  selectedIndices.add(rowIdx);
                  if (cb) cb.checked = true;
                } else {
                  selectedIndices.delete(rowIdx);
                  if (cb) cb.checked = false;
                }
              }
            }
            pendingShiftClick = null;
          } else {
            if (shouldCheck) {
              selectedIndices.add(idx);
            } else {
              selectedIndices.delete(idx);
            }
          }
          lastCheckedIdx = idx;
          updateSelectionUI();
        }
      });

      // Lightweight live refresh when runs are still pending
      let liveUpdateTimer = null;
      function scheduleLiveRefresh() {
        if (liveUpdateTimer) {
          clearTimeout(liveUpdateTimer);
          liveUpdateTimer = null;
        }
        const hasPending = document.querySelector('[data-status="pending"], [data-status="running"]');
        if (!hasPending) return;
        liveUpdateTimer = setTimeout(() => {
          htmx.ajax('GET', '/results', {
            target: '#results',
            swap: 'innerHTML',
            headers: { 'X-Silent-Refresh': '1' },
          });
        }, 1200);
      }

      // Settings modal
      (function wireSettingsModal() {
        const modal = document.getElementById('settings-modal');
        const toggle = document.getElementById('settings-toggle');
        const close = document.getElementById('settings-close');
        const cancel = document.getElementById('settings-cancel');
        const backdrop = document.getElementById('settings-backdrop');
        const form = document.getElementById('settings-form');

        function openModal() {
          modal?.classList.remove('hidden');
          loadConfig();
        }

        function closeModal() {
          modal?.classList.add('hidden');
        }

        async function loadConfig() {
          try {
            const resp = await fetch('/api/config');
            const config = await resp.json();
            form.querySelector('[name="concurrency"]').value = config.concurrency ?? '';
            form.querySelector('[name="results_dir"]').value = config.results_dir ?? '';
            form.querySelector('[name="timeout"]').value = config.timeout ?? '';
          } catch (e) {
            console.error('Failed to load config:', e);
          }
        }

        async function saveConfig(e) {
          e.preventDefault();
          const data = {};
          const concurrency = parseInt(form.querySelector('[name="concurrency"]').value);
          if (!isNaN(concurrency)) data.concurrency = concurrency;
          const results_dir = form.querySelector('[name="results_dir"]').value.trim();
          if (results_dir) data.results_dir = results_dir;
          const timeout = parseFloat(form.querySelector('[name="timeout"]').value);
          if (!isNaN(timeout)) data.timeout = timeout;
          try {
            const resp = await fetch('/api/config', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (!resp.ok) throw new Error('Save failed');
            closeModal();
          } catch (e) {
            alert('Failed to save settings: ' + e.message);
          }
        }

        toggle?.addEventListener('click', openModal);
        close?.addEventListener('click', closeModal);
        cancel?.addEventListener('click', closeModal);
        backdrop?.addEventListener('click', closeModal);
        form?.addEventListener('submit', saveConfig);
      })();

      // Restore filters and search from sessionStorage
      function restoreFiltersAndSearch() {
        const savedFilters = sessionStorage.getItem('twevals:filters');
        if (savedFilters) {
          try {
            _filters = JSON.parse(savedFilters);
          } catch {}
        }
        const savedSearch = sessionStorage.getItem('twevals:search');
        const searchEl = document.getElementById('search-input');
        if (savedSearch && searchEl) {
          searchEl.value = savedSearch;
        }
      }

      // HTMX after swap handler
      document.addEventListener("htmx:afterSwap", function (e) {
        if (e.target.id === "results") {
          const table = document.getElementById("results-table");
          if (table) {
            applySortState(table);
            applyColumnWidths(table);
            initResizableColumns(table);
          }
          applyColumnVisibility();
          initScrollRestoration();
          wireActionsMenu();
          restoreFiltersAndSearch();
          try { populateScoreKeySelects(); populateDatasetLabelPills(); renderActiveFilters(); applyAllFilters(); } catch {}
          syncCheckboxesToSelection();
          checkRunningState();
          scheduleLiveRefresh();
        }
      });
    </script>
  </body>
</html>
