<div class="overflow-x-auto">
<table id="results-table" class="w-full table-fixed divide-y divide-gray-200 shadow ring-1 ring-black ring-opacity-5 rounded-lg" data-run-id="{{ run_id }}">
  <thead>
    <tr class="bg-gray-50">
      <th class="w-10 px-2 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider select-none"> </th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="function">Function</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="dataset">Dataset</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="labels">Labels</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="input">Input</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="output">Output</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="error">Error</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="status" data-type="number">Pass</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="latency" data-type="number">Latency</th>
    </tr>
  </thead>
  <tbody class="bg-white divide-y divide-gray-100">
    {% for r in summary.results %}
    {% set row_id = loop.index0 %}
    <tr class="odd:bg-white even:bg-gray-50 hover:bg-blue-50" data-row="main" data-row-id="{{ row_id }}">
      <td class="px-2 py-2">
        <button class="expand-btn inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 text-gray-600" data-row-id="{{ row_id }}" aria-expanded="false" aria-label="Expand row">
          <span class="icon">▸</span>
        </button>
      </td>
      <td class="px-4 py-2 text-sm font-mono text-sky-700 truncate" data-col="function">{{ r.function }}</td>
      <td class="px-4 py-2 text-sm text-gray-700 truncate" data-col="dataset">{{ r.dataset }}</td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="labels">
        {% if r.labels %}
          {% for la in r.labels %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs mr-1">{{ la }}</span>
          {% endfor %}
        {% endif %}
      </td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="input">{{ r.result.input }}</td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="output">{{ r.result.output }}</td>
      <td class="px-4 py-2 text-sm truncate" data-col="error">
        {% if r.result.error %}
          <span class="text-red-600">{{ r.result.error }}</span>
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
      {# Pass/Fail derived from scores #}
      {% set ns = namespace(passed=None) %}
      {% if r.result.scores %}
        {% for s in r.result.scores %}
          {% if s.passed is true %}
            {% set ns.passed = true %}
          {% elif s.passed is false and ns.passed is not true %}
            {% set ns.passed = false %}
          {% endif %}
        {% endfor %}
      {% endif %}
      <td class="px-4 py-2 text-sm" data-col="status" data-value="{% if ns.passed is true %}1{% elif ns.passed is false %}0{% endif %}">
        {% if ns.passed is true %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-100 text-green-800">Pass</span>
        {% elif ns.passed is false %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-800">Fail</span>
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
      <td class="px-4 py-2 text-sm whitespace-nowrap" data-col="latency" data-value="{% if r.result.latency is not none %}{{ r.result.latency }}{% endif %}">
        {% if r.result.latency is not none %}
          {% set latency = r.result.latency %}
          {% set label = latency | round(2) %}
          {% if latency <= 0.5 %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-100 text-green-800">{{ label }}s</span>
          {% elif latency <= 1.5 %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">{{ label }}s</span>
          {% else %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-800">{{ label }}s</span>
          {% endif %}
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
    </tr>
    <tr class="bg-gray-50" data-row="detail" data-row-id="{{ row_id }}" hidden
        data-original-dataset='{{ r.dataset | e }}'
        data-original-labels='{{ (r.labels or []) | tojson | e }}'
        data-original-metadata='{{ (r.result.metadata or none) | tojson | e }}'
        data-original-scores='{{ (r.result.scores or []) | tojson | e }}'>
      <td colspan="9" class="px-6 py-4">
        <div class="border rounded-md p-4 bg-white shadow-sm">
          <div class="flex justify-between items-center mb-3">
            <div class="text-sm text-gray-600">Row {{ row_id + 1 }}</div>
            <div class="flex gap-2">
              <button class="edit-btn px-3 py-1 text-sm border rounded" data-row-id="{{ row_id }}">Edit</button>
              <button class="save-btn px-3 py-1 text-sm border rounded bg-green-600 text-white hidden" data-row-id="{{ row_id }}">Save</button>
              <button class="cancel-btn px-3 py-1 text-sm border rounded hidden" data-row-id="{{ row_id }}">Cancel</button>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-2 text-sm text-gray-700 mb-4 items-start">
            <div class="view-section"><span class="font-semibold">Function:</span> <span class="font-mono text-sky-700">{{ r.function }}</span></div>
            <div class="view-section"><span class="font-semibold">Dataset:</span> <span class="dataset-view">{{ r.dataset }}</span></div>
            <div class="view-section"><span class="font-semibold">Labels:</span>
              {% if r.labels %}
                {% for la in r.labels %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs mr-1">{{ la }}</span>
                {% endfor %}
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </div>
            <div class="view-section"><span class="font-semibold">Latency:</span> {% if r.result.latency is not none %}{{ r.result.latency | round(3) }}s{% else %}<span class="text-gray-400">—</span>{% endif %}</div>
            <div class="view-section"><span class="font-semibold">Error:</span> {% if r.result.error %}<span class="text-red-600">{{ r.result.error }}</span>{% else %}<span class="text-gray-400">—</span>{% endif %}</div>

            <!-- Edit fields -->
            <div class="edit-section hidden">
              <label class="block text-xs font-semibold text-gray-500 mb-1">Dataset</label>
              <input id="dataset-input-{{ row_id }}" type="text" class="w-full border rounded px-2 py-1" value="{{ r.dataset }}" />
            </div>
            <div class="edit-section hidden">
              <label class="block text-xs font-semibold text-gray-500 mb-1">Labels (comma-separated)</label>
              <input id="labels-input-{{ row_id }}" type="text" class="w-full border rounded px-2 py-1" value="{% if r.labels %}{{ r.labels | join(', ') }}{% endif %}" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="view-section">
              <div class="text-xs font-semibold text-gray-500 mb-1">Input</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.input }}</pre>
            </div>
            <div class="view-section">
              <div class="text-xs font-semibold text-gray-500 mb-1">Output</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.output }}</pre>
            </div>
            <div class="view-section">
              <div class="text-xs font-semibold text-gray-500 mb-1">Reference</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.reference }}</pre>
            </div>
            <div class="view-section">
              <div class="text-xs font-semibold text-gray-500 mb-1">Metadata</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.metadata }}</pre>
            </div>
            <div class="edit-section hidden md:col-span-2">
              <label class="block text-xs font-semibold text-gray-500 mb-1">Metadata (JSON)</label>
              <textarea id="metadata-input-{{ row_id }}" class="w-full border rounded px-2 py-1 font-mono h-28">{% if r.result.metadata %}{{ r.result.metadata | tojson(indent=2) }}{% endif %}</textarea>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs font-semibold text-gray-500 mb-1">Scores</div>
            <div class="view-section">
              {% if r.result.scores %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                  {% for s in r.result.scores %}
                    <div class="border rounded p-2 bg-gray-50">
                      <div class="text-sm"><span class="font-semibold">Key:</span> {{ s.key }}</div>
                      {% if s.value is not none %}
                        <div class="text-sm"><span class="font-semibold">Value:</span> {{ s.value }}</div>
                      {% endif %}
                      {% if s.passed is not none %}
                        <div class="text-sm"><span class="font-semibold">Passed:</span> {{ s.passed }}</div>
                      {% endif %}
                      {% if s.notes %}
                        <div class="text-sm"><span class="font-semibold">Notes:</span> {{ s.notes }}</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-gray-400">No scores</div>
              {% endif %}
            </div>

            <div class="edit-section hidden">
              {% set scores = r.result.scores or [] %}
              <div class="space-y-2" id="scores-editor-{{ row_id }}">
                {% for s in scores %}
                <div class="border rounded p-2 bg-gray-50">
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">Key</label>
                      <input type="text" class="w-full border rounded px-2 py-1" name="score-key" value="{{ s.key }}" />
                    </div>
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">Value</label>
                      <input type="number" step="any" class="w-full border rounded px-2 py-1" name="score-value" value="{% if s.value is not none %}{{ s.value }}{% endif %}" />
                    </div>
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">Passed</label>
                      <select class="w-full border rounded px-2 py-1" name="score-passed">
                        <option value="">—</option>
                        <option value="true" {% if s.passed is true %}selected{% endif %}>True</option>
                        <option value="false" {% if s.passed is false %}selected{% endif %}>False</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-xs text-gray-500 mb-1">Notes</label>
                      <input type="text" class="w-full border rounded px-2 py-1" name="score-notes" value="{% if s.notes %}{{ s.notes }}{% endif %}" />
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
  
</table>
</div>
