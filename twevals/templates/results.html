{% set ns = namespace(tests=summary.total_evaluations, passed=0, failed=0, pending=0, running=0, not_started=0) %}
{% set active_ns = namespace(pending=0, running=0, completed=0, total=0) %}
{% for r in summary.results %}
  {% set idx = loop.index0 %}
  {% set status = r.result.status if r.result and r.result.status is defined else None %}
  {% if status == 'not_started' %}{% set ns.not_started = ns.not_started + 1 %}{% elif status == 'pending' %}{% set ns.pending = ns.pending + 1 %}{% elif status == 'running' %}{% set ns.running = ns.running + 1 %}{% endif %}
  {% set p = namespace(pass=false, fail=false) %}
  {% if r.result and r.result.scores %}
    {% for s in r.result.scores %}
      {% if s.passed is true %}{% set p.pass = true %}{% elif s.passed is false and p.pass is not true %}{% set p.fail = true %}{% endif %}
    {% endfor %}
  {% endif %}
  {% if p.pass %}{% set ns.passed = ns.passed + 1 %}{% elif p.fail %}{% set ns.failed = ns.failed + 1 %}{% endif %}
  {# Track progress for active indices only #}
  {% if active_indices is none or idx in active_indices %}
    {% set active_ns.total = active_ns.total + 1 %}
    {% if status == 'pending' %}{% set active_ns.pending = active_ns.pending + 1 %}{% elif status == 'running' %}{% set active_ns.running = active_ns.running + 1 %}{% elif status not in ['not_started', none] %}{% set active_ns.completed = active_ns.completed + 1 %}{% endif %}
  {% endif %}
{% endfor %}
{% set pending_total = ns.pending + ns.running + ns.not_started %}
{% set total = summary.total_evaluations %}
{% set completed = (total - pending_total) if total else 0 %}
{# Progress bar uses active indices for selective runs #}
{% set progress_total = active_ns.total if active_indices else total %}
{% set progress_completed = active_ns.completed if active_indices else completed %}
{% set progress_pending = (active_ns.pending + active_ns.running) if active_indices else (ns.pending + ns.running) %}
{% set pct_done = ((progress_completed / progress_total) * 100) | round(0) | int if progress_total > 0 else 0 %}

{% set pill_tones = {
  'not_started': 'text-zinc-400 bg-zinc-500/10 border border-zinc-500/40',
  'pending': 'text-blue-300 bg-blue-500/10 border border-blue-500/40',
  'running': 'text-cyan-300 bg-cyan-500/10 border border-cyan-500/40',
  'completed': 'text-emerald-300 bg-emerald-500/10 border border-emerald-500/40',
  'error': 'text-rose-300 bg-rose-500/10 border border-rose-500/40',
  'cancelled': 'text-amber-300 bg-amber-500/10 border border-amber-500/40'
} %}

<!-- Expanded Stats Panel (hidden by default) -->
<div id="stats-expanded" class="stats-expanded hidden">
  <div class="stats-layout">
    <!-- Collapse button positioned in top-right -->
    <button id="stats-collapse-btn" class="stats-collapse-btn" title="Collapse">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
    </button>
    <!-- Left panel: summary info + Y-axis labels -->
    <div class="stats-left">
      <div class="stats-left-content">
        {% if summary.session_name or summary.run_name %}
        <div class="stats-left-header">
          {% if summary.session_name %}
          <div class="stats-info-row">
            <span class="stats-info-label">session</span>
            <span class="stats-session">{{ summary.session_name }}</span>
          </div>
          {% endif %}
          {% if summary.run_name %}
          <div class="stats-info-row">
            <span class="stats-info-label">run</span>
            <span class="stats-run">{{ summary.run_name }}</span>
          </div>
          {% endif %}
        </div>
        {% endif %}
        <div class="stats-metric">
          <span class="stats-metric-value">{{ total }}</span>
          <span class="stats-metric-label">tests</span>
        </div>
        {% if summary.average_latency > 0 %}
        <div class="stats-metric stats-metric-sm">
          <span class="stats-metric-value">{{ summary.average_latency | round(2) }}<span class="stats-metric-unit">s</span></span>
          <span class="stats-metric-label">avg latency</span>
        </div>
        {% endif %}
      </div>
      <!-- Y-axis labels along the right edge -->
      <div class="stats-yaxis">
        <span class="stats-axis-label">100%</span>
        <span class="stats-axis-label">75%</span>
        <span class="stats-axis-label">50%</span>
        <span class="stats-axis-label">25%</span>
        <span class="stats-axis-label">0%</span>
      </div>
    </div>

    <!-- Right panel: chart area (Y-axis is the left border) -->
    <div class="stats-right">
      <!-- Chart area with gridlines -->
      <div class="stats-chart-area">
        <div class="stats-gridline" style="top: 0%"></div>
        <div class="stats-gridline" style="top: 25%"></div>
        <div class="stats-gridline" style="top: 50%"></div>
        <div class="stats-gridline" style="top: 75%"></div>
        <!-- Bars -->
        <div class="stats-chart-bars">
          {% for chip in score_chips %}
            {% if chip.type == 'ratio' %}
              {% set pct = ((chip.passed / chip.total) * 100) | round(0) | int if chip.total > 0 else 0 %}
              {% set bar_color = 'vbar-green' if pct >= 80 else ('vbar-amber' if pct >= 50 else 'vbar-red') %}
              <div class="stats-bar-col">
                <div class="stats-chart-fill {{ bar_color }}" style="height: {{ pct }}%"></div>
              </div>
            {% elif chip.type == 'avg' %}
              {% set avg = chip.avg %}
              {% set pct = (avg * 100) | round(0) | int if avg <= 1 else ((avg * 10) | round(0) | int if avg <= 10 else ([avg, 100] | min | round(0) | int)) %}
              {% set bar_color = 'vbar-green' if pct >= 80 else ('vbar-amber' if pct >= 50 else 'vbar-red') %}
              <div class="stats-bar-col">
                <div class="stats-chart-fill {{ bar_color }}" style="height: {{ pct }}%"></div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <!-- X-axis area (labels and values) -->
      <div class="stats-xaxis">
        <div class="stats-chart-labels">
          {% for chip in score_chips %}
            <span class="stats-chart-label">{{ chip.key }}</span>
          {% endfor %}
        </div>
        <div class="stats-chart-values">
          {% for chip in score_chips %}
            {% if chip.type == 'ratio' %}
              <span class="stats-chart-value">{{ chip.passed }}/{{ chip.total }}</span>
            {% elif chip.type == 'avg' %}
              <span class="stats-chart-value">{{ chip.avg | round(2) }}</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Compact Stats Bar -->
<div id="stats-compact" class="mb-3 flex flex-wrap items-center gap-3 border-b border-theme-border bg-theme-bg-secondary/50 px-4 py-2">
  <!-- Session & Run Info -->
  {% if summary.session_name or summary.run_name %}
  <div class="flex items-center gap-2">
    {% if summary.session_name %}
    <span class="text-[11px] font-medium uppercase tracking-wider text-theme-text-secondary">Session</span>
    <div class="group flex items-center gap-1">
      <span id="session-name-text" class="font-mono text-[11px] text-theme-text">{{ summary.session_name }}</span>
      <button class="copy-btn flex h-4 w-4 items-center justify-center rounded text-zinc-600 opacity-0 transition hover:text-zinc-400 group-hover:opacity-100" data-copy="session-name-text" aria-label="Copy session name">
        <svg class="copy-icon h-2.5 w-2.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        <svg class="check-icon hidden h-2.5 w-2.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
      </button>
    </div>
    {% endif %}
    {% if summary.run_name %}
    <span class="text-zinc-600">·</span>
    <span class="text-[11px] font-medium uppercase tracking-wider text-theme-text-secondary">Run</span>
    <div class="group flex items-center gap-1">
      <span id="run-name-text" class="font-mono text-[11px] text-blue-400">{{ summary.run_name }}</span>
      <button class="copy-btn flex h-4 w-4 items-center justify-center rounded text-zinc-600 opacity-0 transition hover:text-zinc-400 group-hover:opacity-100" data-copy="run-name-text" aria-label="Copy run name">
        <svg class="copy-icon h-2.5 w-2.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
        <svg class="check-icon hidden h-2.5 w-2.5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
      </button>
    </div>
    {% endif %}
  </div>
  <div class="h-3 w-px bg-zinc-700"></div>
  {% endif %}

  <!-- Run Progress / Total Tests -->
  {% if ns.not_started == total %}
    <div class="flex items-center gap-2">
      <span class="text-[11px] font-medium uppercase tracking-wider text-theme-text-secondary">Discovered</span>
      <span class="font-mono text-[11px] text-zinc-400">{{ total }} eval{{ 's' if total != 1 else '' }}</span>
    </div>
  {% elif progress_pending > 0 %}
    <div class="flex items-center gap-2">
      <span class="text-[11px] font-medium uppercase tracking-wider text-theme-text-secondary">Progress</span>
      <div class="h-1 w-6 overflow-hidden rounded-full bg-zinc-800">
        <div class="h-full rounded-full bg-blue-500" style="width: {{ pct_done }}%"></div>
      </div>
      <span class="font-mono text-[11px] text-blue-400">{{ progress_completed }}/{{ progress_total }}</span>
    </div>
  {% else %}
    <div class="flex items-center gap-2">
      <span class="text-[11px] font-medium uppercase tracking-wider text-theme-text-secondary">Tests</span>
      <span class="font-mono text-[11px] text-blue-400">{{ total }}</span>
    </div>
  {% endif %}

  <div class="h-3 w-px bg-zinc-700"></div>

  <!-- Score Metrics with inline micro-bars -->
  {% for chip in score_chips %}
    {% if chip.type == 'ratio' %}
      {% set pct = ((chip.passed / chip.total) * 100) | round(0) | int if chip.total > 0 else 0 %}
      {% set bar_color = 'bg-emerald-500' if pct >= 80 else ('bg-amber-500' if pct >= 50 else 'bg-rose-500') %}
      {% set text_color = 'text-emerald-400' if pct >= 80 else ('text-amber-400' if pct >= 50 else 'text-rose-400') %}
      <div class="flex items-center gap-2">
        <span class="text-[10px] font-medium uppercase tracking-wider text-theme-text-secondary">{{ chip.key }}</span>
        <div class="h-1 w-5 overflow-hidden rounded-full bg-zinc-800">
          <div class="h-full rounded-full {{ bar_color }}" style="width: {{ pct }}%"></div>
        </div>
        <span class="font-mono text-[11px] {{ text_color }}">{{ chip.passed }}/{{ chip.total }}</span>
      </div>
      {% if not loop.last %}<div class="h-3 w-px bg-zinc-700"></div>{% endif %}
    {% elif chip.type == 'avg' %}
      {% set avg = chip.avg %}
      {% set pct = (avg * 100) | round(0) | int if avg <= 1 else ((avg * 10) | round(0) | int if avg <= 10 else ([avg, 100] | min | round(0) | int)) %}
      {% set bar_color = 'bg-emerald-500' if pct >= 80 else ('bg-amber-500' if pct >= 50 else 'bg-rose-500') %}
      {% set text_color = 'text-emerald-400' if pct >= 80 else ('text-amber-400' if pct >= 50 else 'text-rose-400') %}
      <div class="flex items-center gap-2">
        <span class="text-[10px] font-medium uppercase tracking-wider text-theme-text-secondary">{{ chip.key }}</span>
        <div class="h-1 w-5 overflow-hidden rounded-full bg-zinc-800">
          <div class="h-full rounded-full {{ bar_color }}" style="width: {{ pct }}%"></div>
        </div>
        <span class="font-mono text-[11px] {{ text_color }}">{{ avg | round(1) }}</span>
      </div>
      {% if not loop.last %}<div class="h-3 w-px bg-zinc-700"></div>{% endif %}
    {% endif %}
  {% endfor %}

  {% if summary.average_latency > 0 %}
  <div class="h-3 w-px bg-zinc-700"></div>
  <div class="flex items-center gap-2">
    <span class="text-[10px] font-medium uppercase tracking-wider text-theme-text-secondary">Latency</span>
    <span class="font-mono text-[11px] text-zinc-400">{{ summary.average_latency | round(2) }}s</span>
  </div>
  {% endif %}

  <!-- Expand button -->
  <div class="ml-auto">
    <button id="stats-expand-btn" class="stats-toggle-btn" title="Expand stats">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>
</div>

<!-- Filtered summary (computed client-side) -->
<div id="filtered-summary" class="hidden mb-3 border-b border-zinc-800 bg-zinc-900/30 px-4 py-2 text-sm">
  <div class="flex flex-wrap items-center gap-2">
    <span id="filtered-count-chip" class="inline-flex items-center gap-2 rounded bg-theme-bg-elevated px-2 py-0.5 text-[11px] font-medium text-theme-text"></span>
    <span id="filtered-avg-latency" class="inline-flex items-center gap-2 rounded bg-theme-bg-elevated px-2 py-0.5 text-[11px] font-medium text-theme-text"></span>
    <span id="filtered-score-chips" class="flex flex-wrap gap-2"></span>
  </div>
</div>

<!-- Results Table -->
<table id="results-table" data-run-id="{{ run_id }}" class="w-full table-fixed border-collapse text-sm text-theme-text">
  <thead>
    <tr class="border-b border-theme-border">
      <th style="width:32px;" class="sticky top-[41px] z-20 bg-theme-bg px-2 py-2 align-middle">
        <input type="checkbox" id="select-all-checkbox" class="accent-emerald-500" />
      </th>
      <th data-col="function" style="width:15%;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Function</th>
      <th data-col="input" style="width:18%;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Input</th>
      <th data-col="reference" style="width:18%;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Reference</th>
      <th data-col="output" style="width:18%;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Output</th>
      <th data-col="error" style="width:18%;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Error</th>
      <th data-col="scores" style="width:140px;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-left text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Scores</th>
      <th data-col="latency" data-type="number" style="width:70px;" class="sticky top-[41px] z-20 bg-theme-bg px-3 py-2 text-right text-[10px] font-medium uppercase tracking-wider text-theme-text-muted">Time</th>
      <th style="width:28px;" class="sticky top-[41px] z-20 bg-theme-bg px-1 py-2"></th>
    </tr>
  </thead>
  <tbody class="divide-y divide-theme-border-subtle">
    {% for r in summary.results %}
    {% set row_id = loop.index0 %}
    {% set status = r.result.status or 'completed' %}
    {% set is_running = status == 'running' %}
    {% set is_not_started = status == 'not_started' %}
    <tr data-row="main" data-row-id="{{ row_id }}" data-status="{{ status }}" data-scores='{{ r.result.scores | tojson if r.result.scores else "null" }}' data-annotation="{{ r.result.annotation or '' }}" data-dataset="{{ r.dataset or '' }}" data-labels='{{ r.labels | tojson if r.labels else "[]" }}' data-has-url="{{ 'true' if r.result.trace_data and r.result.trace_data.trace_url else 'false' }}" data-has-messages="{{ 'true' if r.result.trace_data and r.result.trace_data.messages else 'false' }}" data-has-error="{{ 'true' if r.result.error else 'false' }}" class="group cursor-pointer hover:bg-theme-bg-elevated/50 transition-colors{% if is_not_started %} opacity-60{% endif %}" onclick="if(!event.target.closest('input,button,a')) this.classList.toggle('expanded')">
      <td class="px-2 py-2 align-middle" onclick="event.stopPropagation()">
        <input type="checkbox" class="row-checkbox" data-row-id="{{ row_id }}" />
      </td>
      <td data-col="function" class="px-3 py-2 align-middle">
        <div class="flex flex-col gap-0.5">
          <div class="flex items-center gap-2">
            {% if is_not_started %}
              <span class="font-mono text-[12px] font-medium text-zinc-500">{{ r.function }}</span>
            {% else %}
              <a href="/runs/{{ run_id }}/results/{{ row_id }}" class="font-mono text-[12px] font-medium text-blue-400 hover:text-blue-300">{{ r.function }}</a>
            {% endif %}
            {% if status == 'running' %}
              <span class="status-pill rounded px-1.5 py-0.5 text-[10px] font-medium {{ pill_tones.get(status) }}">running</span>
            {% elif status == 'error' %}
              <span class="status-pill rounded px-1.5 py-0.5 text-[10px] font-medium {{ pill_tones.get('error') }}">err</span>
            {% endif %}
          </div>
          <div class="flex items-center gap-1.5 text-[10px] text-zinc-500">
            <span>{{ r.dataset }}</span>
            {% if r.labels %}
              <span class="text-zinc-700">·</span>
              {% for la in r.labels %}
                <span class="rounded bg-theme-bg-elevated px-1 py-0.5 text-[9px] text-theme-text-muted">{{ la }}</span>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </td>
      <td data-col="input" title="{{ r.result.input }}" class="px-3 py-2 align-middle">
        <div class="line-clamp-2 text-[12px] text-theme-text">{{ r.result.input }}</div>
      </td>
      <td data-col="reference" title="{{ r.result.reference }}" class="px-3 py-2 align-middle">
        {% if r.result.reference %}
          <div class="line-clamp-2 text-[12px] text-theme-text">{{ r.result.reference }}</div>
        {% else %}
          <span class="text-zinc-600">—</span>
        {% endif %}
      </td>
      <td data-col="output" title="{{ r.result.output }}" class="px-3 py-2 align-middle">
        {% if is_not_started %}
          <span class="text-zinc-600">—</span>
        {% elif is_running %}
          <div class="space-y-1">
            <div class="h-2.5 w-3/4 animate-pulse rounded bg-zinc-800"></div>
            <div class="h-2.5 w-1/2 animate-pulse rounded bg-zinc-800"></div>
          </div>
        {% elif r.result.output %}
          <div class="line-clamp-2 text-[12px] text-theme-text">{{ r.result.output }}</div>
        {% else %}
          <span class="text-zinc-600">—</span>
        {% endif %}
      </td>
      <td data-col="error" title="{{ r.result.error }}" class="px-3 py-2 align-middle">
        {% if r.result.error %}
          <div class="line-clamp-2 text-[12px] text-rose-400">{{ r.result.error }}</div>
        {% else %}
          <span class="text-zinc-600">—</span>
        {% endif %}
      </td>
      <td data-col="scores" class="px-3 py-2 align-middle max-w-[180px]">
        {% if is_not_started %}
          <span class="text-zinc-600">—</span>
        {% elif is_running %}
          <div class="flex gap-1">
            <div class="h-4 w-14 animate-pulse rounded bg-zinc-800"></div>
            <div class="h-4 w-10 animate-pulse rounded bg-zinc-800"></div>
          </div>
        {% elif r.result.scores %}
          <div class="flex gap-1 overflow-hidden">
            {% set max_scores = 2 %}
            {% for s in r.result.scores %}
              {% set badge_class = 'bg-theme-bg-elevated text-theme-text-muted' %}
              {% if s.passed is true %}{% set badge_class = 'bg-emerald-500/15 text-emerald-400' %}
              {% elif s.passed is false %}{% set badge_class = 'bg-rose-500/15 text-rose-400' %}{% endif %}
              <span class="score-badge shrink-0 truncate max-w-[80px] rounded px-1.5 py-0.5 text-[10px] font-medium {{ badge_class }}{% if loop.index0 >= max_scores %} score-extra hidden{% endif %}" title="{{ s.key }}{% if s.value is not none %}: {{ (s.value is number) and (s.value | round(3)) or s.value }}{% endif %}{% if s.notes %} — {{ s.notes }}{% endif %}">
                {% if s.value is not none %}{{ s.key }}:{{ (s.value is number) and (s.value | round(1)) or s.value }}{% else %}{{ s.key }}{% endif %}
              </span>
            {% endfor %}
            {% if r.result.scores | length > max_scores %}
              <span class="score-overflow shrink-0 rounded px-1.5 py-0.5 text-[10px] font-medium text-zinc-500">+{{ r.result.scores | length - max_scores }}</span>
            {% endif %}
          </div>
        {% else %}
          <span class="text-zinc-600">—</span>
        {% endif %}
      </td>
      <td data-col="latency" data-value="{% if r.result.latency is not none %}{{ r.result.latency }}{% endif %}" class="px-3 py-2 align-middle text-right">
        {% if r.result.latency is not none %}
          {% set latency = r.result.latency %}
          <span class="font-mono text-[11px] {% if latency <= 1 %}text-emerald-400{% elif latency <= 5 %}text-zinc-400{% else %}text-rose-400{% endif %}">{{ latency | round(2) }}s</span>
        {% elif is_running %}
          <div class="ml-auto h-3 w-8 animate-pulse rounded bg-zinc-800"></div>
        {% else %}
          <span class="text-zinc-600">—</span>
        {% endif %}
      </td>
      <td class="px-1 py-2 align-middle">
        <span class="expand-chevron text-zinc-700 group-hover:text-zinc-400">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </span>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
