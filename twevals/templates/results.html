<div class="overflow-x-auto">
<table id="results-table" class="w-full table-fixed divide-y divide-gray-200 shadow ring-1 ring-black ring-opacity-5 rounded-lg">
  <thead>
    <tr class="bg-gray-50">
      <th class="w-10 px-2 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider select-none"> </th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="function">Function</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="dataset">Dataset</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="labels">Labels</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="input">Input</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="output">Output</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="error">Error</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="status" data-type="number">Pass</th>
      <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none relative truncate" data-col="latency" data-type="number">Latency</th>
    </tr>
  </thead>
  <tbody class="bg-white divide-y divide-gray-100">
    {% for r in summary.results %}
    {% set row_id = loop.index0 %}
    <tr class="odd:bg-white even:bg-gray-50 hover:bg-blue-50" data-row="main" data-row-id="{{ row_id }}">
      <td class="px-2 py-2">
        <button class="expand-btn inline-flex items-center justify-center w-6 h-6 rounded hover:bg-gray-200 text-gray-600" data-row-id="{{ row_id }}" aria-expanded="false" aria-label="Expand row">
          <span class="icon">▸</span>
        </button>
      </td>
      <td class="px-4 py-2 text-sm font-mono text-sky-700 truncate" data-col="function">{{ r.function }}</td>
      <td class="px-4 py-2 text-sm text-gray-700 truncate" data-col="dataset">{{ r.dataset }}</td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="labels">
        {% if r.labels %}
          {% for la in r.labels %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs mr-1">{{ la }}</span>
          {% endfor %}
        {% endif %}
      </td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="input">{{ r.result.input }}</td>
      <td class="px-4 py-2 text-sm text-gray-800 truncate" data-col="output">{{ r.result.output }}</td>
      <td class="px-4 py-2 text-sm truncate" data-col="error">
        {% if r.result.error %}
          <span class="text-red-600">{{ r.result.error }}</span>
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
      {# Pass/Fail derived from scores #}
      {% set ns = namespace(passed=None) %}
      {% if r.result.scores %}
        {% for s in r.result.scores %}
          {% if s.passed is true %}
            {% set ns.passed = true %}
          {% elif s.passed is false and ns.passed is not true %}
            {% set ns.passed = false %}
          {% endif %}
        {% endfor %}
      {% endif %}
      <td class="px-4 py-2 text-sm" data-col="status" data-value="{% if ns.passed is true %}1{% elif ns.passed is false %}0{% endif %}">
        {% if ns.passed is true %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-100 text-green-800">Pass</span>
        {% elif ns.passed is false %}
          <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-800">Fail</span>
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
      <td class="px-4 py-2 text-sm whitespace-nowrap" data-col="latency" data-value="{% if r.result.latency is not none %}{{ r.result.latency }}{% endif %}">
        {% if r.result.latency is not none %}
          {% set latency = r.result.latency %}
          {% set label = latency | round(2) %}
          {% if latency <= 0.5 %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-100 text-green-800">{{ label }}s</span>
          {% elif latency <= 1.5 %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800">{{ label }}s</span>
          {% else %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-800">{{ label }}s</span>
          {% endif %}
        {% else %}
          <span class="text-gray-400">—</span>
        {% endif %}
      </td>
    </tr>
    <tr class="bg-gray-50" data-row="detail" data-row-id="{{ row_id }}" hidden>
      <td colspan="9" class="px-6 py-4">
        <div class="border rounded-md p-4 bg-white shadow-sm">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-2 text-sm text-gray-700 mb-4 items-center">
            <div><span class="font-semibold">Function:</span> <span class="font-mono text-sky-700">{{ r.function }}</span></div>
            <div><span class="font-semibold">Dataset:</span> {{ r.dataset }}</div>
            <div><span class="font-semibold">Labels:</span>
              {% if r.labels %}
                {% for la in r.labels %}
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-xs mr-1">{{ la }}</span>
                {% endfor %}
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </div>
            <div><span class="font-semibold">Latency:</span> {% if r.result.latency is not none %}{{ r.result.latency | round(3) }}s{% else %}<span class="text-gray-400">—</span>{% endif %}</div>
            <div><span class="font-semibold">Error:</span> {% if r.result.error %}<span class="text-red-600">{{ r.result.error }}</span>{% else %}<span class="text-gray-400">—</span>{% endif %}</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-semibold text-gray-500 mb-1">Input</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.input }}</pre>
            </div>
            <div>
              <div class="text-xs font-semibold text-gray-500 mb-1">Output</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.output }}</pre>
            </div>
            <div>
              <div class="text-xs font-semibold text-gray-500 mb-1">Reference</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.reference }}</pre>
            </div>
            <div>
              <div class="text-xs font-semibold text-gray-500 mb-1">Metadata</div>
              <pre class="p-2 bg-gray-100 rounded overflow-auto max-h-64 whitespace-pre-wrap">{{ r.result.metadata }}</pre>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs font-semibold text-gray-500 mb-1">Scores</div>
            {% if r.result.scores %}
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                {% for s in r.result.scores %}
                  <div class="border rounded p-2 bg-gray-50">
                    <div class="text-sm"><span class="font-semibold">Key:</span> {{ s.key }}</div>
                    {% if s.value is not none %}
                      <div class="text-sm"><span class="font-semibold">Value:</span> {{ s.value }}</div>
                    {% endif %}
                    {% if s.passed is not none %}
                      <div class="text-sm"><span class="font-semibold">Passed:</span> {{ s.passed }}</div>
                    {% endif %}
                    {% if s.notes %}
                      <div class="text-sm"><span class="font-semibold">Notes:</span> {{ s.notes }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="text-gray-400">No scores</div>
            {% endif %}
          </div>
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
  
</table>
</div>
